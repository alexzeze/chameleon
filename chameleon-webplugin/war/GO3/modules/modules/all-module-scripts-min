GO.modules.MainPanel=function(A){if(!A){A={}}this.installedModulesDS=new GO.data.JsonStore({url:GO.settings.modules.modules.url+"json.php",baseParams:{task:"installed_modules"},root:"results",id:"id",fields:["name","description","id","sort_order","admin_menu","acl_read","acl_write"],remoteSort:true});this.availableModulesDS=new GO.data.JsonStore({url:GO.settings.modules.modules.url+"json.php",baseParams:{task:"available_modules"},root:"results",id:"id",fields:["name","description","id","sort_order","admin_menu","acl_read","acl_write"],remoteSort:true});A.tbar=new Ext.Toolbar({cls:"go-head-tb",items:[{iconCls:"btn-add",text:GO.modules.lang.cmdInstall,cls:"x-btn-text-icon",handler:this.showavailableModules,scope:this},{iconCls:"btn-delete",text:GO.modules.lang.cmdUninstall,cls:"x-btn-text-icon",handler:this.uninstallModule,scope:this},{iconCls:"btn-permissions",text:GO.lang.strPermissions,cls:"x-btn-text-icon",handler:this.showPermissions,scope:this}]});A.cm=new Ext.grid.ColumnModel([{header:GO.lang.strName,dataIndex:"name",id:"name",renderer:this.iconRenderer,width:250},{header:GO.lang.strDescription,dataIndex:"description",id:"description"}]);A.ddGroup="ModulesGridDD";A.autoExpandMax=2500;A.enableDragDrop=true;A.layout="fit";A.store=this.installedModulesDS;A.sm=new Ext.grid.RowSelectionModel({singleSelect:false});A.paging=false;A.autoExpandColumn="description";GO.modules.MainPanel.superclass.constructor.call(this,A);this.on("rowdblclick",this.showPermissions,this)};Ext.extend(GO.modules.MainPanel,GO.grid.GridPanel,{afterRender:function(){GO.modules.MainPanel.superclass.afterRender.call(this);var B=function(C,H,G){var I=this.getSelectionModel();var F=I.getSelections();var D=C.getDragData(H).rowIndex;if(D=="undefined"){D=this.store.data.length-1}for(i=0;i<F.length;i++){var E=this.store.getById(F[i].id);if(!this.copy){this.store.remove(this.store.getById(F[i].id))}this.store.insert(D,E)}this.save()};var A=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:"ModulesGridDD",copy:false,notifyDrop:B.createDelegate(this)});this.store.load()},showavailableModules:function(){if(!this.availableModulesWin){this.availableModulesDS.load();var A=new GO.grid.GridPanel({layout:"fit",store:this.availableModulesDS,border:false,sm:new Ext.grid.RowSelectionModel({singleSelect:false}),columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strDescription,dataIndex:"description"}],paging:false,autoExpandColumn:1});this.availableModulesWin=new Ext.Window({layout:"fit",modal:false,shadow:false,minWidth:300,minHeight:300,height:400,width:600,plain:true,closeAction:"hide",title:GO.modules.lang.cmdAvailableModules,items:A,buttons:[{text:GO.modules.lang.cmdInstall,handler:function(){this.installModule(A)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.availableModulesWin.hide()},scope:this}]})}this.availableModulesWin.show()},save:function(){var A=new Array();for(var B=0;B<this.installedModulesDS.data.items.length;B++){A[B]={id:this.installedModulesDS.data.items[B].get("id"),sort_order:B,admin_menu:this.installedModulesDS.data.items[B].get("admin_menu")}}this.container.mask(GO.lang.waitMsgLoad,"x-mask-loading");var C=new GO.data.Connection();C.request({url:GO.settings.modules.modules.url+"action.php",params:{task:"update",modules:Ext.encode(A)},callback:function(E,F,D){this.container.unmask()},scope:this})},installModule:function(D){D.container.mask(GO.lang.waitMsgLoad);var A=D.getSelectionModel();var B=A.getSelections();var F=[];for(var C=0;C<B.length;C++){F.push(B[C].data.id)}if(B.length>0){var E=new GO.data.Connection();E.request({url:GO.settings.modules.modules.url+"action.php",params:{task:"install",modules:F.join(",")},callback:function(H,I,G){D.container.unmask();D.store.reload();this.store.reload();this.availableModulesWin.hide()},scope:this})}},uninstallModule:function(){var A=Ext.encode(this.selModel.selections.keys);switch(this.selModel.selections.keys.length){case 0:Ext.MessageBox.alert(GO.lang.strError,GO.lang.noItemSelected);return false;break;case 1:var C=GO.lang.strDeleteSelectedItem;break;default:var B=new Ext.Template(GO.lang.strDeleteSelectedItems);var C=B.applyTemplate({count:this.selModel.selections.keys.length});break}Ext.MessageBox.confirm(GO.lang.strConfirm,C,function(D){if(D=="yes"){this.store.baseParams.uninstall_modules=A;this.store.reload({callback:function(){if(!this.store.reader.jsonData.uninstallSuccess){Ext.MessageBox.alert(GO.lang.strError,this.store.reader.jsonData.uninstallFeedback)}this.availableModulesDS.reload()},scope:this});delete this.store.baseParams.uninstall_modules}},this)},showPermissions:function(){var A=this.getSelectionModel();var B=A.getSelections();if(B.length>0){if(!this.permissionsWin){this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.users.lang.useModule});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.users.lang.manageModule});this.tabPanel=new Ext.TabPanel({activeTab:0,items:[this.readPermissionsTab,this.writePermissionsTab]});this.permissionsWin=new Ext.Window({title:GO.lang.strPermissions,layout:"fit",modal:false,height:500,width:400,closeAction:"hide",items:[this.tabPanel],buttons:[{text:GO.lang.cmdClose,handler:function(){this.permissionsWin.hide()},scope:this}]})}this.permissionsWin.show();this.permissionsWin.setTitle(GO.lang.strPermissions+" "+B[0].data.name);this.readPermissionsTab.setAcl(B[0].data.acl_read);this.writePermissionsTab.setAcl(B[0].data.acl_write)}},iconRenderer:function(C,A,B){return'<div class="go-module-icon-'+B.data.id+'" style="height:16px;padding-left:22px;background-repeat:no-repeat;">'+C+"</div>"}});GO.moduleManager.addAdminModule("modules",GO.modules.MainPanel,{title:GO.modules.lang.modules,iconCls:"go-tab-icon-modules",closable:true});