GO.calendar.EventDialog=function(A){this.calendar=A;this.buildForm();this.beforeInit();this.tabPanel=new Ext.TabPanel({activeTab:0,deferredRender:false,border:false,anchor:"100% 100%",hideLabel:true,items:[this.propertiesPanel,this.descriptionPanel,this.recurrencePanel,this.optionsPanel,this.participantsPanel]});this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.calendar.url+"action.php",border:false,baseParams:{task:"event"},items:this.tabPanel});this.initWindow();this.addEvents({save:true});this.win.render(Ext.getBody())};Ext.extend(GO.calendar.EventDialog,Ext.util.Observable,{beforeInit:function(){},initWindow:function(){var B=function(){this.subjectField.focus()};var A=[this.linkBrowseButton=new Ext.Button({iconCls:"btn-link",cls:"x-btn-text-icon",text:GO.lang.cmdBrowseLinks,disabled:true,handler:function(){GO.linkBrowser.show({link_id:this.event_id,link_type:"1",folder_id:"0"})},scope:this})];if(GO.files){A.push(this.fileBrowseButton=new Ext.Button({iconCls:"go-menu-icon-files",cls:"x-btn-text-icon",text:GO.files.lang.files,handler:function(){GO.files.openFolder(this.files_folder_id)},scope:this,disabled:true}))}this.win=new Ext.Window({layout:"fit",modal:false,tbar:A,resizable:false,width:560,height:420,closeAction:"hide",title:GO.calendar.lang.appointment,items:this.formPanel,focus:B.createDelegate(this),buttons:[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]})},files_folder_id:0,show:function(B){if(B.oldDomId){this.oldDomId=B.oldDomId}else{this.oldDomId=false}delete this.link_config;this.formPanel.baseParams.tmp_files=B.tmp_files?Ext.encode(B.tmp_files):"";this.formPanel.form.reset();this.tabPanel.setActiveTab(0);if(!B.event_id){B.event_id=0}this.setEventId(B.event_id);if(B.event_id>0){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",success:function(D,E){this.win.show();this.participantsPanel.setEventId(E.result.data.participants_event_id);this.formPanel.form.baseParams.calendar_id=E.result.data.calendar_id;this.changeRepeat(E.result.data.repeat_type);this.setValues(B.values);this.setWritePermission(E.result.data.write_permission);this.selectCalendar.setRemoteText(E.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.files_folder_id=E.result.data.files_folder_id},failure:function(D,E){Ext.Msg.alert(GO.lang.strError,E.result.feedback)},scope:this})}else{if(B.exception_event_id){this.formPanel.load({url:GO.settings.modules.calendar.url+"json.php",params:{event_id:B.exception_event_id},waitMsg:GO.lang.waitMsgLoad,success:function(D,E){this.win.show();this.participantsPanel.setEventId(E.result.data.participants_event_id);this.formPanel.form.baseParams.exception_event_id=B.exception_event_id;this.formPanel.form.baseParams.exceptionDate=B.exceptionDate;this.formPanel.form.findField("repeat_type").setValue(0);this.changeRepeat(0);this.setValues(B.values);this.selectCalendar.setRemoteText(E.result.data.calendar_name);this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.setWritePermission(E.result.data.write_permission)},failure:function(D,E){Ext.Msg.alert(GO.lang.strError,E.result.feedback)},scope:this})}else{delete this.formPanel.form.baseParams.exception_event_id;delete this.formPanel.form.baseParams.exceptionDate;this.setWritePermission(true);this.win.show();this.selectCalendar.container.up("div.x-form-item").setDisplayed(false);B.values=B.values||{};var A=new Date();var C=parseInt(A.format("i"));if(C>45){C="45"}else{if(C>30){C="30"}else{if(C>15){C="15"}else{C="00"}}}if(!B.values.start_date){B.values.start_date=new Date()}if(!B.values.start_hour){B.values.start_hour=A.format("H")}if(!B.values.start_min){B.values.start_min=C}if(!B.values.end_date){B.values.end_date=new Date()}if(!B.values.end_hour){B.values.end_hour=A.add(Date.HOUR,1).format("H")}if(!B.values.end_min){B.values.end_min=C}this.setValues(B.values);if(!B.calendar_id){B.calendar_id=GO.calendar.defaultCalendar.id;B.calendar_name=GO.calendar.defaultCalendar.name}this.selectCalendar.setValue(B.calendar_id);if(B.calendar_name){this.selectCalendar.container.up("div.x-form-item").setDisplayed(true);this.selectCalendar.setRemoteText(B.calendar_name)}}}if(B&&B.link_config){this.link_config=B.link_config;if(B.link_config.type_id){this.selectLinkField.setValue(B.link_config.type_id);this.selectLinkField.setRemoteText(B.link_config.text);if(this.subjectField.getValue()==""){this.subjectField.setValue(B.link_config.text)}}}},setWritePermission:function(A){this.win.buttons[0].setDisabled(!A);this.win.buttons[1].setDisabled(!A)},setValues:function(A){if(A){for(var B in A){var C=this.formPanel.form.findField(B);if(C){C.setValue(A[B])}}}},setEventId:function(A){this.formPanel.form.baseParams.event_id=A;this.event_id=A;this.participantsPanel.setEventId(A);this.selectLinkField.container.up("div.x-form-item").setDisplayed(A==0);this.linkBrowseButton.setDisabled(A<1);if(GO.files){this.fileBrowseButton.setDisabled(A<1)}},setCurrentDate:function(){var B={};var A=new Date();B.start_date=A.format(GO.settings.date_format);B.start_hour=A.format("H");B.start_min="00";B.end_date=A.format(GO.settings.date_format);B.end_hour=A.add(Date.HOUR,1).format("H");B.end_min="00";this.formPanel.form.setValues(B)},submitForm:function(B,A){var C={task:"save_event"};if(this.participantsPanel.store.loaded){C.participants=Ext.encode(this.participantsPanel.getGridData())}this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:C,waitMsg:GO.lang.waitMsgSave,success:function(E,G){if(G.result.event_id){this.files_folder_id=G.result.files_folder_id;this.setEventId(G.result.event_id)}var D=this.formPanel.form.findField("start_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){D=D.add(Date.HOUR,this.formPanel.form.findField("start_hour").getValue());D=D.add(Date.MINUTE,this.formPanel.form.findField("start_min").getValue())}var H=this.formPanel.form.findField("end_date").getValue();if(!this.formPanel.form.findField("all_day_event").getValue()){H=H.add(Date.HOUR,this.formPanel.form.findField("end_hour").getValue());H=H.add(Date.MINUTE,this.formPanel.form.findField("end_min").getValue())}var F={calendar_id:this.selectCalendar.getValue(),event_id:this.event_id,name:Ext.util.Format.htmlEncode(this.subjectField.getValue()),start_time:D.format("Y-m-d H:i"),end_time:H.format("Y-m-d H:i"),startDate:D,endDate:H,description:Ext.util.Format.htmlEncode(GO.util.nl2br(this.formPanel.form.findField("description").getValue()).replace(/\n/g,"")),background:this.formPanel.form.findField("background").getValue(),location:this.formPanel.form.findField("location").getValue(),repeats:this.formPanel.form.findField("repeat_type").getValue()>0,"private":false};this.fireEvent("save",F,this.oldDomId);if(this.link_config&&this.link_config.callback){this.link_config.callback.call(this)}if(B){this.win.hide()}if(A&&A.callback){A.callback.call(this,this,true)}},failure:function(D,E){if(E.failureType=="client"){error=GO.lang.strErrorsInForm}else{error=E.result.feedback}if(A&&A.callback){A.callback.call(this,this,false)}Ext.MessageBox.alert(GO.lang.strError,error)},scope:this})},getStartDate:function(){var A=this.startDate.getValue();A=A.add(Date.HOUR,this.startHour.getValue());A=A.add(Date.MINUTE,this.startMin.getValue());return A},getEndDate:function(){var A=this.endDate.getValue();A=A.add(Date.HOUR,this.endHour.getValue());A=A.add(Date.MINUTE,this.endMin.getValue());return A},checkDateInput:function(){var A=this.endDate.getValue();var D=this.startDate.getValue();if(D>A){this.endDate.setValue(D)}if(D.getElapsed(A)==0){var C=this.startHour.getValue();var E=this.endHour.getValue();var F=this.startMin.getValue();var B=this.endMin.getValue();if(C>E){E=C;this.endHour.setValue(C)}if(C==E&&F>B){this.endMin.setValue(F)}}if(this.repeatType.getValue()>0){if(this.repeatEndDate.getValue()==""){this.repeatForever.setValue(true)}else{if(this.repeatEndDate.getValue()<A){this.repeatEndDate.setValue(A.add(Date.DAY,1))}}}this.participantsPanel.reloadAvailability()},buildForm:function(){this.selectLinkField=new GO.form.SelectLink({});var I=Array();if(GO.settings.time_format.substr(0,1)=="G"){var D=40;var A="G"}else{var D=60;var A="g a"}for(var F=0;F<24;F++){var G=Date.parseDate(F,"G");I.push([G.format("G"),G.format(A)])}var C=[["00","00"],["05","05"],["10","10"],["15","15"],["20","20"],["25","25"],["30","30"],["35","35"],["40","40"],["45","45"],["50","50"],["55","55"]];this.subjectField=new Ext.form.TextField({name:"subject",allowBlank:false,fieldLabel:GO.lang.strSubject});this.locationField=new Ext.form.TextField({name:"location",allowBlank:true,fieldLabel:GO.lang.strLocation});this.startDate=new Ext.form.DateField({name:"start_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strStart,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.startHour=new Ext.form.ComboBox({hiddenName:"start_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:I}),valueField:"value",displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:D,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.startMin=new Ext.form.ComboBox({name:"start_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:C}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endDate=new Ext.form.DateField({name:"end_date",width:100,format:GO.settings.date_format,allowBlank:false,fieldLabel:GO.lang.strEnd,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endHour=new Ext.form.ComboBox({hiddenName:"end_hour",store:new Ext.data.SimpleStore({fields:["value","text"],data:I}),displayField:"text",valueField:"value",mode:"local",triggerAction:"all",selectOnFocus:true,width:D,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.endMin=new Ext.form.ComboBox({name:"end_min",store:new Ext.data.SimpleStore({fields:["value","text"],data:C}),displayField:"text",mode:"local",triggerAction:"all",selectOnFocus:true,width:40,labelSeparator:"",hideLabel:true,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.allDayCB=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.allDay,name:"all_day_event",checked:false,width:"auto",labelSeparator:"",hideLabel:true});this.allDayCB.on("check",function(K,J){this.startHour.setDisabled(J);this.endHour.setDisabled(J);this.startMin.setDisabled(J);this.endMin.setDisabled(J)},this);this.eventStatus=new Ext.form.ComboBox({hiddenName:"status",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,fieldLabel:"Status",mode:"local",value:"ACCEPTED",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["NEEDS-ACTION",GO.calendar.lang.needsAction],["ACCEPTED",GO.calendar.lang.accepted],["DECLINED",GO.calendar.lang.declined],["TENTATIVE",GO.calendar.lang.tentative],["DELEGATED",GO.calendar.lang.delegated]]})});this.busy=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.busy,name:"busy",checked:true,width:"auto",labelSeparator:"",hideLabel:true});this.propertiesPanel=new Ext.Panel({title:GO.lang.strProperties,defaults:{anchor:"-20"},bodyStyle:"padding:5px",layout:"form",autoScroll:true,items:[this.subjectField,this.locationField,this.selectLinkField,{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.startDate},{items:this.startHour},{items:this.startMin},{bodyStyle:"white-space:nowrap;",items:this.allDayCB}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.endDate},{items:this.endHour},{items:this.endMin}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.eventStatus},{items:this.busy}]},this.selectCalendar=new GO.calendar.SelectCalendar({anchor:"-20",pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false})]});this.descriptionPanel=new Ext.Panel({title:GO.lang.strDescription,layout:"fit",border:false,items:[{xtype:"textarea",name:"description",anchor:"100% 100%",hideLabel:true}]});var E=new Array();for(var F=1;F<31;F++){E.push([F])}this.repeatEvery=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.repeatEvery,hiddenName:"repeat_every",triggerAction:"all",editable:false,selectOnFocus:true,width:50,forceSelection:true,mode:"local",value:"1",valueField:"value",displayField:"value",store:new Ext.data.SimpleStore({fields:["value"],data:E})});this.repeatType=new Ext.form.ComboBox({hiddenName:"repeat_type",triggerAction:"all",editable:false,selectOnFocus:true,width:200,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["0",GO.calendar.lang.noRecurrence],["1",GO.calendar.lang.days],["2",GO.calendar.lang.weeks],["3",GO.calendar.lang.monthsByDate],["4",GO.calendar.lang.monthsByDay],["5",GO.calendar.lang.years]]}),hideLabel:true,listeners:{change:this.checkDateInput,scope:this}});this.repeatType.on("select",function(K,J){this.changeRepeat(J.data.value)},this);this.monthTime=new Ext.form.ComboBox({hiddenName:"month_time",triggerAction:"all",selectOnFocus:true,disabled:true,width:80,forceSelection:true,fieldLabel:GO.calendar.lang.atDays,mode:"local",value:"1",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["1",GO.lang.strFirst],["2",GO.lang.strSecond],["3",GO.lang.strThird],["4",GO.lang.strFourth]]})});this.cb=[];for(var H=0;H<7;H++){this.cb[H]=new Ext.form.Checkbox({boxLabel:GO.lang.shortDays[H],id:"frm_repeat_days_"+H,name:"repeat_days_"+H,disabled:true,checked:false,width:"auto",hideLabel:true,laelSeperator:""})}this.repeatEndDate=new Ext.form.DateField({name:"repeat_end_date",width:100,disabled:true,format:GO.settings.date_format,allowBlank:true,fieldLabel:GO.calendar.lang.repeatUntil,listeners:{change:{fn:this.checkDateInput,scope:this}}});this.repeatForever=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.repeatForever,name:"repeat_forever",checked:true,disabled:true,width:"auto",hideLabel:true,laelSeperator:""});this.recurrencePanel=new Ext.Panel({title:GO.calendar.lang.recurrence,bodyStyle:"padding: 5px",layout:"form",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.repeatEvery},{items:this.repeatType}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px;white-space:nowrap"},items:[{items:this.monthTime},{items:this.cb[0]},{items:this.cb[1]},{items:this.cb[2]},{items:this.cb[3]},{items:this.cb[4]},{items:this.cb[5]},{items:this.cb[6]}]},{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.repeatEndDate},{items:this.repeatForever}]}]});var B=[["0",GO.calendar.lang.noReminder]];for(var F=1;F<60;F++){B.push([F,F])}this.reminderValue=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.reminder,hiddenName:"reminder_value",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:GO.calendar.defaultReminderValue,valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:B})});this.reminderMultiplier=new Ext.form.ComboBox({hiddenName:"reminder_multiplier",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:GO.calendar.defaultReminderMultiplier,valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["60",GO.lang.strMinutes],["3600",GO.lang.strHours],["86400",GO.lang.strDays]]}),hideLabel:true,labelSeperator:""});this.participantsPanel=new GO.calendar.ParticipantsPanel(this);this.privateCB=new Ext.form.Checkbox({boxLabel:GO.calendar.lang.privateEvent,name:"private",checked:false,width:"auto",labelSeparator:"",hideLabel:true});this.optionsPanel=new Ext.Panel({title:GO.calendar.lang.options,bodyStyle:"padding:5px",layout:"form",autoScroll:true,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.reminderValue},{items:this.reminderMultiplier}]},this.colorField=new GO.form.ColorField({fieldLabel:GO.lang.color,value:GO.calendar.defaultBackground,name:"background",colors:["EBF1E2","95C5D3","FFFF99","A68340","82BA80","F0AE67","66FF99","CC0099","CC99FF","996600","999900","FF0000","FF6600","FFFF00","FF9966","FF9900","FB0467","D52A6F","CC3370","C43B72","BB4474","B34D75","AA5577","A25E79","FF00CC","D52AB3","CC33AD","C43BA8","BB44A3","B34D9E","AA5599","A25E94","CC00FF","B32AD5","AD33CC","A83BC4","A344BB","9E4DB3","9955AA","945EA2","6704FB","6E26D9","7033CC","723BC4","7444BB","754DB3","7755AA","795EA2","0404FB","2626D9","3333CC","3B3BC4","4444BB","4D4DB3","5555AA","5E5EA2","0066FF","2A6ED5","3370CC","3B72C4","4474BB","4D75B3","5577AA","5E79A2","00CCFF","2AB2D5","33ADCC","3BA8C4","44A3BB","4D9EB3","5599AA","5E94A2","00FFCC","2AD5B2","33CCAD","3BC4A8","44BBA3","4DB39E","55AA99","5EA294","00FF66","2AD56F","33CC70","3BC472","44BB74","4DB375","55AA77","5EA279","00FF00","2AD52A","33CC33","3BC43B","44BB44","4DB34D","55AA55","5EA25E","66FF00","6ED52A","70CC33","72C43B","74BB44","75B34D","77AA55","79A25E","CCFF00","B2D52A","ADCC33","A8C43B","A3BB44","9EB34D","99AA55","94A25E","FFCC00","D5B32A","CCAD33","C4A83B","BBA344","B39E4D","AA9955","A2945E","FF6600","D56F2A","CC7033","C4723B","BB7444","B3754D","AA7755","A2795E","FB0404","D52A2A","CC3333","C43B3B","BB4444","B34D4D","AA5555","A25E5E","FFFFFF","949494","808080","6B6B6B","545454","404040","292929","000000"]}),this.privateCB]})},changeRepeat:function(B){var A=this.formPanel.form;switch(B){case"0":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(true);A.findField("repeat_end_date").setDisabled(true);A.findField("repeat_every").setDisabled(true);break;case"1":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"2":this.disableDays(false);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"3":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"4":this.disableDays(false);A.findField("month_time").setDisabled(false);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break;case"5":this.disableDays(true);A.findField("month_time").setDisabled(true);A.findField("repeat_forever").setDisabled(false);A.findField("repeat_end_date").setDisabled(false);A.findField("repeat_every").setDisabled(false);break}},disableDays:function(B){for(var A=0;A<7;A++){this.formPanel.form.findField("repeat_days_"+A).setDisabled(B)}}});GO.grid.CalendarGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),appointmentsMap:{},allDayAppointments:Array(),allDayAppointmentsMap:[],allDayEventRows:0,allDayColumns:Array(),remoteEvents:Array(),domIds:Array(),days:1,scale:96,hourHeight:40,loaded:false,writePermission:false,scrollOffset:19,selected:Array(),initComponent:function(){this.cls="x-calGrid-panel";GO.grid.CalendarGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate;this.rowsPerHour=this.scale/24;this.rowHeight=this.hourHeight/this.rowsPerHour},doLayout:function(){GO.grid.CalendarGrid.superclass.doLayout.call(this);if(this.rendered){this.setDate(this.startDate,this.days,false);this.body.setStyle("overflow","hidden");this.body.unselectable();if(this.daysGridRendered){this.cacheGridCells()}this.setStore(this.store)}},renderDaysGrid:function(){this.daysGridRendered=true;this.body.update("");var L=this.container.getSize(true);var J=((L.width-40-this.scrollOffset)/this.days);J=Math.floor(J);this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+(L.width)+"px;"},true);var A=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(A,{tag:"tr",children:{tag:"td",style:"width:37px",cls:"x-calGrid-heading"}},true);this.allDayTableContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-all-day-table-container"},true);this.allDayTable=Ext.DomHelper.append(this.allDayTableContainer,{tag:"table",id:Ext.id(),cls:"x-calGrid-all-day-table",style:"width:"+(L.width-this.scrollOffset)+"px;"},true);var A=Ext.DomHelper.append(this.allDayTable,{tag:"tbody"},true);this.allDayRow=Ext.DomHelper.append(A,{tag:"tr",children:{tag:"td",style:"width:40px",cls:"x-calGrid-all-day-first-col"}},true);var V=GO.settings.date_format.indexOf("Y");var R="D "+GO.settings.date_format.substring(0,V-1);var E=new Date();var Q=E.format(R);var O,U,H,N,C;this.allDayColumns=Array();for(var T=0;T<this.days;T++){O=this.startDate.add(Date.DAY,T);U=O.format(R);C=U==Q?"x-calGrid-heading x-calGrid-heading-today":"x-calGrid-heading";H=Ext.DomHelper.append(this.headingsRow,{tag:"td",children:[{tag:"div",cls:C,style:"width:"+(J-3)+"px",html:O.format(R)}]});N=Ext.DomHelper.append(this.allDayRow,{tag:"td",id:"all_day_"+T,cls:"x-calGrid-all-day-container",style:"width:"+(J-3)+"px;height:0px"},true);this.allDayColumns.push(N)}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset)+"px;height:0px",cls:"x-calGrid-heading"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var M=this.headingsTable.getHeight();this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-calGrid-table",style:"width:"+L.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridTable.on("mousedown",this.startSelection,this);this.gridContainer.on("mousemove",this.onEventDragMouseMove,this);this.body.on("mouseup",this.onEventDragMouseUp,this);this.allDayTable.on("mousemove",this.onAllDayEventDragMouseMove,this);this.body.on("mouseup",this.onAllDayEventDragMouseUp,this);var G=Ext.DomHelper.append(this.tbody,{tag:"tr"});var I=Ext.DomHelper.append(G,{tag:"td",style:"width:40px"},true);var D;for(var S=0;S<this.scale;S+=this.rowsPerHour){timeformat=GO.settings.time_format.substr(0,1)=="G"?"G:i":"g a";Ext.DomHelper.append(I,{tag:"div",id:"head"+S,cls:"x-calGrid-timeHead",html:Date.parseDate(S/this.rowsPerHour,"G").format(timeformat),style:"width:40px;height:"+(((this.rowHeight+1)*this.rowsPerHour)-1)+"px"},true)}this.gridCells=[];var K,F,B;for(var T=0;T<this.days;T++){this.gridCells[T]=[];K=Ext.DomHelper.append(G,{tag:"td",id:"dayCol"+T,style:"width:"+J+"px"},true);F="x-calGrid-hourRow";var P=0;for(var S=0;S<this.scale;S++){if(P==0){F="x-calGrid-hourRow"}else{if(this.rowsPerHour/P==2){F="x-calGrid-halfhourRow"}else{F="x-calGrid-blankRow"}}B=Ext.DomHelper.append(K,{tag:"div",id:"day"+T+"_row"+S,cls:F,style:"height:"+this.rowHeight+"px"},true);this.gridCells[T].push(B);P++;if(P==this.rowsPerHour){P=0}}}this.gridX=0;this.gridY=0;this.gridContainer.on("scroll",this.storeScrollPosition,this);this.daysRendered=this.days;this.selector=Ext.DomHelper.append(this.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-selector"},true);this.cacheGridCells();this.gridTableHeight=this.gridTable.getHeight()},cacheGridCells:function(){this.gridTable.xy=this.gridTable.getXY();var A=this.gridTable.getY();var B=this.gridCells[0][0].getSize();var J=this.gridCells[0][0].getXY();var I=J[0];var G=J[1]-A;for(var H=0;H<this.days;H++){var D=I+(H*B.width);for(var F=0;F<this.scale;F++){var C=G+(F*B.height);if(this.gridCells[H]){this.gridCells[H][F].xy=[D,C];this.gridCells[H][F].size=B}else{alert("error")}}}var E=this.gridCells[0][0];this.snapCol={x:E.size["width"],y:E.size["height"]}},autoSizeGrid:function(){var B=this.ownerCt.body.getHeight();var D=this.headingsTable.getHeight();var C=this.allDayTableContainer.getHeight();if(C>(B/2)){C=B/2;this.allDayTableContainer.setHeight(C)}var A=B-D-C-2;this.gridContainer.setHeight(A)},onResize:function(D,B,A,C){if(this.daysRendered==this.days){if(this.loaded){this.store.reload()}}},setStore:function(A,B){if(!B&&this.store){this.store.un("beforeload",this.mask,this);this.store.un("datachanged",this.reload)}if(A){A.on("beforeload",this.mask,this);A.on("datachanged",this.reload,this)}this.store=A},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(A){var B=A.getDay();var C=this.firstWeekday-B;if(C>0){C-=7}return A.add(Date.DAY,C)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSnap:function(){return this.snapCol},getGridXY:function(){var A=Ext.get("day0_row0");return A.getXY()},getRowIdByXY:function(B,E){var A=this.getSnap();var C=(B-this.gridX)/A.x;var D=(E-this.gridY)/A.y;return"day"+C+"_row"+D},getRowNumberByY:function(C){var A=this.getSnap();var B=this.gridTable.getXY();return Math.floor((C-B[1])/A.y)},getDayByX:function(B){var A=this.getSnap();var C=this.gridTable.getXY();return Math.floor((B-C[0]-40)/A.x)},startSelection:function(D){if(this.writePermission&&!this.dragEvent){var C=D.getXY();this.clickedDay=this.getDayByX(C[0]);this.clickedRow=this.getRowNumberByY(C[1]);this.dragSnap=this.getSnap();this.selectorStartRow=this.gridCells[this.clickedDay][this.clickedRow];if(this.selectorStartRow){var B=this.gridTable.getY();var A=[this.selectorStartRow.xy[0],this.selectorStartRow.xy[1]+B];if(!this.overlay){this.overlay=this.body.createProxy({tag:"div",cls:"x-resizable-overlay",html:"&#160;"});this.overlay.unselectable();this.overlay.enableDisplayMode("block");this.overlay.on("mousemove",this.onSelectionMouseMove,this);this.overlay.on("mouseup",this.onSelectionMouseUp,this)}this.overlay.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.overlay.show();this.selector.setXY(A);this.selector.setSize(this.snapCol.x-3,this.snapCol.y);this.selector.setVisible(true,false)}}},onSelectionMouseMove:function(C){var D=C.getXY();var B=this.selector.getXY();var A=this.snap(D[1]-B[1],this.dragSnap.y,0);this.selector.setHeight(A)},onSelectionMouseUp:function(A){this.overlay.hide();this.fireEvent("create",this,this.domToTimes(this.selector.id));this.clearSelection()},getDayIndex:function(A){},addDaysGridEvent:function(P,C){var G=Date.parseDate(P.startDate.format("Ymd"),"Ymd");var A=Date.parseDate(P.endDate.format("Ymd"),"Ymd");var E=this.startDate.format("U");var I=G.format("U");var K,H,B,J;K=H=Math.round((I-E)/86400);if(K<0){K=0}var N=A.format("U");B=J=Math.round((N-E)/86400);if(B>this.days){B=this.days-1}if(K<this.days&&B>-1){var O=P.startDate.getHours()*this.rowsPerHour;var F=P.endDate.getHours()*this.rowsPerHour-1;var M=60/this.rowsPerHour;var D=P.startDate.getMinutes();O+=Math.ceil(D/M);var L=P.endDate.getMinutes();F+=Math.ceil(L/M);if(F<O){F=O}if(O&&F&&(H==J)){return this.addGridEvent(P,K,O,F,C)}else{return this.addAllDayEvent(P,K,B)}}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearEventSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearEventSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);B.addClass("x-calGrid-selected");this.selected.push(B)}}},removeEvent:function(E){if(this.appointmentsMap[E]&&this.appointments[this.appointmentsMap[E].day]){var A=this.appointmentsMap[E].day;var F=[];for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id!=E){F.push(this.appointments[A][B])}}this.appointments[A]=F}else{if(this.allDayAppointmentsMap[E]&&this.appointments[this.allDayAppointmentsMap[E].day]){var A=this.allDayAppointmentsMap[E];var F=[];for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id!=E){F.push(this.appointments[A][B])}}this.allDayAppointmentsMap[A]=F}}var D=this.getRelatedDomElements(E);if(D){for(var B=0;B<D.length;B++){var C=Ext.get(D[B]);if(C){C.removeAllListeners();C.remove()}this.unregisterDomId(D[B])}}if(A){this.calculateAppointments(A)}},unregisterDomId:function(D){delete this.remoteEvents[D];delete this.appointmentsMap[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},addAllDayEvent:function(J,G,B){J.allDay=true;J.daySpan=B-G+1;if(G<0){G=0}if(B>this.days-1){B=this.days-1}var D=this.getSnap();if(G!=B){var I=GO.settings.date_format+" "+GO.settings.time_format;text=J.startDate.format(I)+"&nbsp;"+J.name}else{text=J.name}var H=B-G;var F=0;for(var E=G;E<=B;E++){var C=Ext.id();this.registerEvent(C,J);if(H>0){if(!this.domIds[J.id]){this.domIds[J.id]=[]}this.domIds[J.id].push(C)}var A=Ext.DomHelper.append(this.allDayColumns[E],{tag:"div",id:C,cls:"x-calGrid-all-day-event-container",style:"background-color:#"+J.background,html:text,qtip:GO.calendar.formatQtip(J),qtitle:J.name},true);if(typeof (this.allDayAppointments[E])=="undefined"){this.allDayAppointments[E]=Array()}this.allDayAppointments[E].push(A);this.allDayAppointmentsMap[C]=E;A.on("mousedown",function(L,K){K=Ext.get(K).findParent("div.x-calGrid-all-day-event-container",2,true);this.selectEventElement(K);this.clickedEventId=K.id;this.eventMouseUp=false;this.startAllDayEventDrag(L,K.id)},this);A.on("dblclick",function(N,K){var L={};var M=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",M,L)}else{this.fireEvent("eventDblClick",this,M,L)}},this);A.on("mouseup",function(){this.eventMouseUp=true},this)}return C},addGridEvent:function(L,J,M,H,B){var O='<span class="x-calGrid-event-time">'+L.startDate.format(GO.settings.time_format)+"</span>&nbsp;"+L.name;if(L.location!=""){O+=" @ "+L.location}var E=Ext.id();this.registerEvent(E,L);var F=this.getSnap();if(H>(this.scale-1)){H=this.scale-1}var A=this.gridContainer.insertFirst({tag:"div",id:E,cls:"x-calGrid-event-container",style:"background-color:#"+L.background,qtip:GO.calendar.formatQtip(L),qtitle:L.name,html:O});A.repeats=L.repeats;var I=Ext.get("day"+J+"_row"+M);var C=Ext.get("day"+J+"_row"+H);var D=I.getXY();var G=C.getXY();var N=G[1]-D[1]+F.y;A.setXY(D);A.setSize(F.x-2,N);A.on("mousedown",function(Q,P){P=Ext.get(P).findParent("div.x-calGrid-event-container",4,true);this.selectEventElement(P);this.clickedEventId=P.id;this.eventMouseUp=false;this.startEventDrag(Q,P.id)},this);A.on("dblclick",function(S,P){var Q={};var R=this.elementToEvent(this.clickedEventId);if(this.remoteEvents[this.clickedEventId]["repeats"]&&this.writePermission){this.handleRecurringEvent("eventDblClick",R,Q)}else{this.fireEvent("eventDblClick",this,R,Q)}},this);A.on("mouseup",function(){this.eventMouseUp=true},this);if(typeof (this.appointments[J])=="undefined"){this.appointments[J]=Array()}this.appointments[J].push(A);this.appointmentsMap[E]={day:J};if(this.writePermission&&!L["private"]){var K=new Ext.Resizable(A,{handles:"s",minHeight:F.y,maxWidth:A.getWidth(),heightIncrement:F.y,draggable:false,pinned:true});K.on("resize",function(R,T,X,Y,U){if(X>0){var Q=this.domToTimes(R.el.id,false);var S=Q.startDate.format("U");var W=Q.endDate.format("U");var Z={duration:W-S,dragDate:this.remoteEvents[R.el.id].startDate};var P=this.elementToEvent(R.el.id);var V=R.el.getX();this.clickedDay=this.getDayByX(V);if(this.remoteEvents[R.el.id]["repeats"]){P.day=this.clickedDay;this.handleRecurringEvent("eventResize",P,Z)}else{this.resizeAppointment(R.el.id,this.clickedDay);this.fireEvent("eventResize",this,P,Z)}}},this)}if(B){this.calculateAppointments(J)}return E},resizeAppointment:function(C,A){var B=this.findAppointment(A,C);this.appointments[A][B].size=this.appointments[A][B].getSize();this.remoteEvents[C].repeats=false;this.calculateAppointments(A)},calculateAppointments:function(M){if(typeof (this.appointments[M])!="undefined"){var J=this.getSnap();var O=this.gridTable.getY();var H=0;var E=Array();var H=0;this.appointments[M].sort(function(T,S){return T.getY()-S.getY()});var G=0;this.rows=Array();for(var F=0;F<this.scale;F++){var C=this.gridCells[M][F];var R=C.xy[1];if(F==0){G=C.xy[0]}if(typeof (this.rows[F])=="undefined"){this.rows[F]=Array()}for(var N=0;N<this.appointments[M].length;N++){if(!this.appointments[M][N].xy){this.appointments[M][N].xy=this.appointments[M][N].getXY();this.appointments[M][N].xy[1]-=O}if(!this.appointments[M][N].size){this.appointments[M][N].size=this.appointments[M][N].getSize()}var P=this.appointments[M][N].xy;var D=this.appointments[M][N].size;if((C.xy[0]+C.size.width)>=P[0]&&C.xy[0]<=P[0]+D.width&&R+C.size.height<=P[1]+D.height&&R+C.size.height>P[1]){if(typeof (E[this.appointments[M][N].id])=="undefined"){var Q=0;while(typeof (this.rows[F][Q])!="undefined"){Q++}eventRowId=F;for(var K=R;K<P[1]+D.height-3;K+=J.y){if(typeof (this.rows[eventRowId])=="undefined"){this.rows[eventRowId]=Array()}this.rows[eventRowId][Q]=this.appointments[M][N].id;eventRowId++}this.rows[F][Q]=this.appointments[M][N].id;E[this.appointments[M][N].id]=Q}}}if(Q>H){H=Q}}var B=J.x/(H+1);for(var N=0;N<this.appointments[M].length;N++){if(!this.appointments[M][N].xy){this.appointments[M][N].xy=this.appointments[M][N].getXY();this.appointments[M][N].xy[1]-=O}if(!this.appointments[M][N].size){this.appointments[M][N].size=this.appointments[M][N].getSize()}var P=this.appointments[M][N].xy;var D=this.appointments[M][N].size;var F=Math.floor(P[1]/J.y);var L=(D.height-2)/J.y;var I=this.getEventWidth(E[this.appointments[M][N].id],H,F,L,B);this.appointments[M][N].setWidth(I);var A=E[this.appointments[M][N].id]*B;this.appointments[M][N].setX(G+A)}}},getEventWidth:function(E,B,A,G,D){var H=D;var C=E+1;while(C<=B){for(var F=0;F<G;F++){if(typeof (this.rows[A+F][C])!="undefined"){return H-2}}H+=D;C++}return H-2},inAppointmentsArray:function(C,B){for(var A=0;A<B.length;A++){if(B[A].id==C){return true}}return false},clearSelection:function(){this.selector.setVisible(false)},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);if(!this.currentRecurringEvent.allDay){if(this.currentFireEvent=="eventResize"){this.resizeAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.day)}else{if(this.currentFireEvent=="move"){this.moveAppointment(this.currentRecurringEvent.domId,this.currentRecurringEvent.oldPos,this.currentRecurringEvent.newPos)}}}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},snapPos:function(D,E,B){var F=E-D;var C=Math.floor(F/B);var G=F-(C*B);var A=B/2;if(G>A){C++}return D+(C*B)},snap:function(C,E,B){if(!E||!C){return C}var D=C;var A=C%E;if(A>0){if(A>(E/2)){D=C+(E-A)}else{D=C-A}}return Math.max(B,D)},clearGrid:function(){this.allDayAppointmentsMap={};this.appointmentsMap={};this.appointments={};this.allDayAppointments=Array();this.remoteEvents=Array();this.domIds=Array()},next:function(A){if(!A){A=this.days}this.setDate(this.startDate.add(Date.DAY,A))},setDays:function(B,A){this.setDate(this.configuredDate,B,A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;if(E){this.days=E}this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(D){this.store.reload()}},reload:function(){this.load()},load:function(){var C=this.store.getRange();this.writePermission=this.store.reader.jsonData.write_permission;this.clearGrid();this.renderDaysGrid();for(var D=0,B=C.length;D<B;D++){var A=Date.parseDate(C[D].data.start_time,this.dateTimeFormat);var F=Date.parseDate(C[D].data.end_time,this.dateTimeFormat);var E=C[D].data;E.startDate=A;E.endDate=F;this.addDaysGridEvent(E)}this.autoSizeGrid();this.scrollToLastPosition();for(var D=0;D<this.days;D++){this.calculateAppointments(D)}this.unmask();this.loaded=true},registerEvent:function(B,A){this.remoteEvents[B]=A},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){var C=this.domToTimes(A,B);this.remoteEvents[A]["domId"]=A;this.remoteEvents[A]["startDate"]=C.startDate;this.remoteEvents[A]["endDate"]=C.endDate;return this.remoteEvents[A]},domToTimes:function(D,K){if(!K){K=false}var B=Ext.get(D);if(!B){return false}var F=B.getXY();if(!K){var L=B.getSize();var J=this.getRowNumberByY(F[1]);if(J<0){J=0}var E=this.getRowNumberByY(F[1]+L.height);if(E<=J){E=J+1}}else{J=0;E=0}var H=this.getDayByX(F[0]);var C=this.startDate.add(Date.DAY,H);var I=60/this.rowsPerHour;var A=C.add(Date.MINUTE,J*I);var G=C.add(Date.MINUTE,E*I);return{startDate:A,endDate:G,day:H}},scrollToRow:function(B){var A=this.getSnap();if(!A){return false}this.gridContainer.scrollTo("top",A.y*B)},scrollToLastPosition:function(){if(this.gridContainer){if(this.scrollPosition&&this.scrollPosition.top>0){this.gridContainer.scrollTo("top",this.scrollPosition.top)}else{this.scrollToRow(7*this.rowsPerHour)}}},storeScrollPosition:function(B,A){var C=Ext.get(A).getScroll();if(C.top>0){this.scrollPosition=Ext.get(A).getScroll()}},onShow:function(){GO.grid.CalendarGrid.superclass.onShow.call(this);this.scrollToLastPosition()},startEventDrag:function(B,A){if(this.writePermission&&!this.eventMouseUp){this.dragClickEventPosition=B.getXY();this.originalEvent=this.elementToEvent(A);if(!this.originalEvent["private"]){this.dragEvent=Ext.get(A);this.dragEvent.size=this.dragEvent.getSize();this.dragappointmentstartPos=this.dragEvent.getXY();this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragYoffset=this.dragClickEventPosition[1]-this.dragappointmentstartPos[1];this.lastDragX=this.dragappointmentstartPos[0];this.lastDragY=this.dragappointmentstartPos[1];this.dragSnap=this.getSnap();this.columnsContainerY=this.gridTable.getY()}}},onEventDragMouseMove:function(G){if(this.dragEvent){var F=G.getXY();var A=this.snapPos(this.dragappointmentstartPos[0],F[0]-this.dragXoffset,this.dragSnap.x,this.days);var H=this.snapPos(this.dragappointmentstartPos[1],F[1]-this.dragYoffset,this.dragSnap.y,this.scale);var E=this.columnsContainerY-4;var B=this.gridCells[0][0].xy[0]-4;var D=this.columnsContainerY+this.gridTableHeight-this.dragEvent.size.height+5;var C=this.gridCells[this.days-1][47].xy[0]+4;if(A!=this.lastDragX&&A<C&&A>B){this.lastDragX=A;this.dragEvent.setX(A)}if(H!=this.lastDragY&&H<D&&H>E){this.lastDragY=H;this.dragEvent.setY(H)}}},onEventDragMouseUp:function(F){if(this.dragEvent){var G=this.dragEvent.getXY();if(G[0]!=this.dragappointmentstartPos[0]||G[1]!=this.dragappointmentstartPos[1]){var A=this.domToTimes(this.dragEvent.id,false);var H=A.startDate.format("U");var D=this.remoteEvents[this.dragEvent.id].startDate.format("U");var I={offset:H-D,dragDate:this.remoteEvents[this.dragEvent.id].startDate};var B=this.elementToEvent(this.dragEvent.id);var E=Ext.get(this.dragEvent.id);var C=E.select("span.x-calGrid-event-time");if(C){C.update(B.startDate.format(GO.settings.time_format));E.set({"ext:qtip":GO.calendar.formatQtip(B)})}if(this.remoteEvents[this.dragEvent.id]["repeats"]){B.oldPos=this.dragappointmentstartPos;B.newPos=G;this.handleRecurringEvent("move",B,I)}else{this.moveAppointment(this.dragEvent.id,this.dragappointmentstartPos,G);this.fireEvent("move",this,B,I)}}this.dragEvent=false}},findAppointment:function(A,C){for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id==C){return B}}},moveAppointment:function(G,B,D){var E=this.getDayByX(B[0]);var F=this.getDayByX(D[0]);var A=this.gridTable.getY();var C=this.findAppointment(E,G);this.appointments[E][C].xy=D;this.appointments[E][C].xy[1]-=A;this.appointments[E][C].size=this.appointments[E][C].getSize();this.remoteEvents[G].repeats=false;if(E!=F){if(!this.appointments[F]){this.appointments[F]=[]}this.appointments[F].push(this.appointments[E][C]);this.appointments[E].splice(C,1);this.calculateAppointments(E);this.calculateAppointments(F)}else{this.calculateAppointments(F)}},startAllDayEventDrag:function(B,A){if(!this.eventMouseUp&&this.writePermission){this.dragClickEventPosition=B.getXY();this.originalEvent=this.elementToEvent(A,true);this.allDayDragDate=this.originalEvent.startDate;if(!this.originalEvent["private"]){this.allDayDragEvent=Ext.get(A);this.allDayDragEvent.size=this.allDayDragEvent.getSize();this.dragappointmentstartPos=this.allDayDragEvent.getXY();this.currentDragDay=this.getDayByX(this.dragappointmentstartPos[0]+1);this.dragXoffset=this.dragClickEventPosition[0]-this.dragappointmentstartPos[0];this.dragSnap=this.getSnap()}}},currentDragDay:false,onAllDayEventDragMouseMove:function(D){if(this.allDayDragEvent){var C=D.getXY();var A=this.snapPos(this.dragappointmentstartPos[0],C[0]-this.dragXoffset,this.dragSnap.x,this.days);var B=this.getDayByX(C[0]+1);if(this.currentDragDay!=B&&this.allDayColumns[B]){this.currentDragDay=B;this.allDayColumns[B].appendChild(this.allDayDragEvent)}}},onAllDayEventDragMouseUp:function(F){if(this.allDayDragEvent){var C=F.getXY();if(C[0]!=this.dragappointmentstartPos[0]){var A=this.getDayByX(this.dragappointmentstartPos[0]+1);var B=this.getDayByX(C[0]+1);if(A!=B&&this.allDayColumns[B]){var G=B-A;var E=this.elementToEvent(this.allDayDragEvent.id,true);var D={offsetDays:G,dragDate:this.allDayDragDate};if(this.remoteEvents[this.allDayDragEvent.id]["repeats"]){this.handleRecurringEvent("move",E,D)}else{this.fireEvent("move",this,E,D);this.removeEvent(this.allDayDragEvent.id);E.startDate=Date.parseDate(E.start_time,this.dateTimeFormat).add(Date.DAY,G);E.endDate=Date.parseDate(E.end_time,this.dateTimeFormat).add(Date.DAY,G);E.start_time=E.startDate.format(this.dateTimeFormat);E.end_time=E.endDate.format(this.dateTimeFormat);this.addDaysGridEvent(E)}}this.autoSizeGrid()}this.allDayDragEvent=false}}});GO.grid.MonthGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),writePermission:false,scrollOffset:22,gridEvents:{},weekNumberWidth:16,initComponent:function(){this.autoScroll=true;this.addEvents({showday:true,create:true,move:true,eventResize:true,eventDblClick:true});if(this.store){this.setStore(this.store,true)}if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate;GO.grid.MonthGrid.superclass.initComponent.call(this)},afterRender:function(){GO.grid.MonthGrid.superclass.afterRender.call(this);this.setDate(this.startDate,false);this.body.unselectable();this.setStore(this.store);this.initDD()},renderMonthView:function(){this.body.update("");var K=this.configuredDate.format("Ym");var D=new Date();var G=D.format("Ymd");var L=0;var H="";var A;this.cellWrap=Ext.DomHelper.append(this.body,{tag:"div"},true);this.gridCells={};this.weekNumberCells=[];for(var N=0;N<this.days;N++){var E=this.startDate.add(Date.DAY,N);if(N==0||E.format("j")==1){A="j F"}else{A="j"}var J=E.format("w");var O=E.format("Ym");var F=E.format("Ymd");if(J==this.firstWeekday){var M=E.format("W");var P=Ext.DomHelper.append(this.cellWrap,{tag:"div",style:"width:"+(this.weekNumberWidth-1)+"px",cls:"cal-monthgrid-week-no"},true);var C=Ext.DomHelper.append(P,{tag:"a",cls:"x-monthGrid-cell-day-text",href:"#",id:"wl-"+F,html:M},true);C.on("click",this.onWeekClick,this);this.weekNumberCells.push(P)}if(F==G){H="cal-monthGrid-cell x-monthGrid-cell-today"}else{if(O==K&&(J==0||J==6)){H="cal-monthGrid-cell x-monthGrid-cell-weekend"}else{if(O==K){H="cal-monthGrid-cell x-monthGrid-cell-current"}else{H="cal-monthGrid-cell"}}}var B="d"+F;var P=Ext.DomHelper.append(this.cellWrap,{tag:"div",id:B,cls:H},true);var I=Ext.DomHelper.append(P,{tag:"a",cls:"x-monthGrid-cell-day-text",href:"#",html:E.format(A)},true);I.on("click",this.onAddClick,this);this.gridCells[F]=P}this.syncSize()},onMoreClick:function(D,C){var A=Ext.get(C).findParent("div.cal-monthGrid-cell",3);var B=Date.parseDate(A.id.substring(1,A.id.length),"Ymd");this.fireEvent("changeview",this,1,B)},onWeekClick:function(C,B){var A=Date.parseDate(B.id.substring(3,B.id.length),"Ymd");this.fireEvent("changeview",this,7,A)},onAddClick:function(D,C){var A=Ext.get(C).findParent("div.cal-monthGrid-cell",3);var B=Date.parseDate(A.id.substring(1,A.id.length),"Ymd");this.fireEvent("create",this,B)},onResize:function(D,B,A,C){Ext.grid.GridPanel.superclass.onResize.apply(this,arguments);this.syncSize();this.checkOverflow()},calcCellSize:function(B,A){this.cellHeight=(B.height/(this.days/7));if(this.cellHeight<100){this.cellHeight=100;if(!A){B.width-=this.scrollOffset}}this.cellWidth=((B.width-this.weekNumberWidth)/7);if(this.cellWidth<100){this.cellWidth=100;B.height-=this.scrollOffset;if(!A){this.calcCellSize(B,true)}}this.cellHeight=Math.floor(this.cellHeight);this.cellWidth=Math.floor(this.cellWidth)},checkOverflow:function(){if(this.overflowIndicators){for(var A=0;A<this.overflowIndicators.length;A++){this.overflowIndicators[A].remove()}}this.overflowIndicators=[];for(var A in this.gridCells){if(this.gridCells[A].dom.scrollHeight>this.gridCells[A].dom.clientHeight){var B=Ext.DomHelper.append(this.gridCells[A],{tag:"a",cls:"cal-overflow-indicator",href:"#",html:GO.lang.more+"..."},true);B.on("click",this.onMoreClick,this);var C=this.gridCells[A].getXY();B.setXY(C);this.overflowIndicators.push(B)}}},syncSize:function(){if(this.cellWrap){var B=this.container.getSize(true);this.calcCellSize(B);this.cellWrap.setSize(this.cellWidth*7+this.weekNumberWidth,this.cellHeight*(this.days/7));for(var A in this.gridCells){this.gridCells[A].setSize(this.cellWidth,this.cellHeight)}for(var A=0;A<this.weekNumberCells.length;A++){this.weekNumberCells[A].setHeight(this.cellHeight)}for(var C in this.gridEvents){for(var A=0;A<this.gridEvents[C].length;A++){this.gridEvents[C][A].setWidth(this.cellWidth-3)}}}},initDD:function(){var A=new GO.calendar.dd.MonthDragZone(this.body,{ddGroup:"month-grid",scroll:false,monthGrid:this});var B=new GO.calendar.dd.MonthDropTarget(this.body,{ddGroup:"month-grid",onNotifyDrop:function(C,H,G){var I=G.dragDate.format("U");var F=G.dropDate.format("U");offsetDays=Math.round((F-I)/86400);var E={offsetDays:offsetDays,dragDate:G.dragDate};var D=this.elementToEvent(G.item.id);if(D.repeats){this.handleRecurringEvent("move",D,E)}else{this.fireEvent("move",this,D,E);this.removeEvent(D.domId);delete D.domId;D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addMonthGridEvent(D)}},scope:this})},setStore:function(A,B){if(!B&&this.store){this.store.un("beforeload",this.reload);this.store.un("datachanged",this.reload);this.store.un("clear",this.reload)}if(A){A.on("beforeload",this.mask,this);A.on("datachanged",this.reload,this);A.on("clear",this.reload,this)}this.store=A},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)},getFirstDateOfWeek:function(A){var B=A.getDay();if(B<this.firstWeekday){B=7}return A.add(Date.DAY,this.firstWeekday-B)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);if(B){B.addClass("x-calGrid-selected");this.selected.push(B)}}}},addMonthGridEvent:function(K){var G=Date.parseDate(K.startDate.format("Ymd"),"Ymd");var B=Date.parseDate(K.endDate.format("Ymd"),"Ymd");var H=G.format("U");var J=B.format("U");var I=Math.round((J-H)/86400)+1;for(var F=0;F<I;F++){var E=G.add(Date.DAY,F);K.domId=Ext.id();if(I>1){if(!this.domIds[K.id]){this.domIds[K.id]=[]}this.domIds[K.id].push(K.domId)}var C=Ext.get("d"+E.format("Ymd"));if(C){var L="";if(K.startDate.format("G")!="0"){L+=K.startDate.format(GO.settings.time_format)+"&nbsp;"}L+=K.name;var A=Ext.DomHelper.append(C,{tag:"div",id:K.domId,cls:"x-calGrid-month-event-container",style:"background-color:#"+K.background+";width:"+(this.eventWidth)+"px",html:L,qtip:GO.calendar.formatQtip(K),qtitle:K.name},true);var D=E.format("Ymd");if(!this.gridEvents[D]){this.gridEvents[D]=[]}this.gridEvents[D].push(A);this.registerEvent(K.domId,K);A.on("mousedown",function(N,M){M=Ext.get(M).findParent("div.x-calGrid-month-event-container",2,true);this.selectEventElement(M);this.clickedEventId=M.id},this);A.on("dblclick",function(O,M){M=Ext.get(M).findParent("div.x-calGrid-month-event-container",2,true);var N=this.elementToEvent(this.clickedEventId);if(N.repeats&&this.writePermission){this.handleRecurringEvent("eventDblClick",N,{})}else{this.fireEvent("eventDblClick",this,N,{singleInstance:this.writePermission})}},this)}}if(!this.loading){this.checkOverflow()}return K.domId},removeEvent:function(D){var C=this.getRelatedDomElements(D);if(C){for(var A=0;A<C.length;A++){var B=Ext.get(C[A]);if(B){B.removeAllListeners();B.remove()}this.unregisterDomId(C[A])}}this.checkOverflow()},unregisterDomId:function(D){delete this.remoteEvents[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.editRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var D=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,D,this.currentActionData);if(this.currentActionData.offsetDays){this.removeEvent(D.domId);D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addMonthGridEvent(D)}this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.gridEvents={};this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDate:function(C,H){var D=this.startDate;var F=this.endDate;this.configuredDate=C;var I=C.getFirstDateOfMonth();var G=C.getLastDateOfMonth();this.startDate=this.getFirstDateOfWeek(I);var B=this.startDate.format("U");var E=G.format("U");var A=((E-B)/86400)+1;var J=Math.ceil(A/7);this.days=J*7;this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(!F||!D||F.getElapsed(this.endDate)!=0||D.getElapsed(this.startDate)!=0){if(H){this.store.reload()}else{this.loadRequired=true}}},reload:function(){this.load()},load:function(){if(this.rendered){this.loading=true;this.clearGrid();this.renderMonthView();this.writePermission=this.store.reader.jsonData.write_permission;var C=this.store.getRange();for(var D=0,B=C.length;D<B;D++){var A=Date.parseDate(C[D].data.start_time,this.dateTimeFormat);var F=Date.parseDate(C[D].data.end_time,this.dateTimeFormat);var E=C[D].data;E.startDate=A;E.endDate=F;this.addMonthGridEvent(E)}this.checkOverflow();this.unmask();this.loading=false;this.loadRequired=false}},registerEvent:function(B,A){this.remoteEvents[B]=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){this.remoteEvents[A]["domId"]=A;return this.remoteEvents[A]}});GO.calendar.dd.MonthDragZone=function(B,A){A=A||{};Ext.apply(A,{ddel:document.createElement("div")});GO.calendar.dd.MonthDragZone.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.MonthDragZone,Ext.dd.DragZone,{onInitDrag:function(C){if(!this.monthGrid.writePermission||this.monthGrid.remoteEvents[this.dragData.item.id]["private"]){return false}else{this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.monthGrid.getRelatedDomElements(this.dragData.item.id);var D=Ext.get(this.dragData.item).findParent("div.cal-monthGrid-cell",3,true);this.eventProxies=[];this.proxyDragPos=0;for(var A=0;A<this.eventDomElements.length;A++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-calGrid-month-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[A]==this.dragData.item.id){this.proxyDragPos=A}else{var B=Ext.get(this.eventDomElements[A]);if(B){B.setStyle({position:"absolute",top:-10000,display:"none"})}}}}},removeEventProxies:function(){var A=Ext.query("div.x-calGrid-month-event-proxy");for(var B=0;B<A.length;B++){Ext.get(A[B]).remove()}delete this.lastTdOverId;for(var B=0;B<this.eventDomElements.length;B++){var C=Ext.get(this.eventDomElements[B]);if(C){C.setStyle({position:"static",top:"",display:"block"})}}},afterRepair:function(){GO.calendar.dd.MonthDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(B,A){A.item.highlight("#e8edff");return A.item.getXY()},getDragData:function(C){if(!this.monthGrid.writePermission){return false}else{var B=Ext.get(C.getTarget());var D=B.parent();var A=Date.parseDate(D.id.substr(1),"Ymd");if(B.hasClass("x-calGrid-month-event-container")&&!this.monthGrid.remoteEvents[B.id]["private"]){return{ddel:this.ddel,item:B,dragDate:A}}else{return false}}}});GO.calendar.dd.MonthDropTarget=function(B,A){GO.calendar.dd.MonthDropTarget.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.MonthDropTarget,Ext.dd.DropTarget,{notifyDrop:function(A,E,C){if(!this.scope.writePermission){return false}else{var D=Ext.get(E.getTarget()).findParent("div.cal-monthGrid-cell",3,true);C.dropDate=Date.parseDate(D.id.substr(1),"Ymd");A.removeEventProxies();this.el.removeClass(this.overClass);D.appendChild(C.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var B=this.onNotifyDrop.createDelegate(this.scope);B.call(this,A,E,C)}return true}},notifyOver:function(B,G,F){var E=Ext.get(G.getTarget()).findParent("div.cal-monthGrid-cell",3,true);if(E){if(B.lastTdOverId!=E.id){var A=E;for(var C=0;C<B.proxyDragPos;C++){if(A){var D=A.prev("div.cal-monthGrid-cell");A=D}if(D){B.eventProxies[C].insertAfter(D.first());B.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{B.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}B.eventProxies[C].insertAfter(E.first());var A=E;for(var C=B.proxyDragPos+1;C<B.eventProxies.length;C++){if(A){var D=A.next("div.cal-monthGrid-cell");A=D}if(D){B.eventProxies[C].insertAfter(D.first());B.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{B.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}}B.lastTdOverId=E.id}return this.dropAllowed}});GO.calendar.ListGrid=function(B){if(!B){B={}}B.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"id",fields:["id","event_id","name","time","start_time","end_time","description","location","private","repeats","background","day"]}),baseParams:{task:"events"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"},remoteGroup:true});B.paging=false,B.autoExpandColumn="listview-calendar-name-heading";B.autoExpandMax=2500;B.enableColumnHide=false;B.enableColumnMove=false;B.autoScroll=true;B.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:80,renderer:function(D,E,C){return'<div style="border:1px solid #c0c0c0;padding:2px;margin:2px;background-color:#'+C.data.background+';">'+D+"</div>"}},{id:"listview-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];B.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+GO.lang.items+'" : "'+GO.lang.item+'"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});B.sm=new Ext.grid.RowSelectionModel({singleSelect:true});B.loadMask=true;GO.calendar.ListGrid.superclass.constructor.call(this,B);if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate};Ext.extend(GO.calendar.ListGrid,Ext.grid.GridPanel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,days:7,renderName:function(B,C,A){return'<div style="font-weight:bold;">'+A.data.name+"</div>"+GO.calendar.formatQtip(A.data)},afterRender:function(){GO.calendar.ListGrid.superclass.afterRender.call(this);this.on("rowdblclick",function(B,D,C){var A=B.getStore().getAt(D);GO.calendar.eventDialog.show({event_id:A.data.event_id})},this)},getFirstDateOfWeek:function(A){var B=A.getDay();var C=this.firstWeekday-B;if(C>0){C-=7}return A.add(Date.DAY,C)},setDays:function(B,A){this.setDate(this.configuredDate,7,A)},getSelectedEvent:function(){var C=this.getSelectionModel();var A=C.getSelected();var B=A.data;B.startDate=Date.parseDate(B.start_time,this.dateTimeFormat);B.endDate=Date.parseDate(B.end_time,this.dateTimeFormat);return B},removeEvent:function(){var B=this.getSelectionModel();var A=B.getSelected();this.store.remove(A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);this.setStoreBaseParams();if(D){this.store.reload()}},setStoreBaseParams:function(){this.store.baseParams.start_time=this.startDate.format(this.dateTimeFormat);this.store.baseParams.end_time=this.endDate.format(this.dateTimeFormat)}});GO.grid.ViewGrid=Ext.extend(Ext.Panel,{dateFormat:"Y-m-d",dateTimeFormat:"Y-m-d H:i",timeFormat:"H:i",firstWeekday:1,configuredDate:false,startDate:false,dragEvent:false,appointments:Array(),remoteEvents:Array(),domIds:Array(),days:1,selected:Array(),view_id:0,gridCells:Array(),initComponent:function(){GO.grid.ViewGrid.superclass.initComponent.call(this);this.addEvents({create:true,move:true,eventResize:true,eventDblClick:true,zoom:true});if(!this.startDate){var A=new Date();this.startDate=Date.parseDate(A.format(this.dateFormat),this.dateFormat)}this.configuredDate=this.startDate},setViewId:function(A){this.view_id=A},onRender:function(B,A){GO.grid.ViewGrid.superclass.onRender.apply(this,arguments);this.setDate(this.startDate,false);this.body.setStyle("overflow","hidden");this.body.unselectable();this.initDD()},renderView:function(){this.body.update("");var H=this.container.getSize(true);var C=(H.width-150)/this.days;this.headingsTable=Ext.DomHelper.append(this.body,{tag:"table",id:Ext.id(),cls:"x-calGrid-headings-table",style:"width:"+H.width+"px;"},true);var F=Ext.DomHelper.append(this.headingsTable,{tag:"tbody"},true);this.headingsRow=Ext.DomHelper.append(F,{tag:"tr",children:{tag:"td",style:"width:147px",cls:"x-calGrid-heading"}},true);var E=GO.settings.date_format.indexOf("Y");var B="D "+GO.settings.date_format.substring(0,E-1);for(var J=0;J<this.days;J++){var D=this.startDate.add(Date.DAY,J);var N=Ext.DomHelper.append(this.headingsRow,{tag:"td",cls:"x-calGrid-heading",style:"width:"+(C)+"px",html:D.format(B)})}Ext.DomHelper.append(this.headingsRow,{tag:"td",style:"width:"+(this.scrollOffset-3)+"px;height:0px",cls:"x-calGrid-heading"});this.gridContainer=Ext.DomHelper.append(this.body,{tag:"div",cls:"x-calGrid-grid-container"},true);var M=this.headingsTable.getHeight();var A=H.height-M;this.gridContainer.setSize(H.width,A);this.gridTable=Ext.DomHelper.append(this.gridContainer,{tag:"table",id:Ext.id(),cls:"x-viewGrid-table",style:"width:"+H.width-this.scrollWidth+"px;"},true);this.tbody=Ext.DomHelper.append(this.gridTable,{tag:"tbody"},true);this.gridCells={};for(var G in this.jsonData){var K=Ext.DomHelper.append(this.tbody,{tag:"tr"});var L=Ext.DomHelper.append(K,{tag:"td",cls:"x-viewGrid-calendar-name-cell",style:"width:150px"},true);var I=Ext.DomHelper.append(L,{tag:"a",id:"view_cal_"+G,href:"#",cls:"normal-link",html:this.jsonData[G].name},true);I.on("click",function(P,O){P.preventDefault();this.fireEvent("zoom",{calendar_id:O.id.substring(9)})},this);this.gridCells[G]={};for(var J=0;J<this.days;J++){var D=this.startDate.add(Date.DAY,J);this.gridCells[G][D.format("Ymd")]=Ext.DomHelper.append(K,{tag:"td",id:"cal"+this.jsonData[G].id+"_day"+D.format("Ymd"),cls:"x-viewGrid-cell",style:"width:"+C+"px"},true)}}},removeEvent:function(D){var C=this.getRelatedDomElements(D);if(C){for(var A=0;A<C.length;A++){var B=Ext.get(C[A]);if(B){B.removeAllListeners();B.remove()}this.unregisterDomId(C[A])}}},unregisterDomId:function(D){delete this.remoteEvents[D];var B=false;for(var C in this.domIds){for(var A=0;A<this.domIds[C].length;A++){if(this.domIds[C][A]==D){this.domIds[C].splice(A,1);B=true;break}}if(B){break}}},setNewEventId:function(B,A){this.remoteEvents[B].event_id=A},initDD:function(){var A=new GO.calendar.dd.ViewDragZone(this.body,{ddGroup:"view-grid",scroll:false,viewGrid:this});var B=new GO.calendar.dd.ViewDropTarget(this.body,{ddGroup:"view-grid",onNotifyDrop:function(C,H,G){var I=G.dragDate.format("U");var F=G.dropDate.format("U");offsetDays=Math.round((F-I)/86400);var E={offsetDays:offsetDays,dragDate:G.dragDate,calendar_id:G.calendar_id};var D=this.elementToEvent(G.item.id);if(D.repeats){this.handleRecurringEvent("move",D,E)}else{this.fireEvent("move",this,D,E);this.removeEvent(D.domId);delete D.domId;D.repeats=false;D.calendar_id=G.calendar_id;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addViewGridEvent(D)}},scope:this})},onResize:function(D,B,A,C){if(this.viewGridTable){this.viewGridTable.setSize(D,B)}},getFirstDateOfWeek:function(A){var B=A.getDay();var C=this.firstWeekday-B;if(C>0){C-=7}return A.add(Date.DAY,C)},mask:function(){if(this.rendered){this.body.mask(GO.lang.waitMsgLoad,"x-mask-loading")}},unmask:function(){if(this.rendered){this.body.unmask()}},getSelectedEvent:function(){if(this.selected){return this.elementToEvent(this.selected[0].id)}},isSelected:function(A){for(var B=0;B<this.selected.length;B++){if(this.selected[B].id==A){return true}}return false},clearSelection:function(){for(var A=0;A<this.selected.length;A++){this.selected[A].removeClass("x-calGrid-selected")}this.selected=[]},selectEventElement:function(A){if(!this.isSelected(A)){this.clearSelection();var D=this.getRelatedDomElements(A.id);for(var C=0;C<D.length;C++){var B=Ext.get(D[C]);if(B){B.addClass("x-calGrid-selected");this.selected.push(B)}}}},addViewGridEvent:function(K){var G=Date.parseDate(K.startDate.format("Ymd"),"Ymd");var B=Date.parseDate(K.endDate.format("Ymd"),"Ymd");var H=G.format("U");var J=B.format("U");var I=Math.round((J-H)/86400)+1;for(var F=0;F<I;F++){var D=G.add(Date.DAY,F);var E=K.domId?K.domId:Ext.id();if(I>1){if(!this.domIds[K.id]){this.domIds[K.id]=[]}this.domIds[K.id].push(E)}var C=this.gridCells[K.calendar_id][D.format("Ymd")];if(C){var L="";if(K.startDate.format("G")!="0"){L+=K.startDate.format(GO.settings.time_format)+"&nbsp;"}L+=K.name;var A=Ext.DomHelper.append(C,{tag:"div",id:E,cls:"x-viewGrid-event-container",style:"background-color:#"+K.background,html:L,qtitle:K.name,qtip:GO.calendar.formatQtip(K)},true);this.registerEvent(E,K);A.on("mousedown",function(N,M){M=Ext.get(M).findParent("div.x-viewGrid-event-container",2,true);this.selectEventElement(M);this.clickedEventId=M.id},this);A.on("dblclick",function(O,M){M=Ext.get(M).findParent("div.x-viewGrid-event-container",2,true);var N=this.elementToEvent(this.clickedEventId);if(N.repeats&&N.write_permission){this.handleRecurringEvent("eventDblClick",N,{})}else{this.fireEvent("eventDblClick",this,N,{singleInstance:N.write_permission})}},this)}}return E},removeEventFromArray:function(A,C){for(var B=0;B<this.appointments[A].length;B++){if(this.appointments[A][B].id==C){return this.appointments[A].splice(B,1)}}return false},inAppointmentsArray:function(C,B){for(var A=0;A<B.length;A++){if(B[A].id==C){return true}}return false},handleRecurringEvent:function(A,C,B){this.currentRecurringEvent=C;this.currentFireEvent=A;this.currentActionData=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,title:GO.calendar.lang.recurringEvent,modal:false,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){this.currentActionData.singleInstance=true;var D=this.currentRecurringEvent;this.fireEvent(this.currentFireEvent,this,D,this.currentActionData);this.removeEvent(D.domId);D.calendar_id=this.currentActionData.calendar_id;D.repeats=false;D.startDate=D.startDate.add(Date.DAY,offsetDays);D.endDate=D.endDate.add(Date.DAY,offsetDays);D.start_time=D.startDate.format("U");D.end_time=D.endDate.format("U");this.addViewGridEvent(D);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){this.currentActionData.singleInstance=false;this.fireEvent(this.currentFireEvent,this,this.currentRecurringEvent,this.currentActionData);this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()},clearGrid:function(){this.appointments=Array();this.remoteEvents=Array();this.domIds=Array()},setDays:function(B,A){this.setDate(this.configuredDate,B,A)},setDate:function(A,E,D){var C=this.startDate;var B=this.endDate;if(E){this.days=E}this.configuredDate=A;if(this.days>4){this.startDate=this.getFirstDateOfWeek(A)}else{this.startDate=A}this.endDate=this.startDate.add(Date.DAY,this.days);if(D){this.reload()}},reload:function(){this.load()},load:function(A){if(!A){A={}}A.task="view_events";A.view_id=this.view_id;A.start_time=this.startDate.format(this.dateTimeFormat);A.end_time=this.endDate.format(this.dateTimeFormat);this.mask();Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:A,callback:function(C,H,B){if(!H){Ext.MessageBox.alert(GO.lang.strError,B.result.feedback)}else{this.jsonData=Ext.decode(B.responseText);this.clearGrid();this.renderView();for(var G in this.jsonData){var E=this.jsonData[G].events;for(var D=0;D<E.length;D++){var F=E[D];F.startDate=Date.parseDate(E[D]["start_time"],this.dateTimeFormat);F.endDate=Date.parseDate(E[D]["end_time"],this.dateTimeFormat);this.addViewGridEvent(F)}}}this.unmask()},scope:this})},registerEvent:function(B,A){this.remoteEvents[B]=A},getEventDomElements:function(A){return GO.util.clone(this.domIds[A])},getRelatedDomElements:function(C){var B=this.remoteEvents[C];if(!B){return false}var A=this.getEventDomElements(B.id);if(!A){A=[C]}return A},elementToEvent:function(A,B){this.remoteEvents[A].domId=A;return this.remoteEvents[A]}});GO.calendar.dd.ViewDragZone=function(B,A){A=A||{};Ext.apply(A,{ddel:document.createElement("div")});GO.calendar.dd.ViewDragZone.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.ViewDragZone,Ext.dd.DragZone,{onInitDrag:function(C){this.ddel.innerHTML=this.dragData.item.dom.innerHTML;this.ddel.className=this.dragData.item.dom.className;this.ddel.style.width=this.dragData.item.getWidth()+"px";this.proxy.update(this.ddel);this.eventDomElements=this.viewGrid.getRelatedDomElements(this.dragData.item.id);var D=Ext.get(this.dragData.item).findParent("td",10,true);this.eventProxies=[];this.proxyDragPos=0;for(var A=0;A<this.eventDomElements.length;A++){this.eventProxies.push(Ext.DomHelper.append(document.body,{tag:"div",id:Ext.id(),cls:"x-viewGrid-event-proxy",style:"width:"+this.ddel.style.width+"px;"},true));if(this.eventDomElements[A]==this.dragData.item.id){this.proxyDragPos=A}else{var B=Ext.get(this.eventDomElements[A]);if(B){B.setStyle({position:"absolute",top:-10000,display:"none"})}}}},removeEventProxies:function(){var A=Ext.query("div.x-viewGrid-event-proxy");for(var B=0;B<A.length;B++){Ext.get(A[B]).remove()}delete this.lastTdOverId;for(var B=0;B<this.eventDomElements.length;B++){var C=Ext.get(this.eventDomElements[B]);if(C){C.setStyle({position:"static",top:"",display:"block"})}}},afterRepair:function(){GO.calendar.dd.ViewDragZone.superclass.afterRepair.call(this);this.removeEventProxies()},getRepairXY:function(B,A){A.item.highlight("#e8edff");return A.item.getXY()},getDragData:function(F){var E=Ext.get(F.getTarget());if(E.hasClass("x-viewGrid-event-container")){var G=E.parent();var A=G.id.indexOf("_day")+4;var D=G.id.substr(3,A-7);if(!this.viewGrid.remoteEvents[E.id]["private"]&&this.viewGrid.jsonData[D].write_permission){var B=G.id.substr(A);var C=Date.parseDate(B,"Ymd");return{ddel:this.ddel,item:E,dragDate:C}}return false}}});GO.calendar.dd.ViewDropTarget=function(B,A){GO.calendar.dd.ViewDropTarget.superclass.constructor.call(this,B,A)};Ext.extend(GO.calendar.dd.ViewDropTarget,Ext.dd.DropTarget,{notifyDrop:function(B,G,F){var H=Ext.get(G.getTarget()).findParent("td",10,true);if(!H){return false}var A=H.id.indexOf("_day")+4;var D=H.id.substr(3,A-7);if(!this.scope.jsonData[D]||!this.scope.jsonData[D].write_permission){return false}var C=H.id.substr(A);F.dropDate=Date.parseDate(C,"Ymd");F.calendar_id=H.id.substr(3,A-7);B.removeEventProxies();this.el.removeClass(this.overClass);H.appendChild(F.item);if(this.onNotifyDrop){if(!this.scope){this.scope=this}var E=this.onNotifyDrop.createDelegate(this.scope);E.call(this,B,G,F)}return true},notifyOver:function(G,E,B){var F=Ext.get(E.getTarget()).findParent("td.x-viewGrid-cell",10,true);if(F){var I=F.id.indexOf("_day");var D=F.id.substr(3,I-3);if(this.scope.jsonData[D]&&this.scope.jsonData[D].write_permission){if(G.lastTdOverId!=F.id){var H=F;for(var C=0;C<G.proxyDragPos;C++){if(H){var A=H.prev("td.x-viewGrid-cell");H=A}if(A){A.insertFirst(G.eventProxies[C].id);G.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{G.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}F.insertFirst(G.eventProxies[C].id);var H=F;for(var C=G.proxyDragPos+1;C<G.eventProxies.length;C++){if(H){var A=H.next("td.x-viewGrid-cell");H=A}if(A){A.insertFirst(G.eventProxies[C].id);G.eventProxies[C].setStyle({position:"static",top:"",display:"block"})}else{G.eventProxies[C].setStyle({position:"absolute",top:-10000,display:"none"})}}}G.lastTdOverId=F.id;return this.dropAllowed}}return false}});GO.calendar.CalendarDialog=function(A){if(!A){A={}}this.propertiesTab=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.calendar["write_permission"],value:GO.settings.user_id,anchor:"100%"}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false,anchor:"100%"},this.exportButton=new Ext.Button({text:GO.lang.cmdExport,disabled:true,handler:function(){document.location=GO.settings.modules.calendar.url+"export.php?calendar_id="+this.calendar_id},scope:this})]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});var B=new GO.form.UploadFile({inputName:"ical_file",max:1});B.on("filesChanged",function(D,C){this.importButton.setDisabled(C.getCount()==1)},this);this.importTab=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,disabled:true,title:GO.lang.cmdImport,items:[{xtype:"panel",html:GO.calendar.lang.selectIcalendarFile,border:false},B,this.importButton=new Ext.Button({xtype:"button",disabled:true,text:GO.lang.cmdImport,handler:function(){this.importTab.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.calendar.url+"action.php",params:{task:"import",calendar_id:this.calendar_id},success:function(C,D){B.clearQueue();if(D.result.success){Ext.MessageBox.alert(GO.lang.strSuccess,D.result.feedback)}else{Ext.MessageBox.alert(GO.lang.strError,D.result.feedback)}},failure:function(C,D){Ext.MessageBox.alert(GO.lang.strError,D.result.feedback)},scope:this})},scope:this})],cls:"go-form-panel"});this.tabPanel=new Ext.TabPanel({hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab,this.importTab]});GO.calendar.CalendarDialog.superclass.constructor.call(this,{title:GO.calendar.lang.calendar,layout:"fit",modal:false,height:500,width:450,closeAction:"hide",items:this.tabPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.CalendarDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.CalendarDialog.superclass.initComponent.call(this)},show:function(A){if(!this.rendered){this.render(Ext.getBody())}this.propertiesTab.show();if(A>0){if(A!=this.calendar_id){this.loadCalendar(A)}else{GO.calendar.CalendarDialog.superclass.show.call(this)}}else{this.calendar_id=0;this.propertiesTab.form.reset();this.exportButton.setDisabled(true);this.importTab.setDisabled(true);this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);GO.calendar.CalendarDialog.superclass.show.call(this)}},loadCalendar:function(A){this.propertiesTab.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{calendar_id:A,task:"calendar"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.calendar_id=A;this.selectUser.setRawValue(C.result.data.user_name);this.readPermissionsTab.setAcl(C.result.data.acl_read);this.writePermissionsTab.setAcl(C.result.data.acl_write);this.exportButton.setDisabled(false);this.importTab.setDisabled(false);GO.calendar.CalendarDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})},save:function(A){this.propertiesTab.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_calendar",calendar_id:this.calendar_id},waitMsg:GO.lang.waitMsgSave,success:function(B,C){if(C.result.calendar_id){this.calendar_id=C.result.calendar_id;this.readPermissionsTab.setAcl(C.result.acl_read);this.writePermissionsTab.setAcl(C.result.acl_write);this.exportButton.setDisabled(false);this.importTab.setDisabled(false)}this.fireEvent("save");if(A){this.hide()}},failure:function(C,D){var B="";if(D.failureType=="client"){B=GO.lang.strErrorsInForm}else{B=D.result.feedback}Ext.MessageBox.alert(GO.lang.strError,B)},scope:this})}});GO.calendar.ViewDialog=function(B){if(!B){B={}}var A=new GO.grid.CheckColumn({header:GO.lang.strSelected,dataIndex:"selected",width:55});this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"view_calendars",view_id:this.view_id},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name","selected"],remoteSort:true});this.calendarsGrid=new GO.grid.GridPanel({region:"center",layout:"fit",paging:false,border:false,plugins:A,store:this.calendarsStore,columns:[A,{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true});this.propertiesTab=new Ext.Panel({title:GO.lang.strProperties,layout:"border",items:[new Ext.Panel({layout:"form",region:"north",height:70,defaultType:"textfield",defaults:{anchor:"100%"},cls:"go-form-panel",waitMsgTarget:true,labelWidth:75,border:false,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.calendar["write_permission"]}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false}]}),this.calendarsGrid]});this.readPermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strReadPermissions});this.writePermissionsTab=new GO.grid.PermissionsPanel({title:GO.lang.strWritePermissions});this.formPanel=new Ext.form.FormPanel({url:GO.settings.modules.calendar.url+"action.php",defaultType:"textfield",waitMsgTarget:true,border:false,items:[{hideLabel:true,deferredRender:false,xtype:"tabpanel",activeTab:0,border:false,anchor:"100% 100%",items:[this.propertiesTab,this.readPermissionsTab,this.writePermissionsTab]}]});GO.calendar.ViewDialog.superclass.constructor.call(this,{title:GO.lang.strView,layout:"fit",modal:false,height:500,width:400,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.calendar.ViewDialog,Ext.Window,{initComponent:function(){this.addEvents({save:true});GO.calendar.ViewDialog.superclass.initComponent.call(this)},show:function(A){if(!this.rendered){this.render(Ext.getBody())}if(A>0){if(A!=this.view_id){this.loadView(A)}}else{this.view_id=0;this.formPanel.form.reset();this.propertiesTab.show();this.readPermissionsTab.setDisabled(true);this.writePermissionsTab.setDisabled(true);this.calendarsStore.baseParams.view_id=0;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)}},loadView:function(A){this.formPanel.form.load({url:GO.settings.modules.calendar.url+"json.php",params:{view_id:A,task:"view"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.view_id=A;this.selectUser.setRawValue(C.result.data.user_name);this.readPermissionsTab.setAcl(C.result.data.acl_read);this.writePermissionsTab.setAcl(C.result.data.acl_write);this.calendarsStore.baseParams.view_id=A;this.calendarsStore.reload();GO.calendar.ViewDialog.superclass.show.call(this)},failure:function(B,C){Ext.Msg.alert(GO.lang.strError,C.result.feedback)},scope:this})},save:function(B){var C=[];for(var A=0;A<this.calendarsStore.data.items.length;A++){if(this.calendarsStore.data.items[A].get("selected")=="1"){C.push(this.calendarsStore.data.items[A].get("id"))}}this.formPanel.form.submit({url:GO.settings.modules.calendar.url+"action.php",params:{task:"save_view",view_id:this.view_id,view_calendars:Ext.encode(C)},waitMsg:GO.lang.waitMsgSave,success:function(D,E){if(E.result.view_id){this.view_id=E.result.view_id;this.readPermissionsTab.setAcl(E.result.acl_read);this.writePermissionsTab.setAcl(E.result.acl_write)}this.fireEvent("save");if(B){this.hide()}},failure:function(E,F){var D="";if(F.failureType=="client"){D=GO.lang.strErrorsInForm}else{D=F.result.feedback}Ext.MessageBox.alert(GO.lang.strError,D)},scope:this})}});GO.calendar.formatQtip=function(B){var D="Y-m-d H:i";if(!B.startDate){B.startDate=Date.parseDate(B.start_time,D)}if(!B.endDate){B.endDate=Date.parseDate(B.end_time,D)}var A=GO.settings.time_format;if(B.startDate.format("Ymd")!=B.endDate.format("Ymd")){A=GO.settings.date_format+" "+GO.settings.time_format}var C=GO.calendar.lang.startsAt+": "+B.startDate.format(A)+"<br />"+GO.calendar.lang.endsAt+": "+B.endDate.format(A);if(B.location!=""){C+="<br />"+GO.calendar.lang.location+": "+B.location}if(B.description!=""){C+="<br /><br />"+B.description}return C};GO.calendar.MainPanel=function(A){if(!A){A={}}var C=new Ext.DatePicker();C.on("select",function(F,G){this.setDisplay({date:G})},this);this.calendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.viewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarList=new GO.calendar.CalendarList({store:this.calendarsStore});this.viewsList=new GO.calendar.ViewList({store:this.viewsStore});this.calendarList.on("click",function(F,G){this.viewsList.clearSelections();this.setDisplay({calendar_id:F.store.data.items[G].id,saveState:true})},this);this.calendarList.on("selectionchange",function(F,G){if(G.length){this.calendarTitle.td.innerHTML=G[0].innerHTML}},this);this.viewsList.on("click",function(F,G){this.calendarList.clearSelections();this.setDisplay({view_id:F.store.data.items[G].id,saveState:true})},this);this.viewsList.on("selectionchange",function(F,G){if(G.length){this.calendarTitle.td.innerHTML=G[0].innerHTML}},this);this.daysGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","description","repeats","private","location","background"]});this.monthGridStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"events"},root:"results",id:"id",fields:["id","event_id","name","start_time","end_time","description","repeats","private","location","background"]});this.daysGrid=new GO.grid.CalendarGrid({id:"days-grid",store:this.daysGridStore,border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.monthGrid=new GO.grid.MonthGrid({id:"month-grid",store:this.monthGridStore,border:false,layout:"fit",firstWeekday:parseInt(GO.settings.first_weekday)});this.viewGrid=new GO.grid.ViewGrid({id:"view-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.viewGrid.on("zoom",function(F){this.viewsList.clearSelections();this.calendarList.select("calendar-"+F.calendar_id);this.setDisplay(F)},this);this.listGrid=new GO.calendar.ListGrid({id:"list-grid",border:false,firstWeekday:parseInt(GO.settings.first_weekday)});this.listStore=this.listGrid.store;var D=new Ext.Panel({region:"center",title:GO.calendar.lang.navigation,border:true,items:[this.calendarList,this.viewsList],autoScroll:true,split:true});this.displayPanel=new Ext.Panel({region:"center",titlebar:false,autoScroll:false,layout:"card",activeItem:0,border:true,split:true,cls:"cal-display-panel",tbar:[this.calendarTitle=new Ext.Toolbar.TextItem({text:"Calendar"}),"-",{iconCls:"btn-left-arrow",text:GO.lang.cmdPrevious,cls:"x-btn-text-icon",handler:function(){var F=this.getActivePanel().configuredDate;if(this.displayType=="month"){F=F.add(Date.MONTH,-1)}else{var G=this.days>4?7:1;F=F.add(Date.DAY,-G)}this.setDisplay({date:F})},scope:this},this.periodInfoPanel=new Ext.Panel({html:"",plain:true,border:true,cls:"cal-period"}),{iconCls:"btn-right-arrow",text:GO.lang.cmdNext,cls:"x-btn-text-icon",handler:function(){var F=this.getActivePanel().configuredDate;if(this.displayType=="month"){F=F.add(Date.MONTH,1)}else{var G=this.days>4?7:1;F=F.add(Date.DAY,G)}this.setDisplay({date:F})},scope:this}],keys:[{key:Ext.EventObject.DELETE,fn:this.deleteHandler,scope:this}],items:[this.daysGrid,this.monthGrid,this.viewGrid,this.listGrid]});A.keys=[{key:Ext.EventObject.DELETE,fn:this.deleteHandler,scope:this},{key:Ext.EventObject.ENTER,fn:function(){alert("hoi")}}];var E=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){GO.calendar.eventDialog.show({calendar_id:this.displayType!="view"?this.calendar_id:0})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:this.deleteHandler,scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){this.init()},scope:this},{iconCls:"btn-settings",text:GO.lang.cmdSettings,cls:"x-btn-text-icon",handler:function(){this.showAdminDialog()},scope:this},"-",this.dayButton=new Ext.Button({iconCls:"btn-one-day",text:GO.calendar.lang.oneDay,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:1,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.workWeekButton=new Ext.Button({iconCls:"btn-five-days",text:GO.calendar.lang.fiveDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:5,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.weekButton=new Ext.Button({iconCls:"btn-seven-days",text:GO.calendar.lang.sevenDays,cls:"x-btn-text-icon",handler:function(){this.setDisplay({days:7,displayType:this.displayType=="view"?"view":"days",saveState:true})},scope:this}),this.monthButton=new Ext.Button({iconCls:"btn-month",text:GO.calendar.lang.month,cls:"x-btn-text-icon",handler:function(){this.setDisplay({displayType:"month",saveState:true})},scope:this}),this.listButton=new Ext.Button({iconCls:"btn-list",text:GO.calendar.lang.list,cls:"x-btn-text-icon",handler:function(F,G){this.setDisplay({displayType:"list",saveState:true})},scope:this}),"-",this.printMessageButton=new Ext.Button({iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){var H=this.getActivePanel().startDate;var G=this.getActivePanel().endDate;var F=GO.settings.modules.calendar.url+"print.php?start_time="+H.format("U")+"&end_time="+G.format("U");if(this.displayType=="view"){F+="&view_id="+this.view_id}else{F+="&calendar_id="+this.calendar_id}document.location=F},scope:this})];for(var B=0;B<GO.calendar.extraToolbarItems.length;B++){E.push(GO.calendar.extraToolbarItems[B])}A.layout="border";A.border=false;A.items=[new Ext.Panel({region:"north",height:32,baseCls:"x-plain",tbar:new Ext.Toolbar({cls:"go-head-tb",items:E})}),new Ext.Panel({region:"west",titlebar:false,autoScroll:false,closeOnTab:true,width:210,split:true,layout:"border",border:false,plain:true,items:[new Ext.Panel({region:"north",border:true,height:194,split:true,baseCls:"x-plain",items:C}),D]}),this.displayPanel];GO.calendar.MainPanel.superclass.constructor.call(this,A)};Ext.extend(GO.calendar.MainPanel,Ext.Panel,{displayType:"days",lastCalendarDisplayType:"days",state:{},calendarId:0,viewId:0,onShow:function(){GO.calendar.MainPanel.superclass.onShow.call(this);this.daysGrid.scrollToLastPosition()},afterRender:function(){GO.calendar.MainPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(C,A){if(this.displayType=="list"){this.setDisplay()}else{var B=this.getActivePanel();if(C.repeats||(B.remoteEvents[A]&&B.remoteEvents[A].repeats&&B.remoteEvents[A].event_id==C.event_id)){B.store.reload()}else{B.removeEvent(A);switch(this.displayType){case"month":if(C.calendar_id==this.calendar_id){GO.calendar.eventDialog.oldDomId=this.monthGrid.addMonthGridEvent(C)}break;case"days":if(C.calendar_id==this.calendar_id){GO.calendar.eventDialog.oldDomId=this.daysGrid.addDaysGridEvent(C,true)}break;case"view":GO.calendar.eventDialog.oldDomId=this.viewGrid.addViewGridEvent(C);break}}}},this);this.state=Ext.state.Manager.get("calendar-state");if(!this.state){this.state={displayType:"days",days:5,calendar_id:0,view_id:0}}else{this.state=Ext.decode(this.state)}if(this.state.displayType=="view"){this.state.displayType="days"}this.state.calendar_id=GO.calendar.defaultCalendar.id;this.state.view_id=0;this.init();this.createDaysGrid()},init:function(){this.calendarsStore.load({callback:function(){if(this.state.displayType!="view"){if(this.state.calendar_id==0){this.state.calendar_id=this.calendarsStore.data.items[0].id}this.calendarList.select("calendar-"+this.state.calendar_id);this.setDisplay(this.state)}},scope:this});this.viewsStore.load({callback:function(){if(this.state.displayType=="view"){this.viewsList.select("view-"+this.state.view_id);this.setDisplay(this.state)}},scope:this})},deleteHandler:function(){switch(this.displayType){case"days":var A=this.daysGrid.getSelectedEvent();var B=function(D,C){if(C){this.daysGrid.store.reload()}else{this.daysGrid.removeEvent(D.domId)}};break;case"month":var A=this.monthGrid.getSelectedEvent();var B=function(D,C){if(C){this.monthGrid.store.reload()}else{this.monthGrid.removeEvent(D.domId)}};break;case"view":var A=this.viewGrid.getSelectedEvent();var B=function(D,C){if(C){this.viewGrid.reload()}else{this.viewGrid.removeEvent(D.domId)}};break;case"list":var A=this.listGrid.getSelectedEvent();var B=function(D,C){if(C){this.listGrid.store.reload()}else{this.listGrid.removeEvent()}};break}if(A){this.deleteEvent(A,B)}},getActivePanel:function(){switch(this.displayType){case"days":return this.daysGrid;break;case"month":return this.monthGrid;break;case"view":return this.viewGrid;break;case"list":return this.listGrid;break}},updatePeriodInfoPanel:function(){var B="";var A=this.getActivePanel().configuredDate;if(this.displayType=="month"){B=A.format("F, Y")}else{B=GO.lang.strWeek+" "+A.format("W")}this.periodInfoPanel.body.update(B)},deleteEvent:function(A,B){if(A.repeats){this.currentDeleteEvent=A;this.currentDeleteCallback=B;if(!this.recurrenceDialog){this.recurrenceDialog=new Ext.Window({width:400,autoHeight:true,closeable:false,closeAction:"hide",plain:true,border:false,closable:false,title:GO.calendar.lang.recurringEvent,modal:true,html:GO.calendar.lang.deleteRecurringEvent,buttons:[{text:GO.calendar.lang.singleOccurence,handler:function(){var C={task:"delete_event",create_exception:true,exception_date:this.currentDeleteEvent.startDate.format(this.daysGrid.dateTimeFormat),event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(C,this.currentDeleteCallback,this.currentDeleteEvent);this.recurrenceDialog.hide()},scope:this},{text:GO.calendar.lang.entireSeries,handler:function(){var C={task:"delete_event",event_id:this.currentDeleteEvent.event_id};this.sendDeleteRequest(C,this.currentDeleteCallback,this.currentDeleteEvent,true);this.recurrenceDialog.hide()},scope:this},{text:GO.lang.cmdCancel,handler:function(){this.recurrenceDialog.hide()},scope:this}]})}this.recurrenceDialog.show()}else{Ext.MessageBox.confirm(GO.lang.strConfirm,GO.lang.strDeleteSelectedItem,function(C){if(C=="yes"){var D={task:"delete_event",event_id:A.event_id};this.sendDeleteRequest(D,B,A)}},this)}},sendDeleteRequest:function(C,D,B,A){Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:C,callback:function(F,H,E){if(!H){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{D.call(this,B,A)}}},scope:this})},setDisplay:function(A){if(!A){A={}}Ext.apply(this.state,A);delete this.state.saveState;if(A.displayType){this.displayType=A.displayType}else{if(A.calendar_id){this.displayType=this.lastCalendarDisplayType}else{if(A.view_id){this.displayType="view"}}}this.state.displayType=this.displayType;var B="view";if(this.displayType!="view"){this.lastCalendarDisplayType=this.displayType}switch(this.displayType){case"month":this.displayPanel.getLayout().setActiveItem(1);break;case"days":this.displayPanel.getLayout().setActiveItem(0);break;case"view":this.displayPanel.getLayout().setActiveItem(2);break;case"list":this.displayPanel.getLayout().setActiveItem(3);break}this.monthButton.setDisabled(this.displayType=="view");this.listButton.setDisabled(this.displayType=="view");if(A.calendar_id){this.calendar_id=A.calendar_id;this.daysGridStore.baseParams.calendars=Ext.encode([A.calendar_id]);this.monthGridStore.baseParams.calendars=Ext.encode([A.calendar_id]);this.listGrid.store.baseParams.calendars=Ext.encode([A.calendar_id])}if(A.view_id){this.view_id=A.view_id;this.viewGrid.setViewId(A.view_id)}if(A.date){if(!A.days){A.days=this.type=="days"?this.daysGrid.days:this.viewGrid.days}this.daysGrid.setDate(A.date,A.days,this.displayType=="days");this.monthGrid.setDate(A.date,this.displayType=="month");this.viewGrid.setDate(A.date,A.days,this.displayType=="view");this.listGrid.setDate(A.date,A.days,this.displayType=="list");this.days=A.days}else{if(A.days&&this.displayType!="month"){this.daysGrid.setDays(A.days,this.displayType=="days");this.viewGrid.setDays(A.days,this.displayType=="view");this.listGrid.setDays(A.days,this.displayType=="list");this.days=A.days}else{if(A.days){this.days=A.days}switch(this.displayType){case"month":this.monthGridStore.reload();break;case"days":this.daysGridStore.reload();break;case"view":this.viewGrid.load();break;case"list":this.listGrid.store.reload();break}}}this.dayButton.toggle(this.displayType=="days"&&this.days==1);this.workWeekButton.toggle(this.displayType=="days"&&this.days==5);this.weekButton.toggle(this.displayType=="days"&&this.days==7);this.monthButton.toggle(this.displayType=="month");this.listButton.toggle(this.displayType=="list");this.updatePeriodInfoPanel();if(A.saveState){this.saveState()}},saveState:function(){var A={displayType:this.displayType,calendar_id:this.calendar_id,view_id:this.view_id,days:this.days};Ext.state.Manager.set("calendar-state",Ext.encode(A))},refresh:function(){this.setDisplay()},createDaysGrid:function(){this.daysGrid.on("eventResize",function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id,duration:B.duration};if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}}}})},this);this.daysGrid.on("create",function(B,A){var C={};C.start_date=A.startDate;C.start_hour=A.startDate.format("H");C.start_min=A.startDate.format("i");C.end_date=A.endDate;C.end_hour=A.endDate.format("H");C.end_min=A.endDate.format("i");GO.calendar.eventDialog.show({values:C,calendar_id:this.calendar_id,calendar_name:this.calendar_name})},this);this.monthGrid.on("create",function(C,B){var A=new Date();var D={start_date:B,end_date:B,start_hour:A.format("H"),end_hour:A.add(Date.HOUR,1).format("H"),start_min:"00",end_min:"00"};GO.calendar.eventDialog.show({values:D,calendar_id:this.calendar_id,calendar_name:this.calendar_name})},this);this.monthGrid.on("changeview",function(B,C,A){this.setDisplay({displayType:"days",days:C,date:A})},this);this.daysGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("eventDblClick",this.onDblClick,this);this.viewGrid.on("eventDblClick",this.onDblClick,this);this.monthGrid.on("move",this.onEventMove,this);this.daysGrid.on("move",this.onEventMove,this);this.viewGrid.on("move",function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id};if(B.offset){D.offset=B.offset}if(B.offsetDays){D.offsetDays=B.offsetDays}if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}if(B.calendar_id){D.update_calendar_id=B.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}else{if(G.new_event_id){A.setNewEventId(C.domId,G.new_event_id)}}}}})},this)},onDblClick:function(A,C,B){if(C.repeats&&B.singleInstance){var D={};D.start_date=C.startDate.format(GO.settings.date_format);D.start_hour=C.startDate.format("H");D.start_min=C.startDate.format("i");D.end_date=C.endDate.format(GO.settings.date_format);D.end_hour=C.endDate.format("H");D.end_min=C.endDate.format("i");GO.calendar.eventDialog.show({values:D,exceptionDate:C.startDate.format(this.daysGrid.dateTimeFormat),exception_event_id:C.event_id,oldDomId:C.domId})}else{GO.calendar.eventDialog.show({event_id:C.event_id,oldDomId:C.domId})}},onEventMove:function(A,C,B){var D={task:"update_grid_event",update_event_id:C.event_id};if(B.offset){D.offset=B.offset}if(B.offsetDays){D.offsetDays=B.offsetDays}if(C.repeats&&B.singleInstance){D.createException="true";D.exceptionDate=B.dragDate.format(A.dateTimeFormat);D.repeats="true"}if(B.calendar_id){D.update_calendar_id=B.calendar_id}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"action.php",params:D,callback:function(F,H,E){var G=Ext.decode(E.responseText);if(!G.success){Ext.MessageBox.alert(GO.lang.strError,G.feedback)}else{if(C.repeats&&!B.singleInstance){A.store.reload()}else{if(G.new_event_id){A.setNewEventId(C.domId,G.new_event_id)}}}}})},showAdminDialog:function(){if(!this.adminDialog){this.writableCalendarsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.writableCalendarsStore.load();this.writableViewsStore=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_views"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});this.calendarDialog=new GO.calendar.CalendarDialog();this.calendarDialog.on("save",function(){this.writableCalendarsStore.reload();this.calendarsStore.reload()},this);this.calendarsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.calendars,paging:true,border:false,store:this.writableCalendarsStore,deleteConfig:{callback:function(){this.calendarsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addCalendar",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.calendarDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.calendarsGrid.deleteSelected()},scope:this}]});this.calendarsGrid.on("rowdblclick",function(A,B,C){this.calendarDialog.show(A.selModel.selections.keys[0])},this);this.viewDialog=new GO.calendar.ViewDialog();this.viewDialog.on("save",function(){this.writableViewsStore.reload();this.viewsStore.reload()},this);this.viewsGrid=new GO.grid.GridPanel({title:GO.calendar.lang.views,paging:true,border:false,store:this.writableViewsStore,deleteConfig:{callback:function(){this.viewsStore.reload()},scope:this},columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strOwner,dataIndex:"user_name"}],view:new Ext.grid.GridView({autoFill:true}),sm:new Ext.grid.RowSelectionModel(),loadMask:true,tbar:[{id:"addView",iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.viewDialog.show()},scope:this},{id:"delete",iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.viewsGrid.deleteSelected()},scope:this}]});this.viewsGrid.on("rowdblclick",function(A,B,C){this.viewDialog.show(A.selModel.selections.keys[0])},this);this.viewsGrid.on("show",function(){this.writableViewsStore.load()},this,{single:true});this.adminDialog=new Ext.Window({title:GO.calendar.lang.administration,layout:"fit",modal:false,minWidth:300,minHeight:300,height:400,width:600,closeAction:"hide",items:new Ext.TabPanel({border:false,activeTab:0,items:[this.calendarsGrid,this.viewsGrid]}),buttons:[{text:GO.lang.cmdClose,handler:function(){this.adminDialog.hide()},scope:this}]})}this.adminDialog.show()}});GO.calendar.CalendarList=function(B){Ext.apply(B);var A=new Ext.XTemplate("<b>"+GO.calendar.lang.calendars+"</b>",'<tpl for=".">','<div id="calendar-{id}" class="calendar-wrap">{name}</div>',"</tpl>");GO.calendar.CalendarList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.calendar-wrap"})};Ext.extend(GO.calendar.CalendarList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",id:"calendarList",cls:"calendar-list"});GO.calendar.CalendarList.superclass.onRender.apply(this,arguments)}});GO.calendar.ViewList=function(B){Ext.apply(B);var A=new Ext.XTemplate("<b>"+GO.calendar.lang.views+"</b>",'<tpl for=".">','<div id="view-{id}" class="view-wrap">{name}</div>',"</tpl>");GO.calendar.ViewList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"x-view-over",itemSelector:"div.view-wrap"})};Ext.extend(GO.calendar.ViewList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",id:"viewList",cls:"view-list"});GO.calendar.ViewList.superclass.onRender.apply(this,arguments)}});GO.moduleManager.addModule("calendar",GO.calendar.MainPanel,{title:GO.calendar.lang.calendar,iconCls:"go-tab-icon-calendar"});GO.mainLayout.onReady(function(){GO.calendar.eventDialog=new GO.calendar.EventDialog()});GO.linkHandlers[1]=function(A){GO.calendar.eventDialog.show({event_id:A})};GO.newMenuItems.push({text:GO.calendar.lang.appointment,iconCls:"go-link-icon-1",handler:function(A,B){GO.calendar.eventDialog.show({link_config:A.parentMenu.link_config})}});GO.calendar.extraToolbarItems=[];GO.calendar.SummaryGroupPanel=function(A){if(!A){A={}}A.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"count",root:"results",id:"event_id",fields:["id","event_id","name","time","start_time","end_time","description","location","private","repeats","day"]}),baseParams:{task:"summary"},proxy:new Ext.data.HttpProxy({url:GO.settings.modules.calendar.url+"json.php"}),groupField:"day",sortInfo:{field:"start_time",direction:"ASC"}});A.paging=false,A.autoExpandColumn="summary-calendar-name-heading";A.autoExpandMax=2500;A.enableColumnHide=false;A.enableColumnMove=false;A.columns=[{header:GO.lang.strDay,dataIndex:"day"},{header:GO.lang.strTime,dataIndex:"time",width:70},{id:"summary-calendar-name-heading",header:GO.lang.strName,dataIndex:"name",renderer:this.renderName}];A.view=new Ext.grid.GroupingView({hideGroupedColumn:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "'+GO.lang.items+'" : "'+GO.lang.item+'"]})',emptyText:GO.calendar.lang.noAppointmentsToDisplay,showGroupName:false});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.autoHeight=true;GO.calendar.SummaryGroupPanel.superclass.constructor.call(this,A)};Ext.extend(GO.calendar.SummaryGroupPanel,Ext.grid.GridPanel,{renderName:function(B,C,A){return'<div style="font-weight:bold">'+A.data.name+"</div>"+GO.calendar.formatQtip(A.data)},afterRender:function(){GO.calendar.SummaryGroupPanel.superclass.afterRender.call(this);GO.calendar.eventDialog.on("save",function(){this.store.reload()},this);this.on("rowdblclick",function(A,B,D){var C=A.selModel.selections.keys[0];GO.calendar.eventDialog.show({event_id:C})},this);Ext.TaskMgr.start({run:this.store.load,scope:this.store,interval:900000})}});GO.mainLayout.onReady(function(){if(GO.summary){var A=new GO.calendar.SummaryGroupPanel({id:"summary-calendar-grid"});GO.summary.portlets["portlet-calendar"]=new GO.summary.Portlet({id:"portlet-calendar",title:GO.calendar.lang.appointments,layout:"fit",tools:[{id:"close",handler:function(D,C,B){B.removePortlet()}}],items:A,autoHeight:true})}});GO.calendar.Participant=Ext.data.Record.create([{name:"id",type:"string"},{name:"name",type:"string"},{name:"email",type:"string"},{name:"available",type:"string"},{name:"status",type:"string"}]);GO.calendar.ParticipantsPanel=function(A,B){this.eventDialog=A;if(!B){B={}}B.store=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"participants"},root:"results",id:"id",fields:["id","name","email","available","status"]});var C=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.showAddParticipantsDialog()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){var E=this.gridPanel.selModel.getSelections();for(var D=0;D<E.length;D++){E[D].commit();this.store.remove(E[D])}},scope:this},{iconCls:"btn-availability",text:GO.calendar.lang.checkAvailability,cls:"x-btn-text-icon",handler:function(){this.checkAvailability()},scope:this}];this.inviteCheckbox=new Ext.form.Checkbox({name:"invitation",boxLabel:GO.calendar.lang.sendInvitation,hideLabel:true});this.importCheckbox=new Ext.form.Checkbox({name:"import",boxLabel:GO.calendar.lang.importToCalendar,hideLabel:true});this.checkPanel=new Ext.Panel({border:false,region:"north",autoHeight:true,bodyStyle:"padding:10px",labelWidth:110,defaults:{border:false},items:[{layout:"column",defaults:{border:false},items:[{columnWidth:0.5,items:[this.inviteCheckbox]},{columnWidth:0.5,bodyStyle:"padding-left:10px",items:[this.importCheckbox]}]}]});this.gridPanel=new GO.grid.GridPanel({store:B.store,border:false,region:"center",columns:[{header:GO.lang.strName,dataIndex:"name",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",sortable:true},{header:GO.lang.strStatus,dataIndex:"status",sortable:true,renderer:function(D){switch(D){case"2":return GO.calendar.lang.declined;break;case"1":return GO.calendar.lang.accepted;break;case"0":return GO.calendar.lang.notRespondedYet;break}}},{header:GO.lang.strAvailable,dataIndex:"available",sortable:false,renderer:function(D){var E="img-unknown";switch(D){case"1":E="img-available";break;case"0":E="img-unavailable";break}return'<div class="'+E+'"></div>'}}],view:new Ext.grid.GridView({autoFill:true,forceFit:true}),loadMask:{msg:GO.lang.waitMsgLoad},sm:new Ext.grid.RowSelectionModel()});Ext.apply(B,{title:GO.calendar.lang.participants,border:false,tbar:C,layout:"border",items:[this.checkPanel,this.gridPanel]});B.store.setDefaultSort("name","ASC");GO.calendar.ParticipantsPanel.superclass.constructor.call(this,B)};Ext.extend(GO.calendar.ParticipantsPanel,Ext.Panel,{event_id:0,newId:0,loaded:false,getGridData:function(){return this.gridPanel.getGridData()},setEventId:function(A){this.event_id=this.store.baseParams.event_id=A;this.store.loaded=false;if(this.event_id==0){this.store.removeAll()}this.newId=0;this.inviteCheckbox.setValue(false);this.importCheckbox.setValue(false)},onShow:function(){if(!this.store.loaded){if(this.store.baseParams.event_id>0){this.store.load()}else{this.addDefaultParticipant()}}GO.calendar.ParticipantsPanel.superclass.onShow.call(this)},showAddParticipantsDialog:function(){if(!GO.addressbook){var A=new Ext.XTemplate(GO.lang.moduleRequired);Ext.Msg.alert(GO.lang.strError,A.apply({module:GO.calendar.lang.addressbook}));return false}if(!this.addParticipantsDialog){this.addParticipantsDialog=new GO.dialog.SelectEmail({handler:function(D){if(D.selModel.selections.keys.length>0){var E=D.selModel.getSelections();var B=[];for(var C=0;C<E.length;C++){B.push(E[C].get("email"))}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"check_availability",emails:B.join(","),start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(H,K,G){if(!K){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var J=Ext.decode(G.responseText);for(var I=0;I<E.length;I++){var F=this.store.findBy(function(L,M){if(L.get("email")==E[I].get("email")){return true}else{return false}});if(F==-1){this.addParticipant({name:E[I].get("name"),email:E[I].get("email"),status:"0",user_id:E[I].get("id"),available:J[E[I].get("email")]})}}}},scope:this})}},scope:this})}this.addParticipantsDialog.show()},addDefaultParticipant:function(){this.body.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"get_default_participant",calendar_id:this.eventDialog.calendar_id,start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(B,D,A){this.body.unmask();if(!D){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var C=Ext.decode(A.responseText);this.addParticipant({name:C.name,email:C.email,status:C.status,user_id:C.user_id,available:C.available})}},scope:this})},addParticipant:function(A){A.id="new_"+this.newId;var B=new GO.calendar.Participant(A);this.store.insert(this.store.getCount(),B);this.newId++;this.store.loaded=true},reloadAvailability:function(){var C=this.store.getRange();if(C.length){var A=[];for(var B=0;B<C.length;B++){A.push(C[B].get("email"))}Ext.Ajax.request({url:GO.settings.modules.calendar.url+"json.php",params:{task:"check_availability",emails:A.join(","),start_time:this.eventDialog.getStartDate().format("U"),end_time:this.eventDialog.getEndDate().format("U")},callback:function(E,H,D){if(!H){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var G=Ext.decode(D.responseText);for(var F=0;F<C.length;F++){C[F].set("available",G[C[F].get("email")])}this.store.commitChanges()}},scope:this})}},checkAvailability:function(){if(!this.availabilityWindow){this.availabilityWindow=new GO.calendar.AvailabilityCheckWindow();this.availabilityWindow.on("select",function(H,I,F){var M=this.eventDialog;var E=F.id.substr(4);var L=E.indexOf(":");var G=E.substr(L+1);var O=E.substr(0,L);var K=parseInt(M.endHour.getValue())-parseInt(M.startHour.getValue());var P=parseInt(M.endMin.getValue())-parseInt(M.startMin.getValue());if(P<0){P+=60;K--}G=G+"";if(G.length==1){G="0"+G}M.startHour.setValue(O);M.startMin.setValue(G);M.startDate.setValue(Date.parseDate(H.store.baseParams.date,GO.settings.date_format));var J=parseInt(O)+K;var N=parseInt(G)+P;if(N>=60){N-=60;J++}N=N+"";if(N.length==1){N="0"+N}M.endHour.setValue(J);M.endMin.setValue(N);M.endDate.setValue(Date.parseDate(H.store.baseParams.date,GO.settings.date_format));M.tabPanel.setActiveTab(0);this.reloadAvailability();this.availabilityWindow.hide()},this)}var A=this.store.getRange();var D=[];var C=[];for(var B=0;B<A.length;B++){D.push(A[B].get("email"));C.push(A[B].get("name"))}this.availabilityWindow.show({date:this.eventDialog.startDate.getRawValue(),event_id:this.event_id,emails:D.join(","),names:C.join(",")})}});GO.calendar.AvailabilityCheckWindow=function(B){B=B||{};var A=new Ext.XTemplate('<div id="availability_date"></div>','<table class="availability">',"<tr><td></td>",'<td colspan="4" class="availability_time">'+Date.parseDate("0","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("1","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("2","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("3","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("4","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("5","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("6","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("7","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("8","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("9","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("10","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("11","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("12","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("13","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("14","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("15","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("16","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("17","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("18","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("19","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("20","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("21","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("22","G").format(GO.settings.time_format)+"</td>",'<td colspan="4" class="availability_time">'+Date.parseDate("23","G").format(GO.settings.time_format)+"</td>",'<tpl for=".">',"<tr>","<td>{name}</td>",'<tpl if="this.hasFreeBusy(freebusy)">','<tpl for="freebusy">','<td id="time{time}"class="time {[values.busy == 1 ? "busy" : "free"]}"></td>',"</tpl>","</tpl>",'<tpl if="!this.hasFreeBusy(freebusy)">','<td colspan="96">'+GO.calendar.lang.noInformationAvailable+"</td>","</tpl>","</tr>","</tpl>","</table>",{hasFreeBusy:function(C){return C.length>0}});this.dataView=new Ext.DataView({store:new Ext.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",root:"participants",fields:["name","email","freebusy"],baseParams:{task:"availability",emails:"",names:"",event_id:0,date:""}}),tpl:A,autoHeight:true,emptyText:GO.calendar.lang.noParticipantsToDisplay,itemSelector:"td.time",overClass:"time-over"});this.dataView.on("click",function(C,D,E){this.fireEvent("select",C,D,E)},this);this.dataView.store.on("load",function(){Ext.get("availability_date").update(this.dataView.store.baseParams.date)},this);Ext.apply(B,{layout:"fit",modal:false,height:400,width:800,closeAction:"hide",title:GO.lang.strAvailability,items:{layout:"fit",cls:"go-form-panel",waitMsgTarget:true,items:this.dataView,autoScroll:true},tbar:[{iconCls:"btn-left-arrow",text:GO.calendar.lang.previousDay,cls:"x-btn-text-icon",handler:function(){var C=Date.parseDate(this.dataView.store.baseParams.date,GO.settings.date_format).add(Date.DAY,-1);this.dataView.store.baseParams.date=C.format(GO.settings.date_format);this.dataView.store.load()},scope:this},{iconCls:"btn-right-arrow",text:GO.calendar.lang.nextDay,cls:"x-btn-text-icon",handler:function(){var C=Date.parseDate(this.dataView.store.baseParams.date,GO.settings.date_format).add(Date.DAY,1);this.dataView.store.baseParams.date=C.format(GO.settings.date_format);this.dataView.store.load()},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});GO.calendar.AvailabilityCheckWindow.superclass.constructor.call(this,B);this.addEvents({select:true})};Ext.extend(GO.calendar.AvailabilityCheckWindow,GO.Window,{show:function(A){this.dataView.store.baseParams.date=A.date;this.dataView.store.baseParams.event_id=A.event_id;this.dataView.store.baseParams.emails=A.emails;this.dataView.store.baseParams.names=A.names;this.dataView.store.load();GO.calendar.AvailabilityCheckWindow.superclass.show.call(this)}});GO.calendar.SettingsPanel=function(A){if(!A){A={}}var C=[["0",GO.calendar.lang.noReminder]];for(var B=1;B<60;B++){C.push([B,B])}this.reminderValue=new Ext.form.ComboBox({fieldLabel:GO.calendar.lang.reminder,hiddenName:"reminder_value",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"0",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:C})});this.reminderMultiplier=new Ext.form.ComboBox({hiddenName:"reminder_multiplier",triggerAction:"all",editable:false,selectOnFocus:true,width:148,forceSelection:true,mode:"local",value:"60",valueField:"value",displayField:"text",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["60",GO.lang.strMinutes],["3600",GO.lang.strHours],["86400",GO.lang.strDays]]}),hideLabel:true,labelSeperator:""});A.autoScroll=true;A.border=false;A.hideLabel=true;A.title=GO.calendar.lang.calendar;A.hideMode="offsets";A.layout="form";A.labelWidth=140;A.bodyStyle="padding:5px";A.items={xtype:"fieldset",autoHeight:true,layout:"form",title:GO.calendar.lang.eventDefaults,items:[{border:false,layout:"table",defaults:{border:false,layout:"form",bodyStyle:"padding-right:3px"},items:[{items:this.reminderValue},{items:this.reminderMultiplier}]},this.colorField=new GO.form.ColorField({fieldLabel:GO.lang.color,value:"EBF1E2",name:"background",colors:["EBF1E2","95C5D3","FFFF99","A68340","82BA80","F0AE67","66FF99","CC0099","CC99FF","996600","999900","FF0000","FF6600","FFFF00","FF9966","FF9900","FB0467","D52A6F","CC3370","C43B72","BB4474","B34D75","AA5577","A25E79","FF00CC","D52AB3","CC33AD","C43BA8","BB44A3","B34D9E","AA5599","A25E94","CC00FF","B32AD5","AD33CC","A83BC4","A344BB","9E4DB3","9955AA","945EA2","6704FB","6E26D9","7033CC","723BC4","7444BB","754DB3","7755AA","795EA2","0404FB","2626D9","3333CC","3B3BC4","4444BB","4D4DB3","5555AA","5E5EA2","0066FF","2A6ED5","3370CC","3B72C4","4474BB","4D75B3","5577AA","5E79A2","00CCFF","2AB2D5","33ADCC","3BA8C4","44A3BB","4D9EB3","5599AA","5E94A2","00FFCC","2AD5B2","33CCAD","3BC4A8","44BBA3","4DB39E","55AA99","5EA294","00FF66","2AD56F","33CC70","3BC472","44BB74","4DB375","55AA77","5EA279","00FF00","2AD52A","33CC33","3BC43B","44BB44","4DB34D","55AA55","5EA25E","66FF00","6ED52A","70CC33","72C43B","74BB44","75B34D","77AA55","79A25E","CCFF00","B2D52A","ADCC33","A8C43B","A3BB44","9EB34D","99AA55","94A25E","FFCC00","D5B32A","CCAD33","C4A83B","BBA344","B39E4D","AA9955","A2945E","FF6600","D56F2A","CC7033","C4723B","BB7444","B3754D","AA7755","A2795E","FB0404","D52A2A","CC3333","C43B3B","BB4444","B34D4D","AA5555","A25E5E","FFFFFF","949494","808080","6B6B6B","545454","404040","292929","000000"]}),this.selectCalendar=new GO.form.ComboBox({fieldLabel:GO.calendar.lang.default_calendar,hiddenName:"default_calendar_id",anchor:"-20",emptyText:GO.lang.strPleaseSelect,store:new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",id:"id",totalProperty:"total",fields:["id","name"],remoteSort:true}),pageSize:parseInt(GO.settings.max_rows_list),valueField:"id",displayField:"name",typeAhead:true,mode:"remote",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false})]};GO.calendar.SettingsPanel.superclass.constructor.call(this,A)};Ext.extend(GO.calendar.SettingsPanel,Ext.Panel,{onLoadSettings:function(A){this.selectCalendar.setRemoteText(A.result.data.default_calendar_name)},onSaveSettings:function(){GO.calendar.eventDialog.reminderValue.originalValue=this.reminderValue.getValue();GO.calendar.eventDialog.reminderMultiplier.originalValue=this.reminderMultiplier.getValue();GO.calendar.eventDialog.colorField.originalValue=this.colorField.getValue()}});GO.mainLayout.onReady(function(){GO.moduleManager.addSettingsPanel("calendar",GO.calendar.SettingsPanel)});GO.calendar.SelectCalendar=function(A){A=A||{};if(!A.hiddenName){A.hiddenName="calendar_id"}if(!A.fieldLabel){A.fieldLabel=GO.calendar.lang.calendar}Ext.apply(this,A);this.store=new GO.data.JsonStore({url:GO.settings.modules.calendar.url+"json.php",baseParams:{task:"writable_calendars"},root:"results",totalProperty:"total",id:"id",fields:["id","name","user_name"],remoteSort:true});GO.calendar.SelectCalendar.superclass.constructor.call(this,{displayField:"name",valueField:"id",triggerAction:"all",mode:"remote",editable:true,selectOnFocus:true,forceSelection:true,typeAhead:true,emptyText:GO.lang.strPleaseSelect,pageSize:parseInt(GO.settings.max_rows_list)})};Ext.extend(GO.calendar.SelectCalendar,GO.form.ComboBox,{});