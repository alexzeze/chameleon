GO.email.AliasesDialog=function(A){if(!A){A={}}this.aliasesGrid=new GO.email.AliasesGrid();A.layout="fit";A.modal=false;A.resizable=false;A.width=500;A.height=400;A.closeAction="hide";A.title=GO.email.lang.aliases;A.items=this.aliasesGrid;A.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AliasesDialog.superclass.constructor.call(this,A)};Ext.extend(GO.email.AliasesDialog,Ext.Window,{show:function(A){this.aliasesGrid.setAccountId(A);GO.email.AliasesDialog.superclass.show.call(this)}});GO.email.AliasDialog=function(B){if(!B){B={}}this.buildForm();var A=function(){this.formPanel.items.items[0].focus()};B.layout="fit";B.modal=false;B.resizable=false;B.width=500;B.autoHeight=true;B.closeAction="hide";B.title=GO.email.lang.alias;B.items=this.formPanel;B.focus=A.createDelegate(this);B.buttons=[{text:GO.lang.cmdOk,handler:function(){this.submitForm(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.submitForm()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AliasDialog.superclass.constructor.call(this,B);this.addEvents({save:true})};Ext.extend(GO.email.AliasDialog,Ext.Window,{show:function(B,A){if(!this.rendered){this.render(Ext.getBody())}this.formPanel.form.reset();if(!B){B=0}this.setAliasId(B);if(this.alias_id>0){this.formPanel.load({url:GO.settings.modules.email.url+"json.php",waitMsg:GO.lang.waitMsgLoad,success:function(C,D){GO.email.AliasDialog.superclass.show.call(this)},failure:function(C,D){Ext.Msg.alert(GO.lang.strError,D.result.feedback)},scope:this})}else{GO.email.AliasDialog.superclass.show.call(this)}},setAliasId:function(A){this.formPanel.form.baseParams.alias_id=A;this.alias_id=A},submitForm:function(A){this.formPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_alias"},waitMsg:GO.lang.waitMsgSave,success:function(B,C){if(C.result.alias_id){this.setAliasId(C.result.alias_id)}this.fireEvent("save",this,this.alias_id);if(A){this.hide()}},failure:function(B,C){if(C.failureType=="client"){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strErrorsInForm)}else{Ext.MessageBox.alert(GO.lang.strError,C.result.feedback)}},scope:this})},buildForm:function(){this.formPanel=new Ext.form.FormPanel({waitMsgTarget:true,url:GO.settings.modules.email.url+"action.php",border:false,baseParams:{task:"alias",account_id:0},cls:"go-form-panel",autoHeight:true,items:[{xtype:"textfield",name:"name",anchor:"100%",fieldLabel:GO.lang.strName},{xtype:"textfield",name:"email",anchor:"100%",fieldLabel:GO.email.lang.email},{xtype:"textarea",name:"signature",anchor:"100%",height:150,fieldLabel:GO.email.lang.signature}]})}});GO.email.AliasesGrid=function(A){if(!A){A={}}A.layout="fit";A.autoScroll=true;A.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"aliases"},root:"results",id:"id",totalProperty:"total",fields:["id","account_id","name","email","signature"],remoteSort:true});var B=new Ext.grid.ColumnModel([{header:GO.lang.strName,dataIndex:"name"},{header:GO.email.lang.email,dataIndex:"email"}]);B.defaultSortable=true;A.cm=B;A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;this.aliasDialog=new GO.email.AliasDialog();this.aliasDialog.on("save",function(){this.store.reload();if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}},this);A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.aliasDialog.formPanel.baseParams.account_id=this.account_id;this.aliasDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected({callback:function(){if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}this.fireEvent("delete",this)},scope:this})},scope:this}];GO.email.AliasesGrid.superclass.constructor.call(this,A);this.on("rowdblclick",function(D,E){var C=D.getStore().getAt(E);this.aliasDialog.show(C.data.id)},this)};Ext.extend(GO.email.AliasesGrid,GO.grid.GridPanel,{setAccountId:function(A){if(this.store.baseParams.account_id!=A){this.store.baseParams.account_id=A;if(A==0){this.store.removeAll()}else{this.store.load()}}this.setDisabled(A==0);this.account_id=A}});GO.email.FoldersDialog=function(A){Ext.apply(this,A);this.foldersTree=new Ext.tree.TreePanel({animate:true,border:false,autoScroll:true,height:200,loader:new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree-edit",account_id:0},preloadChildren:true,listeners:{beforeload:function(){this.body.mask(GO.lang.waitMsgLoad)},load:function(){this.body.unmask()},scope:this}})});this.rootNode=new Ext.tree.AsyncTreeNode({text:GO.email.lang.root,draggable:false,id:"account",folder_id:0,expanded:false});this.foldersTree.setRootNode(this.rootNode);this.rootNode.on("load",function(){this.rootNode.select()},this);this.foldersTree.on("checkchange",function(E,D){this.body.mask(GO.lang.waitMsgSave,"x-mask-loading");var C=D?"subscribe":"unsubscribe";Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:C,account_id:this.account_id,mailbox:E.attributes.mailbox},callback:function(G,H,F){if(!H){Ext.MessageBox.alert(GO.lang.strError,F.result.feedback)}this.body.unmask()},scope:this})},this);var B=new Ext.tree.TreeEditor(this.foldersTree,{ignoreNoChange:true});B.on("beforestartedit",function(D,C,E){if(D.editNode.attributes.folder_id==0||D.editNode.attributes.mailbox=="INBOX"){alert(GO.email.lang.cantEditFolder);return false}});B.on("beforecomplete",function(D,C,E){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"rename_folder",folder_id:D.editNode.attributes.folder_id,new_name:C},callback:function(G,H,F){if(!H){Ext.MessageBox.alert(GO.lang.strError,F.result.feedback)}else{return true}}})});GO.email.FoldersDialog.superclass.constructor.call(this,{layout:"fit",modal:false,shadow:false,minWidth:300,minHeight:300,height:400,width:500,plain:true,closeAction:"hide",title:GO.email.lang.folders,items:this.foldersTree,tbar:[{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){var D=this.foldersTree.getSelectionModel();var C=D.getSelectedNode();if(!C||C.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderDelete)}else{if(C.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantDeleteInboxFolder)}else{GO.deleteItems({url:GO.settings.modules.email.url+"action.php",params:{task:"delete_folder",folder_id:C.attributes.folder_id},callback:function(E){if(E.success){C.remove()}else{Ext.MessageBox.alert(GO.lang.strError,E.feedback)}},count:1,scope:this})}}}},{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){var D=this.foldersTree.getSelectionModel();var C=D.getSelectedNode();if(!C){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderAdd)}else{Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(E,F){if(E=="ok"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"add_folder",folder_id:C.attributes.folder_id,account_id:this.account_id,new_folder_name:F},callback:function(H,J,G){if(!J){Ext.MessageBox.alert(GO.lang.strError,G.result.errors)}else{var I=Ext.decode(G.responseText);if(I.success){delete C.attributes.children;C.reload()}else{Ext.MessageBox.alert(GO.lang.strError,I.feedback)}}},scope:this})}},this)}},scope:this},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"syncfolders",account_id:this.account_id},callback:function(D,E,C){if(!E){Ext.MessageBox.alert(GO.lang.strError,C.result.feedback)}else{this.rootNode.reload()}},scope:this})},scope:this}],buttons:[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]})};Ext.extend(GO.email.FoldersDialog,Ext.Window,{show:function(A){this.render(Ext.getBody());this.account_id=A;this.foldersTree.loader.baseParams.account_id=A;if(!this.rootNode.isExpanded()){this.rootNode.expand()}else{this.rootNode.reload()}GO.email.FoldersDialog.superclass.show.call(this)},getSubscribtionData:function(){var B=[];for(var A=0;A<this.allFoldersStore.data.items.length;A++){B[A]={id:this.allFoldersStore.data.items[A].get("id"),subscribed:this.allFoldersStore.data.items[A].get("subscribed"),name:this.allFoldersStore.data.items[A].get("name")}}return B}});GO.email.AccountDialog=function(A){Ext.apply(this,A);var D;var I;function H(J){return J=="1"?GO.lang.cmdYes:GO.lang.cmdNo}var F=new Ext.grid.ColumnModel([{header:GO.email.lang.field,dataIndex:"field"},{header:GO.email.lang.contains,dataIndex:"keyword"},{header:GO.email.lang.moveToFolder,dataIndex:"folder"},{header:GO.email.lang.markAsRead,dataIndex:"mark_as_read",renderer:H}]);F.defaultSortable=false;this.filtersDS=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{type:"filters",account_id:this.account_id},root:"results",id:"id",fields:["id","field","keyword","folder","mark_as_read"],remoteSort:false});this.filtersTab=new GO.grid.GridPanel({title:GO.email.lang.filters,layout:"fit",border:true,loadMask:true,ds:this.filtersDS,cm:F,view:new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems}),sm:new Ext.grid.RowSelectionModel(),tbar:[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){filter.showDialog(0,this.account_id,this.filtersDS)},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.filtersTab.deleteSelected()},scope:this}]});this.filtersTab.on("rowdblclick",function(){var J=this.filtersTab.getSelectionModel();var K=J.getSelected();filter.showDialog(K.data.id,this.account_id,this.filtersDS,GO.email.subscribedFoldersStore)},this);this.filtersTab.on("show",function(){if(this.filtersDS.baseParams.account_id!=this.account_id){this.filtersDS.baseParams={task:"filters",account_id:this.account_id};this.filtersDS.load()}},this);var E={title:GO.email.lang.incomingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,labelWidth:120,items:[D=new Ext.form.ComboBox({fieldLabel:GO.email.lang.type,hiddenName:"type",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["imap","IMAP"],["pop3","POP-3"]]}),value:"imap",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"host",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"username",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"password",inputType:"password",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this}}),{xtype:"fieldset",title:GO.email.lang.advanced,collapsible:true,collapsed:true,autoHeight:true,autoWidth:true,defaultType:"textfield",labelWidth:75,labelAlign:"left",items:[I=new Ext.form.Checkbox({boxLabel:GO.email.lang.ssl,name:"use_ssl",checked:false,hideLabel:true}),new Ext.form.Checkbox({boxLabel:GO.email.lang.novalidateCert,name:"novalidate_cert",checked:false,hideLabel:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"port",value:"143",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.email.lang.rootMailbox,name:"mbroot"})]}]};var B={title:GO.lang.strProperties,layout:"form",anchor:"100% 100%",defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:100,items:[this.selectUser=new GO.form.SelectUser({fieldLabel:GO.lang.strUser,disabled:!GO.settings.modules.email["write_permission"],anchor:"100%"}),{fieldLabel:GO.lang.strName,name:"name",allowBlank:false,anchor:"100%"},{fieldLabel:GO.lang.strEmail,name:"email",allowBlank:false,listeners:{change:function(){this.refreshNeeded=true},scope:this},anchor:"100%"},{xtype:"textarea",name:"signature",fieldLabel:GO.email.lang.signature,height:100,anchor:"100%"},this.aliasesButton=new Ext.Button({text:GO.email.lang.manageAliases,handler:function(){if(!this.aliasesDialog){this.aliasesDialog=new GO.email.AliasesDialog()}this.aliasesDialog.show(this.account_id)},scope:this})]};var G={title:GO.email.lang.outgoingMail,layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,cls:"go-form-panel",labelWidth:120,items:[new Ext.form.TextField({fieldLabel:GO.email.lang.host,name:"smtp_host",allowBlank:false,value:GO.email.defaultSmtpHost}),this.encryptionField=new Ext.form.ComboBox({fieldLabel:GO.email.lang.encryption,hiddenName:"smtp_encryption",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.noEncryption],["tls","TLS"],["ssl","SSL"]]}),value:"",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.TextField({fieldLabel:GO.email.lang.port,name:"smtp_port",value:"25",allowBlank:false}),new Ext.form.TextField({fieldLabel:GO.lang.strUsername,name:"smtp_username"}),new Ext.form.TextField({fieldLabel:GO.lang.strPassword,name:"smtp_password",inputType:"password"})]};GO.email.subscribedFoldersStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"subscribed_folders",account_id:0},root:"data",fields:["id","name"]});this.foldersTab=new Ext.Panel({title:GO.email.lang.folders,autoHeight:true,layout:"form",cls:"go-form-panel",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:150,tbar:[{iconCls:"btn-add",text:GO.email.lang.manageFolders,cls:"x-btn-text-icon",scope:this,handler:function(){if(!this.foldersDialog){this.foldersDialog=new GO.email.FoldersDialog()}this.foldersDialog.show(this.account_id)}}],items:[new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.sendItemsFolder,hiddenName:"sent",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled}),new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.trashFolder,hiddenName:"trash",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled}),new GO.form.ComboBoxReset({fieldLabel:GO.email.lang.draftsFolder,hiddenName:"drafts",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,emptyText:GO.lang.disabled})]});this.vacationPanel=new Ext.Panel({disabled:true,title:GO.email.lang.vacation,cls:"go-form-panel",layout:"form",autoScroll:true,items:[{xtype:"checkbox",name:"vacation_active",anchor:"-20",boxLabel:GO.email.lang.vacationActive,hideLabel:true},{xtype:"textfield",name:"vacation_subject",anchor:"-20",fieldLabel:GO.email.lang.vacationSubject},{xtype:"textarea",name:"vacation_body",anchor:"-20",fieldLabel:GO.email.lang.vacationBody,height:160}]});var C=[B,this.foldersTab,this.filtersTab,this.vacationPanel];if(GO.settings.modules.email.write_permission){C.splice(1,0,E,G)}this.propertiesPanel=new Ext.form.FormPanel({url:GO.settings.modules.email.url+"action.php",defaultType:"textfield",waitMsgTarget:true,labelWidth:120,border:false,items:[this.tabPanel=new Ext.TabPanel({hideLabel:true,deferredRender:false,activeTab:0,border:false,anchor:"100% 100%",items:C})]});D.on("select",function(M,J,K){var L=K==1?"110":"143";this.propertiesPanel.form.findField("port").setValue(L)},this);this.encryptionField.on("select",function(M,J,K){var L=J.data.value==""?"25":"465";this.propertiesPanel.form.findField("smtp_port").setValue(L)},this);I.on("check",function(L,K){if(D.getValue()=="imap"){var J=K?993:143;this.propertiesPanel.form.findField("port").setValue(J)}else{var J=K?995:110;this.propertiesPanel.form.findField("port").setValue(J)}},this);this.selectUser.on("select",function(L,J,K){this.propertiesPanel.form.findField("email").setValue(J.data.email);this.propertiesPanel.form.findField("username").setValue(J.data.username);this.propertiesPanel.form.findField("name").setValue(J.data.name)},this);GO.email.AccountDialog.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:650,plain:true,closeAction:"hide",title:GO.email.lang.account,items:this.propertiesPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.save(true)},scope:this},{text:GO.lang.cmdApply,handler:function(){this.save(false)},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({save:true})};Ext.extend(GO.email.AccountDialog,Ext.Window,{save:function(A){this.propertiesPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_account_properties",account_id:this.account_id},waitMsg:GO.lang.waitMsgSave,success:function(B,C){C.result.refreshNeeded=this.refreshNeeded||this.account_id==0;if(C.result.account_id){this.account_id=C.result.account_id;this.loadAccount(this.account_id)}this.refreshNeeded=false;this.fireEvent("save",this,C.result);if(A){this.hide()}},failure:function(C,D){var B="";if(D.failureType=="client"){B=GO.lang.strErrorsInForm}else{if(D.result){B=D.result.feedback}else{B=GO.lang.strRequestError}}Ext.MessageBox.alert(GO.lang.strError,B)},scope:this})},show:function(A){GO.email.AccountDialog.superclass.show.call(this);this.tabPanel.setActiveTab(0);this.aliasesButton.setDisabled(true);if(A){this.loadAccount(A);GO.email.subscribedFoldersStore.baseParams.account_id=A;GO.email.subscribedFoldersStore.load()}else{this.propertiesPanel.form.reset();this.account_id=0;this.foldersTab.setDisabled(true);this.filtersTab.setDisabled(true);this.vacationPanel.setDisabled(true);this.propertiesPanel.form.findField("name").setValue(GO.settings.name);this.propertiesPanel.form.findField("email").setValue(GO.settings.email);this.propertiesPanel.form.findField("username").setValue(GO.settings.username)}},loadAccount:function(A){this.propertiesPanel.form.load({url:GO.settings.modules.email.url+"json.php",params:{account_id:A,task:"account"},waitMsg:GO.lang.waitMsgLoad,success:function(B,C){this.refreshNeeded=false;this.account_id=A;this.selectUser.setRemoteValue(C.result.data.user_id,C.result.data.user_name);this.aliasesButton.setDisabled(false);this.foldersTab.setDisabled(C.result.data.type=="pop3");this.filtersTab.setDisabled(C.result.data.type=="pop3");this.vacationPanel.setDisabled(typeof (C.result.data.vacation_subject)=="undefined")},scope:this})}});filter=function(){return{showDialog:function(C,A,B){this.account_id=A;if(!this.win){this.formPanel=new Ext.form.FormPanel({layout:"form",defaults:{anchor:"100%"},defaultType:"textfield",labelWidth:125,autoHeight:true,cls:"go-form-panel",waitMsgTarget:true,items:[new Ext.form.ComboBox({fieldLabel:GO.email.lang.field,hiddenName:"field",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["from",GO.email.lang.sender],["subject",GO.email.lang.subject],["to",GO.email.lang.sendTo],["cc",GO.email.lang.ccField]]}),value:"from",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),{fieldLabel:GO.email.lang.keyword,name:"keyword",allowBlank:false},new Ext.form.ComboBox({fieldLabel:GO.email.lang.moveToFolder,hiddenName:"folder",store:GO.email.subscribedFoldersStore,valueField:"name",displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true,allowBlank:false}),new Ext.form.Checkbox({boxLabel:GO.email.lang.markAsRead,name:"mark_as_read",checked:false,hideLabel:true})]});this.win=new Ext.Window({title:GO.email.lang.filter,layout:"fit",modal:false,shadow:false,autoHeight:true,width:400,plain:false,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:function(){this.formPanel.form.submit({url:GO.settings.modules.email.url+"action.php",params:{task:"save_filter",filter_id:this.filter_id,account_id:this.account_id},waitMsg:GO.lang.waitMsgSave,success:function(D,E){if(E.result.filter_id){this.filter_id=E.result.filter_id}B.reload();this.win.hide()},failure:function(E,F){var D="";if(F.failureType=="client"){D=GO.lang.strErrorsInForm}else{D=F.result.feedback}Ext.MessageBox.alert(GO.lang.strError,D)},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.win.hide()},scope:this}]})}if(this.filter_id!=C){this.filter_id=C;if(this.filter_id>0){this.formPanel.load({url:GO.settings.modules.email.url+"json.php",params:{filter_id:C,task:"filter"}})}else{this.formPanel.form.reset()}}this.win.show()}}}();GO.email.SearchDialog=function(A){return{show:function(){if(!this.dialog){this.formPanel=new Ext.FormPanel({defaults:{anchor:"100%"},defaultType:"textfield",autoHeight:true,bodyStyle:"padding:5px",labelWidth:125,items:[{fieldLabel:GO.email.lang.subject,name:"subject"},{fieldLabel:GO.email.lang.from,name:"from"},{fieldLabel:GO.email.lang.to,name:"to"},{fieldLabel:GO.email.lang.cc,name:"cc"},{fieldLabel:GO.email.lang.body,name:"body"},new Ext.form.DateField({fieldLabel:GO.email.lang.recievedBefore,name:"before",format:GO.settings.date_format}),new Ext.form.DateField({fieldLabel:GO.email.lang.recievedSince,name:"since",format:GO.settings.date_format}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.flagged,name:"flagged",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["FLAGGED",GO.lang.cmdYes],["UNFLAGGED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.answered,name:"answered",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["ANSWERED",GO.lang.cmdYes],["UNANSWERED",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true}),new Ext.form.ComboBox({fieldLabel:GO.email.lang.read,name:"seen",store:new Ext.data.SimpleStore({fields:["value","text"],data:[["",GO.email.lang.NA],["SEEN",GO.lang.cmdYes],["UNSEEN",GO.lang.cmdNo]]}),value:"",valueField:"value",displayField:"text",typeAhead:true,mode:"local",triggerAction:"all",editable:false,selectOnFocus:true,forceSelection:true})]});this.dialog=new Ext.Window({layout:"fit",title:GO.lang.strSearch,modal:false,autoHeight:true,width:500,closeAction:"hide",items:this.formPanel,buttons:[{text:GO.lang.cmdOk,handler:this.doSearch,scope:this},{text:GO.lang.cmdReset,handler:function(){this.formPanel.form.reset()},scope:this},{text:GO.lang.cmdClose,handler:function(){this.dialog.hide()},scope:this}],keys:[{key:Ext.EventObject.ENTER,fn:this.doSearch,scope:this}],focus:function(){this.formPanel.form.findField("subject").focus(true)}.createDelegate(this)})}this.dialog.show()},doSearch:function(){A.store.baseParams.query=this.buildQuery();A.store.load();this.dialog.hide()},buildQuery:function(){var I="";var E=this.formPanel.form;var J=E.findField("subject").getValue();var L=E.findField("from").getValue();var M=E.findField("to").getValue();var F=E.findField("cc").getValue();var G=E.findField("body").getValue();var K=E.findField("before").getValue();var H=E.findField("since").getValue();var C=E.findField("flagged").getValue();var B=E.findField("seen").getValue();var D=E.findField("answered").getValue();if(J!=""){I+='SUBJECT "'+J+'" '}if(L!=""){I+='FROM "'+L+'" '}if(M!=""){I+='TO "'+M+'" '}if(F!=""){I+='CC "'+F+'" '}if(G!=""){I+='BODY "'+G+'" '}if(K!=""){I+='BEFORE "'+K.format("d-M-Y")+'" '}if(H!=""){I+='SINCE "'+H.format("d-M-Y")+'" '}if(C!=""){I+=" "+C}if(B!=""){I+=" "+B}if(D!=""){I+=" "+D}return I}}};GO.email.MessagePanel=Ext.extend(Ext.Panel,{uid:0,initComponent:function(){GO.email.MessagePanel.superclass.initComponent.call(this);this.addEvents({attachmentClicked:true,zipOfAttachmentsClicked:true,linkClicked:true,emailClicked:true,load:true,reset:true});this.bodyId=Ext.id();this.attachmentsId=Ext.id();var A='<div class="message-header"><table class="message-header-table"><tr><td style="width:70px"><b>'+GO.email.lang.from+'</b></td><td>: {from} &lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{sender}\', \'{[this.addSlashes(values.from)]}\');">{sender}</a>&gt;</td></tr><tr><td><b>'+GO.email.lang.subject+"</b></td><td>: {subject}</td></tr><tr><td><b>"+GO.lang.strDate+"</b></td><td>: {date}</td></tr><tr><td><b>"+GO.email.lang.to+'</b></td><td>: <tpl for="to">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr><tpl if="cc.length"><tr><td><b>'+GO.email.lang.cc+'</b></td><td>: <tpl for="cc">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr></tpl><tpl if="bcc.length"><tr><td><b>'+GO.email.lang.bcc+'</b></td><td>: <tpl for="bcc">{name} <tpl if="email.length">&lt;<a class="normal-link" href="#" onclick="GO.email.showAddressMenu(event, \'{email}\', \'{[this.addSlashes(values.name)]}\');">{email}</a>&gt;; </tpl></tpl></td></tr></tpl></table><tpl if="attachments.length"><table style="padding-top:5px;"><tr><td><b>'+GO.email.lang.attachments+':</b></td></tr><tr><td id="'+this.attachmentsId+'"><tpl for="attachments"><a class="filetype-link filetype-{extension}" id="'+this.attachmentsId+'_{index}" href="#">{name} ({human_size})</a> </tpl><tpl if="attachments.length&gt;1"><a class="filetype-link filetype-zip" id="'+this.attachmentsId+'_zipofall" href="#">'+GO.email.lang.downloadAllAsZip+'</a></tpl></td></tr></table></tpl><tpl if="blocked_images&gt;0"><div class="go-warning-msg em-blocked">'+GO.email.lang.blocked+' <a id="em-unblock" href="#" class="normal-link">'+GO.email.lang.unblock+'</a></div></tpl></div><div id="'+this.bodyId+'" class="message-body go-html-formatted">{body}</div>';this.template=new Ext.XTemplate(A,{addSlashes:function(B){B=GO.util.html_entity_decode(B,"ENT_QUOTES");B=GO.util.add_slashes(B);return B}});this.template.compile()},loadMessage:function(A,C,B,D){if(A){this.uid=A;this.params={uid:A,mailbox:C,account_id:B,task:"message"};if(D){this.params.passphrase=D}}this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"json.php",params:this.params,scope:this,callback:function(F,H,E){this.fireEvent("load",F,H,E);if(H){var G=Ext.decode(E.responseText);if(G.askPassphrase){if(!this.gnupgPasswordDialog){this.gnupgPasswordDialog=new GO.gnupg.PasswordDialog()}this.gnupgPasswordDialog.on("buttonpressed",function(I,J){if(I=="cancel"){this.reset();this.el.unmask()}else{this.loadMessage(A,C,B,J)}},this,{single:true});this.gnupgPasswordDialog.show()}else{this.setMessage(G);this.el.unmask()}if(G.feedback){GO.errorDialog.show(G.feedback)}}}})},reset:function(){this.data=false;this.uid=0;if(this.messageBodyEl){this.messageBodyEl.removeAllListeners()}if(this.attachmentsEl){this.attachmentsEl.removeAllListeners()}if(this.unblockEl){this.unblockEl.removeAllListeners()}this.body.update("");this.fireEvent("reset",this)},setMessage:function(A){this.data=A;if(this.messageBodyEl){this.messageBodyEl.removeAllListeners()}if(this.attachmentsEl){this.attachmentsEl.removeAllListeners()}if(this.unblockEl){this.unblockEl.removeAllListeners()}this.template.overwrite(this.body,A);this.unblockEl=Ext.get("em-unblock");if(this.unblockEl){this.unblockEl.on("click",function(){this.params.unblock="true";this.loadMessage()},this)}this.messageBodyEl=Ext.get(this.bodyId);this.messageBodyEl.on("click",this.onMessageBodyClick,this);this.messageBodyEl.on("contextmenu",this.onMessageBodyContextMenu,this);if(A.attachments.length){this.attachmentsEl=Ext.get(this.attachmentsId);this.attachmentsEl.on("click",this.openAttachment,this);if(this.attachmentContextMenu){this.attachmentsEl.on("contextmenu",this.onAttachmentContextMenu,this)}}this.body.scrollTo("top",0);if(this.data["new"]=="1"&&this.data.notification){if(confirm(GO.email.lang.sendNotification.replace("%s",this.data.notification))){var B={task:"notification",account_id:this.data.account_id,message_to:this.data.to,notification_to:this.data.notification,subject:this.data.subject};Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:B})}}},onAttachmentContextMenu:function(C,B){if(B.id.substr(0,this.attachmentsId.length)==this.attachmentsId){var A=B.id.substr(this.attachmentsId.length+1);if(A=="zipofall"){}else{C.preventDefault();var D=this.data.attachments[A];this.attachmentContextMenu.showAt(C.getXY(),D)}}},openAttachment:function(C,B){if(B.id.substr(0,this.attachmentsId.length)==this.attachmentsId){var A=B.id.substr(this.attachmentsId.length+1);if(A=="zipofall"){this.fireEvent("zipOfAttachmentsClicked")}else{var D=this.data.attachments[A];this.fireEvent("attachmentClicked",D,this)}}},onMessageBodyContextMenu:function(E,D){if(D.tagName!="A"){D=Ext.get(D).findParent("A",10);if(!D){return false}}if(D.tagName=="A"){var A=D.attributes.href.value;if(A.substr(0,6)=="mailto"){var C=A.indexOf("?");if(C>0){var B=A.substr(7,C-8)}else{var B=A.substr(7)}E.preventDefault();GO.email.addressContextMenu.showAt(E.getXY(),B)}}},onMessageBodyClick:function(e,target){if(target.tagName!="A"){target=Ext.get(target).findParent("A",10);if(!target){return false}}if(target.tagName=="A"){var href=target.attributes.href.value;if(href.substr(0,6)=="mailto"){var indexOf=href.indexOf("?");if(indexOf>0){var email=href.substr(7,indexOf-8)}else{var email=href.substr(7)}e.preventDefault();GO.email.addressContextMenu.showAt(e.getXY(),email)}else{if(href.substr(0,3)=="go:"){e.preventDefault();var cmd="GO.mailFunctions."+href.substr(3);eval(cmd)}else{if(target.href&&target.href.indexOf("#")!=-1&&target.pathname==document.location.pathname){}else{e.preventDefault();this.fireEvent("linkClicked",href)}}}}}});GO.email.AccountsDialog=function(A){if(!A){A={}}this.accountsGrid=new GO.email.AccountsGrid();A.maximizable=true;A.layout="fit";A.modal=false;A.resizable=false;A.width=500;A.height=400;A.closeAction="hide";A.title=GO.email.lang.accounts;A.items=this.accountsGrid;A.ddGroup="EmailAccountsDD";A.buttons=[{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}];GO.email.AccountsDialog.superclass.constructor.call(this,A)};Ext.extend(GO.email.AccountsDialog,Ext.Window,{});GO.email.AccountsGrid=function(A){if(!A){A={}}A.layout="fit";A.autoScroll=true;A.store=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"accounts"},root:"results",totalProperty:"total",id:"id",fields:["id","email","host","user_name"],remoteSort:true});A.store.setDefaultSort("utime","asc");A.paging=true;var B=new Ext.grid.ColumnModel([{header:GO.lang.strEmail,dataIndex:"email"},{header:GO.lang.strOwner,dataIndex:"user_name",sortable:false},{header:GO.email.lang.host,dataIndex:"host"}]);B.defaultSortable=false;A.cm=B;A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems});A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.border=false;A.enableDragDrop=true;A.ddGroup="EmailAccountsDD";if(GO.settings.modules.email.write_permission){A.tbar=[{iconCls:"btn-add",text:GO.lang.cmdAdd,cls:"x-btn-text-icon",handler:function(){this.accountDialog.show()},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){this.deleteSelected({callback:function(){if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}this.fireEvent("delete",this)},scope:this})},scope:this}]}GO.email.AccountsGrid.superclass.constructor.call(this,A);this.addEvents({"delete":true});this.accountDialog=new GO.email.AccountDialog();this.accountDialog.on("save",function(){this.store.reload();if(GO.email.aliasesStore.loaded){GO.email.aliasesStore.reload()}},this);this.on("rowdblclick",function(D,E){var C=D.getStore().getAt(E);this.accountDialog.show(C.data.id)},this)};Ext.extend(GO.email.AccountsGrid,GO.grid.GridPanel,{afterRender:function(){GO.email.AccountsDialog.superclass.afterRender.call(this);var A=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:"EmailAccountsDD",copy:false,notifyDrop:this.onNotifyDrop.createDelegate(this)})},onNotifyDrop:function(G,F,E){var I=this.selModel.getSelections();var D=G.getDragData(F);var H=D.rowIndex;if(H=="undefined"){H=this.store.data.length-1}for(C=0;C<I.length;C++){var B=this.store.getById(I[C].id);if(!this.copy){this.store.remove(this.store.getById(I[C].id))}this.store.insert(H,B)}var A={};for(var C=0;C<this.store.data.items.length;C++){A[this.store.data.items[C].get("id")]=C}Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_accounts_sort_order",sort_order:Ext.encode(A)}})}});GO.email.MessagesGrid=function(A){if(!A){A={}}A.layout="fit";A.autoScroll=true;A.paging=true;if(A.region=="north"){A.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:50,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.from,dataIndex:"from"},{header:GO.email.lang.subject,dataIndex:"subject"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);A.view=new Ext.grid.GridView({autoFill:true,forceFit:true,emptyText:GO.lang.strNoItems,getRowClass:function(C,B){if(C.data["new"]=="1"){return"ml-new-row"}}})}else{A.cm=new Ext.grid.ColumnModel([{header:"&nbsp;",width:46,dataIndex:"icon",renderer:this.renderIcon,hideable:false,sortable:false},{header:GO.email.lang.message,dataIndex:"from",renderer:this.renderMessage,css:"white-space:normal;",id:"message"},{header:GO.lang.strDate,dataIndex:"date",width:65,align:"right"}]);A.bbar=new Ext.PagingToolbar({cls:"go-paging-tb",store:A.store,pageSize:parseInt(GO.settings.max_rows_list),displayInfo:true,displayMsg:GO.lang.displayingItemsShort,emptyMsg:GO.lang.strNoItems});A.autoExpandColumn="message";A.view=new Ext.grid.GridView({emptyText:GO.lang.strNoItems})}A.cm.defaultSortable=true;A.sm=new Ext.grid.RowSelectionModel();A.loadMask=true;A.border=false;A.split=true;A.enableDragDrop=true;A.ddGroup="EmailDD";A.animCollapse=false;GO.email.MessagesGrid.superclass.constructor.call(this,A)};Ext.extend(GO.email.MessagesGrid,GO.grid.GridPanel,{renderMessageSmallRes:function(B,C,A){if(A.data["new"]=="1"){return String.format('<div id="sbj_'+A.data.uid+'" class="NewSubject">{0}</div>{1}',B,A.data.subject)}else{return String.format('<div id="sbj_'+A.data.uid+'" class="Subject">{0}</div>{1}',B,A.data.subject)}},renderMessage:function(B,C,A){if(A.data["new"]=="1"){return String.format('<div id="sbj_'+A.data.uid+'" class="NewSubject">{0}</div>{1}',B,A.data.subject)}else{return String.format('<div id="sbj_'+A.data.uid+'" class="Subject">{0}</div>{1}',B,A.data.subject)}},renderIcon:function(D,B,A){var C="";if(A.data.answered=="1"){C+='<div class="email-grid-icon btn-message-answered"></div>'}else{C+='<div class="email-grid-icon btn-message"></div>'}if(A.data.attachments=="1"){C+='<div class="email-grid-icon ml-icon-attach"></div>'}else{}if(A.data.priority){if(A.data.priority<3){C+='<div class="email-grid-icon btn-high-priority"></div>'}if(A.data.priority>3){C+='<div class="email-grid-icon btn-low-priority"></div>'}}if(A.data.flagged==1){C+='<div class="email-grid-icon btn-flag"></div>'}return C},renderFlagged:function(B,C,A){var D="";if(A.data.flagged==1){D+='<div class="go-icon btn-flag"></div>'}if(A.data.attachments){D+='<div class="go-icon btn-attach"></div>'}return D}});GO.email.AccountsTree=function(B){if(!B){B={}}B.layout="fit";B.split=true;B.autoScroll=true;B.width=200;B.animate=true;B.loader=new Ext.tree.TreeLoader({dataUrl:GO.settings.modules.email.url+"json.php",baseParams:{task:"tree"},preloadChildren:true});B.containerScroll=true;B.rootVisible=false;B.collapseFirst=false;B.collapsible=true;B.ddAppendOnly=true;B.containerScroll=true;B.enableDrop=true;B.ddGroup="EmailDD";B.bbar=new Ext.Toolbar({cls:"go-paging-tb",items:[this.statusBar=new Ext.Panel({height:20,baseCls:"em-statusbar",border:false,plain:true})]});GO.email.AccountsTree.superclass.constructor.call(this,B);var A=new Ext.tree.AsyncTreeNode({text:"Root",id:"bs-folder-0",draggable:false,iconCls:"folder-default",expanded:false});this.setRootNode(A)};Ext.extend(GO.email.AccountsTree,Ext.tree.TreePanel,{setUsage:function(A){this.statusBar.body.update(A)}});GO.email.UnknownRecipientsDialog=Ext.extend(Ext.Window,{initComponent:function(){this.store=new GO.data.JsonStore({root:"recipients",fields:["email","name","first_name","middle_name","last_name"]});this.list=new GO.grid.SimpleSelectList({store:this.store});this.list.on("click",function(B,E){var A=B.store.data.items[E];if(!GO.addressbook.contactDialog){GO.addressbook.contactDialog=new GO.addressbook.ContactDialog()}var D=A.data.email;var F=D.lastIndexOf(".");if(F){var C=D.substring(F+1,D.length).toUpperCase();if(GO.lang.countries[C]){A.data.country=C}}GO.addressbook.contactDialog.show();GO.addressbook.contactDialog.formPanel.form.setValues(A.data);this.store.remove(A);if(this.store.getCount()==0){this.hide()}},this);this.title=GO.email.lang.addUnknownRecipients;this.layout="fit";this.modal=false;this.height=400;this.width=600;this.closable=true;this.closeAction="hide";this.items=new Ext.Panel({autoScroll:true,items:[new Ext.Panel({border:false,html:GO.email.lang.addUnknownRecipientsText}),this.list],cls:"go-form-panel"});GO.email.UnknownRecipientsDialog.superclass.initComponent.call(this)}});GO.email.AddressbookDialog=function(B){Ext.apply(this,B);var A=Array();this.usersStore=new GO.data.JsonStore({url:GO.settings.modules.users.url+"non_admin_json.php",baseParams:{task:"users"},id:"id",root:"results",fields:["id","username","name","company","logins","lastlogin","registration_time","address","zip","city","state","country","phone","email","waddress","wzip","wcity","wstate","wcountry","wphone"],totalProperty:"total",remoteSort:true});this.usersSearchField=new GO.form.SearchField({store:this.usersStore,width:320});this.usersGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.users,paging:true,border:false,store:this.usersStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.usersSearchField]});this.usersGrid.on("show",function(){this.usersStore.load()},this);A.push(this.usersGrid);if(GO.addressbook){this.contactsStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"contacts"},root:"results",id:"id",totalProperty:"total",fields:["id","name","company_name","email","home_phone","work_phone","work_fax","cellular"],remoteSort:true});this.contactsSearchField=new GO.form.SearchField({store:this.contactsStore,width:320});this.contactsGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.contacts,paging:true,border:false,store:this.contactsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.contactsSearchField]});this.contactsGrid.on("show",function(){this.contactsStore.load()},this);this.companiesStore=new GO.data.JsonStore({url:GO.settings.modules.addressbook.url+"json.php",baseParams:{task:"companies"},root:"results",id:"id",totalProperty:"total",fields:["id","name","city","email","phone","homepage","address","zip"],remoteSort:true});this.companySearchField=new GO.form.SearchField({store:this.companiesStore,width:320});this.companyGrid=new GO.grid.GridPanel({title:GO.addressbook.lang.companies,paging:true,border:false,store:this.companiesStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true},{header:GO.lang.strEmail,dataIndex:"email",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel(),tbar:[GO.lang.strSearch+": "," ",this.companySearchField]});this.companyGrid.on("show",function(){this.companiesStore.load()},this);A.push(this.contactsGrid);A.push(this.companyGrid)}if(GO.mailings){this.mailingsGrid=new GO.grid.GridPanel({title:GO.mailings.lang.cmdPanelMailings,paging:true,border:false,store:GO.mailings.readableMailingsStore,view:new Ext.grid.GridView({autoFill:true,forceFit:true}),columns:[{header:GO.lang.strName,dataIndex:"name",css:"white-space:normal;",sortable:true}],sm:new Ext.grid.RowSelectionModel()});this.mailingsGrid.on("show",function(){GO.mailings.readableMailingsStore.load()},this);A.push(this.mailingsGrid)}this.tabPanel=new Ext.TabPanel({activeTab:0,items:A,border:false});GO.email.AddressbookDialog.superclass.constructor.call(this,{layout:"fit",modal:false,height:400,width:600,closeAction:"hide",title:GO.addressbook.lang.addressbook,items:this.tabPanel,buttons:[{text:GO.email.lang.addToRecipients,handler:function(){this.addRecipients("to")},scope:this},{text:GO.email.lang.addToCC,handler:function(){this.addRecipients("cc")},scope:this},{text:GO.email.lang.addToBCC,handler:function(){this.addRecipients("bcc")},scope:this},{text:GO.lang.cmdClose,handler:function(){this.hide()},scope:this}]});this.addEvents({addrecipients:true})};Ext.extend(GO.email.AddressbookDialog,Ext.Window,{addRecipients:function(E){var F="";var D=this.tabPanel.getLayout().activeItem;var B=D.selModel.getSelections();if(this.mailingsGrid&&D==this.mailingsGrid){var C=[];for(var A=0;A<B.length;A++){C.push(B[A].data.id)}this.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.mailings.url+"json.php",params:{task:"mailing_group_string",mailing_groups:C.join(",")},callback:function(I,J,H){F=H.responseText;this.fireEvent("addrecipients",E,F);this.el.unmask()},scope:this})}else{var G=[];for(var A=0;A<B.length;A++){G.push('"'+B[A].data.name+'" <'+B[A].data.email+">")}F=G.join(", ");this.fireEvent("addrecipients",E,F)}}});GO.email.EmailComposer=function(D){Ext.apply(D);var G=Ext.id();var E=[this.notifyCheck=new Ext.menu.CheckItem({text:GO.email.lang.notification,checked:false,checkHandler:function(I,J){this.sendParams.notification=J?"true":"false"},scope:this}),"-",'<div class="menu-title"><img class="x-menu-item-icon" src="'+Ext.BLANK_IMAGE_URL+'" />'+GO.email.lang.priority+"</div>",{text:GO.email.lang.high,checked:false,group:G,checkHandler:function(){this.sendParams.priority="1"},scope:this},this.normalPriorityCheck=new Ext.menu.CheckItem({text:GO.email.lang.normal,checked:true,group:G,checkHandler:function(){this.sendParams.priority="3"},scope:this}),{text:GO.email.lang.low,checked:false,group:G,checkHandler:function(){this.sendParams.priority="5"},scope:this},"-",this.htmlCheck=new Ext.menu.CheckItem({text:GO.email.lang.htmlMarkup,checked:GO.email.useHtmlMarkup,listeners:{checkchange:function(I,J){if(this.bodyContentAtWindowOpen==this.editor.getValue()||confirm(GO.email.lang.confirmLostChanges)){this.setContentTypeHtml(J);this.showConfig.keepEditingMode=true;delete this.showConfig.move;this.show(this.showConfig)}else{I.setChecked(!J,true)}},scope:this}})];if(GO.gnupg){E.push("-");E.push(this.encryptCheck=new Ext.menu.CheckItem({text:GO.gnupg.lang.encryptMessage,checked:false,listeners:{checkchange:function(I,J){if(this.formPanel.baseParams.content_type=="html"){if(!confirm(GO.gnupg.lang.confirmChangeToText)){I.setChecked(!J,true);return false}else{this.setContentTypeHtml(false);this.htmlCheck.setChecked(false,true);this.showConfig.keepEditingMode=true;this.show(this.showConfig)}}this.htmlCheck.setDisabled(J);this.sendParams.encrypt=J?"1":"0";return true},scope:this}}))}this.optionsMenu=new Ext.menu.Menu({items:E});this.showMenu=new Ext.menu.Menu({items:[this.formFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.sender,checked:true,checkHandler:this.onShowFieldCheck,scope:this}),this.ccFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.ccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this}),this.bccFieldCheck=new Ext.menu.CheckItem({text:GO.email.lang.bccField,checked:false,checkHandler:this.onShowFieldCheck,scope:this})]});var F=new GO.plugins.HtmlEditorImageInsert();F.on("insert",function(I){this.inline_attachments.push({tmp_file:I.selectedPath,url:I.selectedUrl})},this);var B=[this.fromCombo=new Ext.form.ComboBox({store:GO.email.aliasesStore,fieldLabel:GO.email.lang.from,name:"alias_name",anchor:"100%",displayField:"name",valueField:"id",hiddenName:"alias_id",forceSelection:true,triggerAction:"all",mode:"local",tpl:'<tpl for="."><div class="x-combo-list-item">{name:htmlEncode}</div></tpl>',listeners:{beforeselect:function(J,N){var L=J.store.getById(J.getValue());var K=L.get(this.formPanel.baseParams.content_type+"_signature");var M=N.get(this.formPanel.baseParams.content_type+"_signature");var I=this.editor.getValue();if(GO.util.empty(K)){this.addSignature(N)}else{this.editor.setValue(I.replace(K,M))}},scope:this}}),this.toCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.sendTo,name:"to",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email"}),this.ccCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.cc,name:"cc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false}),this.bccCombo=new GO.form.ComboBoxMulti({sep:",",fieldLabel:GO.email.lang.bcc,name:"bcc",anchor:"100%",height:50,store:new Ext.data.JsonStore({url:BaseHref+"json.php",baseParams:{task:"email"},fields:["full_email"],root:"persons"}),displayField:"full_email",hideTrigger:true,minChars:2,triggerAction:"all",selectOnFocus:false})];var C=-113;if(GO.mailings){this.selectLinkField=new GO.form.SelectLink({anchor:"100%"});C+=26;B.push(this.selectLinkField)}B.push(this.subjectField=new Ext.form.TextField({fieldLabel:GO.email.lang.subject,name:"subject",anchor:"100%"}));B.push(this.htmlEditor=new Ext.form.HtmlEditor({hideLabel:true,name:"body",anchor:"100% "+C,plugins:F}));B.push(this.textEditor=new Ext.form.TextArea({name:"textbody",anchor:"100% "+C,hideLabel:true}));this.formPanel=new Ext.form.FormPanel({border:false,labelWidth:100,waitMsgTarget:true,baseParams:{content_type:"html"},cls:"go-form-panel",url:"save-form.php",defaultType:"textfield",items:B});this.htmlEditor.on("push",function(){this.bodyContentAtWindowOpen=this.htmlEditor.getValue()},this,{single:true});this.attachmentsStore=new Ext.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"attachments"},root:"results",fields:["tmp_name","name","size","type"],id:"tmp_name"});this.attachmentsStore.on("remove",this.updateAttachmentsButton,this);this.attachmentsStore.on("load",this.updateAttachmentsButton,this);if(GO.mailings){this.templatesStore=new GO.data.JsonStore({url:GO.settings.modules.mailings.url+"json.php",baseParams:{task:"authorized_templates"},root:"results",totalProperty:"total",id:"id",fields:["id","name","default_template"],remoteSort:true});this.templatesList=new GO.email.TemplatesList({store:this.templatesStore});this.templatesList.on("click",function(I,J){this.showConfig.template_id=J>0?I.store.data.items[J-1].id:0;if(this.templateDefault.checked){this.templatesStore.baseParams.default_template_id=this.showConfig.template_id;this.templatesStore.load();delete this.templatesStore.baseParams.default_template_id;this.templateDefault.setValue(false)}this.show(this.showConfig);this.templatesWindow.hide();this.templatesList.clearSelections()},this);this.defaultTemplatePanel=new Ext.FormPanel({autoHeight:true,cls:"go-form-panel",region:"south",items:[this.templateDefault=new Ext.form.Checkbox({name:"templateDefault",boxLabel:GO.email.lang.defaultTemplate,anchor:"100%",hideLabel:true,checked:false})]});this.templatesWindow=new Ext.Window({title:GO.email.lang.selectTemplate,layout:"border",modal:false,height:400,width:600,closable:true,closeAction:"hide",items:[new Ext.Panel({region:"center",autoScroll:true,items:[this.templatesList],cls:"go-form-panel"}),this.defaultTemplatePanel]})}var H=[this.sendButton=new Ext.Button({text:GO.email.lang.send,iconCls:"btn-send",handler:function(){this.sendMail()},scope:this}),{text:GO.email.lang.extraOptions,iconCls:"btn-settings",menu:this.optionsMenu},this.showMenuButton=new Ext.Button({text:GO.email.lang.show,iconCls:"btn-show",menu:this.showMenu}),this.attachmentsButton=new Ext.Button({text:GO.email.lang.attachments,iconCls:"btn-attach",handler:this.showAttachmentsDialog,scope:this}),this.saveButton=new Ext.Button({iconCls:"btn-save",text:GO.lang.cmdSave,handler:function(){this.sendMail(true)},scope:this})];if(GO.addressbook){H.push({text:GO.addressbook.lang.addressbook,iconCls:"btn-addressbook",handler:function(){if(!this.addressbookDialog){this.addressbookDialog=new GO.email.AddressbookDialog();this.addressbookDialog.on("addrecipients",function(L,J){var K=this.formPanel.form.findField(L);var I=K.getValue();if(I!=""&&I.substring(I.length-1,I.length)!=","&&I.substring(I.length-2,I.length-1)!=","){I+=", "}I+=J;K.setValue(I);if(L=="cc"){this.ccFieldCheck.setChecked(true)}else{if(L=="bcc"){this.bccFieldCheck.setChecked(true)}}},this)}this.addressbookDialog.show()},scope:this})}var A=function(){this.toCombo.focus()};GO.email.EmailComposer.superclass.constructor.call(this,{title:GO.email.lang.composeEmail,width:700,height:500,minWidth:300,minHeight:200,layout:"fit",maximizable:true,collapsible:true,plain:true,closeAction:"hide",buttonAlign:"center",focus:A.createDelegate(this),tbar:H,items:this.formPanel});this.addEvents({send:true})};Ext.extend(GO.email.EmailComposer,Ext.Window,{showConfig:{},autoSaveTask:{},lastAutoSave:false,bodyContentAtWindowOpen:false,setContentTypeHtml:function(A){this.formPanel.baseParams.content_type=A?"html":"plain";this.htmlEditor.getEl().up(".x-form-item").setDisplayed(A);this.textEditor.getEl().up(".x-form-item").setDisplayed(!A);this.editor=A?this.htmlEditor:this.textEditor},autoSave:function(){if(GO.util.empty(this.sendParams.mailing_group_id)&&this.lastAutoSave&&this.lastAutoSave!=this.editor.getValue()){this.sendMail(true,true)}this.lastAutoSave=this.editor.getValue()},startAutoSave:function(){this.lastAutoSave=false;Ext.TaskMgr.start(this.autoSaveTask)},stopAutoSave:function(){Ext.TaskMgr.stop(this.autoSaveTask)},afterRender:function(){GO.email.EmailComposer.superclass.afterRender.call(this);this.autoSaveTask={run:this.autoSave,scope:this,interval:120000};this.on("hide",this.stopAutoSave,this)},toComboVisible:true,updateAttachmentsButton:function(){var A=this.attachmentsStore.getCount()>0?GO.email.lang.attachments+" ("+this.attachmentsStore.getCount()+")":GO.email.lang.attachments;this.attachmentsButton.setText(A)},reset:function(){this.sendParams={task:"sendmail",notification:"false",priority:"3",draft_uid:0,inline_attachments:{}};this.inline_attachments=Array();this.formPanel.form.reset();if(this.defaultAcccountId){this.fromCombo.setValue(this.defaultAcccountId)}this.notifyCheck.setChecked(false);this.normalPriorityCheck.setChecked(true);if(this.attachmentsGrid){this.attachmentsGrid.store.loadData({results:[]})}},showCC:function(A){this.ccCombo.getEl().up(".x-form-item").setDisplayed(A);if(A){this.ccCombo.onResize()}},showBCC:function(A){this.bccCombo.getEl().up(".x-form-item").setDisplayed(A);if(A){this.bccCombo.onResize()}},show:function(C){this.showConfig=C;if(!this.rendered){this.fromCombo.store.on("load",function(){var G=this.fromCombo.store.getRange();if(G.length){if(!C.account_id){C.account_id=G[0].data.account_id}this.render(Ext.getBody());this.show(C);this.showCC(false);this.showBCC(false);return }else{Ext.Msg.alert(GO.email.lang.noAccountTitle,GO.email.lang.noAccount)}},this,{single:true});if(!GO.mailings){C.template_id=0;this.fromCombo.store.load()}else{this.templatesStore.load({callback:function(){this.fromCombo.store.load()},scope:this})}}else{if(C.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()>1){this.showConfig=C;this.templatesWindow.show()}else{this.updateAttachmentsButton();if(C.template_id==undefined&&this.templatesStore&&this.templatesStore.getTotalCount()==1){C.template_id=this.templatesStore.data.items[0].get("id")}this.attachmentsStore.removeAll();this.inline_attachments=[];this.reset();var B=-1;if(C.account_id){B=this.fromCombo.store.find("account_id",C.account_id)}if(B==-1){B=0}this.fromCombo.setValue(this.fromCombo.store.data.items[B].id);if(C.values){this.formPanel.form.setValues(C.values)}GO.email.EmailComposer.superclass.show.call(this);if(!C.keepEditingMode){this.setContentTypeHtml(GO.email.useHtmlMarkup);this.htmlCheck.setChecked(GO.email.useHtmlMarkup,true);if(this.encryptCheck){this.encryptCheck.setChecked(false,true)}}this.toComboVisible=true;this.showMenuButton.setDisabled(false);this.toCombo.getEl().up(".x-form-item").setDisplayed(true);this.sendURL=GO.settings.modules.email.url+"action.php";this.saveButton.setDisabled(false);if(C.move){var F=this.getPosition();this.setPagePosition(F[0]+C.move,F[1]+C.move)}if(C.mailing_group_id>0){this.sendURL=GO.settings.modules.mailings.url+"action.php";this.toComboVisible=false;this.showMenuButton.setDisabled(true);this.toCombo.getEl().up(".x-form-item").setDisplayed(false);this.showCC(false);this.showBCC(false);this.sendParams.mailing_group_id=C.mailing_group_id;this.saveButton.setDisabled(true)}if(C.uid||C.template_id||C.loadUrl){if(!C.task){C.task="template"}if(C.task=="opendraft"){this.sendParams.draft_uid=C.uid}var D=this.fromCombo.store.getById(this.fromCombo.getValue());var E=C.loadParams?C.loadParams:{uid:C.uid,account_id:D.get("account_id"),task:C.task,mailbox:C.mailbox};if(C.mailing_group_id>0){E.mailing_group_id=C.mailing_group_id}if(C.template_id>0){E.template_id=C.template_id;E.to=this.toCombo.getValue()}var A=C.loadUrl?C.loadUrl:GO.settings.modules.email.url+"json.php";delete E.content_type;this.formPanel.form.load({url:A,params:E,waitMsg:GO.lang.waitMsgLoad,failure:function(G,H){Ext.Msg.alert(GO.lang.strError,H.result.feedback)},success:function(G,H){if(C.task=="reply"||C.task=="reply_all"){this.sendParams.reply_uid=C.uid;this.sendParams.reply_mailbox=C.mailbox}if(H.result.data.inline_attachments){this.inline_attachments=H.result.data.inline_attachments}if(H.result.data.attachments){this.attachmentsStore.loadData({results:H.result.data.attachments},true)}this.afterShowAndLoad(E.task!="opendraft")},scope:this})}else{this.afterShowAndLoad(true)}}}},afterShowAndLoad:function(A){this.bccFieldCheck.setChecked(this.bccCombo.getValue()!="");this.ccFieldCheck.setChecked(this.ccCombo.getValue()!="");if(A){this.addSignature()}if(this.formPanel.baseParams.content_type=="plain"){this.editor.selectText(0,0)}if(this.toCombo.getValue()==""){this.toCombo.focus()}else{this.editor.focus()}this.setEditorHeight();this.startAutoSave();this.bodyContentAtWindowOpen=this.editor.getValue()},addSignature:function(A){A=A||this.fromCombo.store.getById(this.fromCombo.getValue());var B=A.get(this.formPanel.baseParams.content_type+"_signature");if(!GO.util.empty(B)){if(this.formPanel.baseParams.content_type=="plain"){B="\n"+B+"\n"}else{B="<br />"+B+"<br />"}}this.editor.setValue(B+this.editor.getValue())},showAttachmentsDialog:function(){if(!this.attachmentsDialog){var B=[];B.push({iconCls:"btn-add",text:GO.email.lang.attachFilesPC,cls:"x-btn-text-icon",handler:function(){this.uploadDialog.show()},scope:this});if(GO.files){B.push({iconCls:"btn-add",text:GO.email.lang.attachFilesGO,cls:"x-btn-text-icon",handler:function(){if(!this.fileBrowser){this.fileBrowser=new GO.files.FileBrowser({border:false,fileClickHandler:this.addRemoteFiles,scope:this});this.fileBrowserWindow=new Ext.Window({title:GO.lang.strSelectFiles,height:480,width:680,layout:"fit",border:false,closeAction:"hide",items:this.fileBrowser,buttons:[{text:GO.lang.cmdOk,handler:this.addRemoteFiles,scope:this},{text:GO.lang.cmdClose,handler:function(){this.fileBrowserWindow.hide()},scope:this}]})}this.fileBrowserWindow.show()},scope:this})}B.push({iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:function(){var D=this.attachmentsGrid.selModel.getSelections();for(var C=0;C<D.length;C++){this.attachmentsStore.remove(D[C])}},scope:this});this.attachmentsGrid=new GO.grid.GridPanel({store:this.attachmentsStore,loadMask:true,columns:[{header:GO.lang.strName,dataIndex:"name"},{header:GO.lang.strSize,dataIndex:"size",renderer:function(C){return Ext.util.Format.fileSize(C)}},{header:GO.lang.strType,dataIndex:"type"}],sm:new Ext.grid.RowSelectionModel({singleSelect:false}),view:new Ext.grid.GridView({forceFit:true,autoFill:true}),tbar:B});this.attachmentsDialog=new Ext.Window({title:GO.email.lang.attachments,layout:"fit",modal:false,closeAction:"hide",minWidth:300,minHeight:300,height:400,width:600,items:this.attachmentsGrid,buttons:[{text:GO.lang.cmdClose,handler:function(){this.attachmentsDialog.hide()},scope:this}]});var A=new GO.form.UploadFile({inputName:"attachments",addText:GO.lang.smallUpload});this.upForm=new Ext.form.FormPanel({fileUpload:true,waitMsgTarget:true,items:[A,new Ext.Button({text:GO.lang.largeUpload,handler:function(){if(!deployJava.isWebStartInstalled("1.5.0")){Ext.MessageBox.alert(GO.lang.strError,GO.lang.noJava)}else{var C=this.local_path?"true":false;window.open(GO.settings.modules.email.url+"jupload/index.php");this.uploadDialog.hide();GO.attachmentsStore=this.attachmentsStore}},scope:this})],cls:"go-form-panel"});this.uploadDialog=new Ext.Window({title:GO.email.lang.uploadAttachments,layout:"fit",modal:false,height:300,width:300,items:this.upForm,closeAction:"hide",buttons:[{text:GO.email.lang.startTransfer,handler:function(){this.upForm.form.submit({waitMsg:GO.lang.waitMsgUpload,url:GO.settings.modules.email.url+"action.php",params:{task:"attach_file"},success:function(C,D){this.attachmentsStore.loadData({results:D.result.files},true);A.clearQueue();this.uploadDialog.hide()},scope:this})},scope:this},{text:GO.lang.cmdClose,handler:function(){this.uploadDialog.hide()},scope:this}]})}this.attachmentsDialog.show()},addRemoteFiles:function(){var A=Ext.data.Record.create([{name:"tmp_name"},{name:"id"},{name:"name"},{name:"type"},{name:"size"}]);var D=this.fileBrowser.getSelectedGridRecords();for(var C=0;C<D.length;C++){var B=new A({id:D[C].data.id,tmp_name:D[C].data.id,name:D[C].data.name,type:D[C].data.type,size:D[C].data.size});B.id=D[C].data.path;this.attachmentsStore.add(B)}this.updateAttachmentsButton();this.fileBrowserWindow.hide()},sendMail:function(B,D){if(this.uploadDialog&&this.uploadDialog.isVisible()){alert(GO.email.lang.closeUploadDialog);this.attachmentsDialog.show();this.uploadDialog.show();return false}if(D||this.subjectField.getValue()!=""||confirm(GO.email.lang.confirmEmptySubject)){if(this.attachmentsDialog&&this.attachmentsDialog.isVisible()){this.attachmentsDialog.hide()}if(this.attachmentsStore&&this.attachmentsStore.data.keys.length){var A=[];var C=this.attachmentsStore.getRange();for(var E=0;E<C.length;E++){A.push(Ext.util.Format.htmlDecode(C[E].get("tmp_name")))}this.sendParams.attachments=Ext.encode(A)}this.sendParams.inline_attachments=Ext.encode(this.inline_attachments);this.sendParams.draft=B;this.htmlEditor.syncValue();this.saveButton.setDisabled(true);this.sendButton.setDisabled(true);this.formPanel.form.submit({url:this.sendURL,params:this.sendParams,waitMsg:D?null:GO.lang.waitMsgSave,waitMsgTarget:D?null:this.formPanel.body,success:function(F,G){this.saveButton.setDisabled(false);this.sendButton.setDisabled(false);if(G.result.account_id){this.account_id=G.result.account_id}if(!B){if(this.callback){if(!this.scope){this.scope=this}var H=this.callback.createDelegate(this.scope);H.call()}if(GO.addressbook&&G.result.unknown_recipients&&G.result.unknown_recipients.length){if(!GO.email.unknownRecipientsDialog){GO.email.unknownRecipientsDialog=new GO.email.UnknownRecipientsDialog()}GO.email.unknownRecipientsDialog.store.loadData({recipients:G.result.unknown_recipients});GO.email.unknownRecipientsDialog.show()}this.fireEvent("send",this);this.hide()}else{this.sendParams.draft_uid=G.result.draft_uid;this.fireEvent("save",this)}},failure:function(G,H){if(!D){var F=H.result&&H.result.feedback?H.result.feedback:GO.lang.strRequestError;Ext.MessageBox.alert(GO.lang.strError,F)}this.saveButton.setDisabled(false);this.sendButton.setDisabled(false)},scope:this})}else{this.subjectField.focus()}},onShowFieldCheck:function(A,B){switch(A.id){case this.formFieldCheck.id:this.fromCombo.getEl().up(".x-form-item").setDisplayed(B);break;case this.ccFieldCheck.id:this.showCC(B);break;case this.bccFieldCheck.id:this.showBCC(B);break}this.setEditorHeight()},setEditorHeight:function(){var C=this.subjectField.getEl().up(".x-form-item");var B=C.getHeight()+C.getMargins("tb");if(GO.mailings){var A=this.selectLinkField.getEl().up(".x-form-item");B+=A.getHeight()+A.getMargins("tb")}if(this.toComboVisible){var G=this.toCombo.getEl().up(".x-form-item");B+=G.getHeight()+G.getMargins("tb")}var F;for(var E=0;E<this.showMenu.items.items.length;E++){if(this.showMenu.items.items[E].checked){if(E==0){F=this.fromCombo.getEl().up(".x-form-item")}else{F=this.toCombo.getEl().up(".x-form-item")}B+=F.getHeight()+F.getMargins("tb")}}B+=4;var D="100% -"+B;this.htmlEditor.anchor=D;delete this.htmlEditor.anchorSpec;this.textEditor.anchor=D;delete this.textEditor.anchorSpec;this.htmlEditor.syncSize();this.formPanel.doLayout()}});GO.email.TemplatesList=function(B){Ext.apply(B);var A=new Ext.XTemplate('<div id="template-0" class="go-item-wrap">'+GO.mailings.lang.noTemplate+"</div>",'<tpl for=".">','<div id="template-{id}" class="go-item-wrap"">{name}</div>','<tpl if="!GO.util.empty(default_template)"><div class="ml-template-default-spacer"></div></tpl>',"</tpl>");GO.email.TemplatesList.superclass.constructor.call(this,{store:B.store,tpl:A,singleSelect:true,autoHeight:true,overClass:"go-view-over",itemSelector:"div.go-item-wrap",selectedClass:"go-view-selected"})};Ext.extend(GO.email.TemplatesList,Ext.DataView,{onRender:function(B,A){this.el=B.createChild({tag:"div",cls:"go-select-list"});GO.email.TemplatesList.superclass.onRender.apply(this,arguments)}});Ext.namespace("GO.email");GO.email.EmailClient=function(C){if(!C){C={}}this.messagesStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{node:"",type:"messages"},root:"results",totalProperty:"total",id:"uid",fields:["uid","icon","flagged","attachments","new","subject","from","sender","size","date","priority","answered"],remoteSort:true});this.messagesStore.setDefaultSort("date","DESC");var B=Ext.state.Manager.get("em-msgs-top");if(B){B=Ext.decode(B)}else{B=screen.width<1024}this.leftMessagesGrid=new GO.email.MessagesGrid({id:"em-pnl-west",store:this.messagesStore,width:420,region:"west",hidden:B});this.addGridHandlers(this.leftMessagesGrid);this.topMessagesGrid=new GO.email.MessagesGrid({id:"em-pnl-north",store:this.messagesStore,height:250,region:"north",hidden:!B});this.addGridHandlers(this.topMessagesGrid);if(!this.topMessagesGrid.hidden){this.messagesGrid=this.topMessagesGrid}else{this.messagesGrid=this.leftMessagesGrid}GO.email.messagesGrid=this.messagesGrid;this.messagesGrid.store.on("load",function(){var H=this.topMessagesGrid.getColumnModel();var M=this.messagesGrid.store.reader.jsonData.sent?GO.email.lang.to:GO.email.lang.from;H.setColumnHeader(1,M);var L=this.messagesGrid.store.reader.jsonData.unseen;for(var I in L){this.updateFolderStatus(I,L[I])}if(this.messagesGrid.store.baseParams.query&&this.messagesGrid.store.baseParams.query!=""){this.resetSearchButton.setVisible(true)}else{this.resetSearchButton.setVisible(false)}var J=this.treePanel.getSelectionModel();if(!J.getSelectedNode()){var K=this.treePanel.getNodeById("folder_"+this.messagesGrid.store.reader.jsonData.folder_id);if(K){J.select(K)}}},this);GO.email.saveAsItems=GO.email.saveAsItems||[];for(var E=0;E<GO.email.saveAsItems.length;E++){GO.email.saveAsItems[E].scope=this}var D=[{text:GO.email.lang.markAsRead,handler:function(){this.doTaskOnMessages("mark_as_read")},scope:this,multiple:true},{text:GO.email.lang.markAsUnread,handler:function(){this.doTaskOnMessages("mark_as_unread")},scope:this,multiple:true},{text:GO.email.lang.flag,handler:function(){this.doTaskOnMessages("flag")},scope:this,multiple:true},{text:GO.email.lang.unflag,handler:function(){this.doTaskOnMessages("unflag")},scope:this,multiple:true},"-",{text:GO.email.lang.viewSource,handler:function(){var H=this.messagesGrid.selModel.getSelected();if(H){var I=window.open(GO.settings.modules.email.url+"source.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+encodeURIComponent(H.data.uid));I.focus()}},scope:this},"-",{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:this.deleteMessages,scope:this,multiple:true},"-",{iconCls:"btn-add",text:GO.email.lang.addSendersTo,cls:"x-btn-text-icon",menu:{items:[{text:GO.email.lang.to,field:"to",handler:this.addSendersTo,scope:this},{text:"CC",field:"cc",handler:this.addSendersTo,scope:this},{text:"BCC",field:"bcc",handler:this.addSendersTo,scope:this}]},multiple:true}];if(GO.email.saveAsItems&&GO.email.saveAsItems.length){this.saveAsMenu=new Ext.menu.Menu({items:GO.email.saveAsItems});this.saveAsMenu.on("show",function(L){var M=this.messagesGrid.getSelectionModel();var H=M.getSelections().length>1;var J=M.getSelections().length==0;for(var I=0;I<L.items.getCount();I++){var K=L.items.get(I);K.setDisabled(J||(!K.multiple&&H))}},this);D.push({iconCls:"btn-save",text:GO.lang.cmdSaveAs,menu:this.saveAsMenu,multiple:true})}this.gridContextMenu=new GO.menu.RecordsContextMenu({shadow:"frame",minWidth:180,items:D});this.treePanel=new GO.email.AccountsTree({id:"email-tree-panel",region:"west"});var A=new Ext.tree.AsyncTreeNode({text:GO.email.lang.accounts,draggable:false});this.treePanel.setRootNode(A);this.treeContextMenu=new Ext.menu.Menu({items:[this.addFolderButton=new Ext.menu.Item({iconCls:"btn-add",text:GO.email.lang.addFolder,handler:function(){Ext.MessageBox.prompt(GO.lang.strName,GO.email.lang.enterFolderName,function(H,J){if(H=="ok"){var K=this.treePanel.getSelectionModel();var I=K.getSelectedNode();Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"add_folder",folder_id:I.attributes.folder_id,account_id:I.attributes.account_id,new_folder_name:J},callback:function(M,O,L){if(!O){Ext.MessageBox.alert(GO.lang.strError,L.result.errors)}else{var N=Ext.decode(L.responseText);if(N.success){delete I.attributes.children;I.reload()}else{Ext.MessageBox.alert(GO.lang.strError,N.feedback)}}},scope:this})}},this)},scope:this}),"-",{iconCls:"btn-delete",text:GO.email.lang.emptyFolder,handler:function(){var J=this.treePanel.getSelectionModel();var I=J.getSelectedNode();var H=new Ext.Template(GO.email.lang.emptyFolderConfirm);Ext.MessageBox.confirm(GO.lang.strConfirm,H.applyTemplate(I.attributes),function(K){if(K=="yes"){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"empty_folder",account_id:I.attributes.account_id,mailbox:I.attributes.mailbox},callback:function(){if(I.attributes.mailbox==this.mailbox){this.messagesGrid.store.removeAll()}this.updateFolderStatus(I.attributes.folder_id);this.updateNotificationEl()},scope:this})}},this)},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",scope:this,handler:function(){var I=this.treePanel.getSelectionModel();var H=I.getSelectedNode();if(!H||H.attributes.folder_id<1){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.selectFolderDelete)}else{if(H.attributes.mailbox=="INBOX"){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.cantDeleteInboxFolder)}else{GO.deleteItems({url:GO.settings.modules.email.url+"action.php",params:{task:"delete_folder",folder_id:H.attributes.folder_id},callback:function(J){if(J.success){H.remove()}else{Ext.MessageBox.alert(GO.lang.strError,J.feedback)}},count:1,scope:this})}}}}]});this.treePanel.on("contextmenu",function(I,K){K.stopEvent();var H=this.treePanel.getSelectionModel();if(!H.isSelected(I)){H.clearSelections();H.select(I)}var J=K.getXY();this.addFolderButton.setDisabled(!I.attributes.canHaveChildren);this.treeContextMenu.showAt([J[0],J[1]])},this);this.treePanel.on("beforenodedrop",function(L){var J=L.data.selections,K=[];for(var I=0,H=J.length;I<H;I++){if(this.account_id!=L.target.attributes.account_id){Ext.MessageBox.alert(GO.lang.strError,GO.email.lang.crossAccountMove);return false}else{if(this.mailbox==L.target.mailbox){return false}else{K.push(J[I].id)}}}if(K.length>0){this.messagesGrid.store.baseParams.action="move";this.messagesGrid.store.baseParams.from_mailbox=this.mailbox;this.messagesGrid.store.baseParams.to_mailbox=L.target.attributes.mailbox;this.messagesGrid.store.baseParams.messages=Ext.encode(K);this.messagesGrid.store.reload();delete this.messagesGrid.store.baseParams.action;delete this.messagesGrid.store.baseParams.from_mailbox;delete this.messagesGrid.store.baseParams.to_mailbox;delete this.messagesGrid.store.baseParams.messages}},this);A.on("load",function(H){this.body.unmask();if(H.childNodes[0]){var I=H.childNodes[0];this.updateNotificationEl();I.on("load",function(J){if(J.childNodes[0]){var K=J.childNodes[0];this.setAccount(K.attributes.account_id,K.attributes.folder_id,K.attributes.mailbox,K.parentNode.attributes.usage);this.checkMail.defer(this.checkMailInterval,this)}},this,{single:true})}},this);this.treePanel.on("beforeclick",function(H){if(H.attributes.folder_id==0){return false}},this);this.treePanel.on("click",function(I){if(I.attributes.folder_id>0){var J="";var H=I;while(H.parentNode&&J==""){if(H.attributes.usage){J=H.attributes.usage}else{H=H.parentNode}}this.setAccount(I.attributes.account_id,I.attributes.folder_id,I.attributes.mailbox,J)}},this);this.searchDialog=new GO.email.SearchDialog({store:this.messagesGrid.store});var F=[{iconCls:"btn-accounts",text:GO.email.lang.accounts,cls:"x-btn-text-icon",handler:function(){this.showAccountsDialog()},scope:this},{iconCls:"btn-toggle-window",text:GO.email.lang.toggleWindowPosition,cls:"x-btn-text-icon",handler:function(){this.moveGrid()},scope:this}];if(GO.gnupg){F.push("-");F.push({iconCls:"go-menu-icon-gnupg",cls:"x-btn-text-icon",text:GO.gnupg.lang.encryptionSettings,handler:function(){if(!this.securityDialog){this.securityDialog=new GO.gnupg.SecurityDialog()}this.securityDialog.show()},scope:this})}var G=[{iconCls:"btn-compose",text:GO.email.lang.compose,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({account_id:this.account_id})},scope:this},{iconCls:"btn-delete",text:GO.lang.cmdDelete,cls:"x-btn-text-icon",handler:this.deleteMessages,scope:this},new Ext.Toolbar.Separator(),{iconCls:"btn-settings",text:GO.lang.cmdSettings,menu:{items:F}},{iconCls:"btn-refresh",text:GO.lang.cmdRefresh,cls:"x-btn-text-icon",handler:function(){this.refresh(true)},scope:this},{iconCls:"btn-search",text:GO.lang.strSearch,cls:"x-btn-text-icon",handler:function(){this.searchDialog.show()},scope:this},this.resetSearchButton=new Ext.Button({iconCls:"btn-delete",text:GO.email.lang.resetSearch,cls:"x-btn-text-icon",hidden:true,handler:function(){this.messagesGrid.store.baseParams.query="";this.messagesGrid.store.load({params:{start:0}})},scope:this}),"-",this.replyButton=new Ext.Button({disabled:true,iconCls:"btn-reply",text:GO.email.lang.reply,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"reply",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.replyAllButton=new Ext.Button({disabled:true,iconCls:"btn-reply-all",text:GO.email.lang.replyAll,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"reply_all",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.forwardButton=new Ext.Button({disabled:"true",iconCls:"btn-forward",text:GO.email.lang.forward,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({uid:this.messagePanel.uid,task:"forward",mailbox:this.mailbox,account_id:this.account_id})},scope:this}),this.printButton=new Ext.Button({disabled:true,iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){this.messagePanel.body.print()},scope:this})];if(GO.mailings){G.push({iconCls:"btn-save",text:GO.lang.cmdSaveAs,menu:this.saveAsMenu})}G.push(new Ext.Toolbar.Separator());G.push(this.closeMessageButton=new Ext.Button({hidden:true,iconCls:"btn-close",text:GO.lang.cmdClose,cls:"x-btn-text-icon",handler:function(){this.messagesGrid.expand()},scope:this}));C.layout="border";C.tbar=new Ext.Toolbar({cls:"go-head-tb",items:G});this.messagePanel=new GO.email.MessagePanel({id:"email-message-panel",region:"center",autoScroll:true,titlebar:false,border:true,attachmentContextMenu:new GO.email.AttachmentContextMenu({emailClient:this})});C.items=[this.treePanel,{region:"center",titlebar:false,layout:"border",items:[this.messagePanel,this.topMessagesGrid,this.leftMessagesGrid]}];this.messagePanel.on("load",function(J,K,I){if(!K){this.messagePanel.uid=0}else{this.replyAllButton.setDisabled(false);this.replyButton.setDisabled(false);this.forwardButton.setDisabled(false);this.printButton.setDisabled(false);var H=this.messagesGrid.store.getById(this.messagePanel.uid);if(H.data["new"]==1){this.incrementFolderStatus(this.folder_id,-1);H.set("new","0")}}},this);this.messagePanel.on("reset",function(){this.replyAllButton.setDisabled(true);this.replyButton.setDisabled(true);this.forwardButton.setDisabled(true);this.printButton.setDisabled(true)},this);this.messagePanel.on("linkClicked",function(H){var I=window.open(H);I.focus()},this);this.messagePanel.on("attachmentClicked",this.openAttachment,this);this.messagePanel.on("zipOfAttachmentsClicked",this.openZipOfAttachments,this);GO.email.searchSender=function(H){if(this.rendered){this.messagesGrid.store.baseParams.query='FROM "'+H+'"';this.messagesGrid.store.load({params:{start:0}});if(GO.mainLayout.tabPanel){GO.mainLayout.tabPanel.setActiveTab(this.id)}}else{alert(GO.email.lang.loadEmailFirst)}};GO.email.searchSender=GO.email.searchSender.createDelegate(this);GO.email.EmailClient.superclass.constructor.call(this,C)};Ext.extend(GO.email.EmailClient,Ext.Panel,{moveGrid:function(){if(this.topMessagesGrid.isVisible()){this.messagesGrid=this.leftMessagesGrid;this.topMessagesGrid.hide()}else{this.messagesGrid=this.topMessagesGrid;this.leftMessagesGrid.hide()}this.messagesGrid.show();this.messagesGrid.ownerCt.doLayout();Ext.state.Manager.set("em-msgs-top",Ext.encode(this.topMessagesGrid.isVisible()))},addGridHandlers:function(A){A.on("rowcontextmenu",function(B,E,D){var C=D.getXY();this.gridContextMenu.showAt([C[0],C[1]],B.getSelectionModel().getSelections())},this);A.on("collapse",function(){this.closeMessageButton.setVisible(true)},this);A.on("expand",function(){this.closeMessageButton.setVisible(false)},this);A.on("rowdblclick",function(){if(this.messagesGrid.store.reader.jsonData.drafts){GO.email.showComposer({uid:this.messagePanel.uid,task:"opendraft",template_id:0,mailbox:this.mailbox,account_id:this.account_id})}else{this.messagesGrid.collapse()}},this);A.on("delayedrowselect",function(B,D,C){if(C.data.uid!=this.messagePanel.uid){this.messagePanel.loadMessage(C.data.uid,this.mailbox,this.account_id)}},this)},checkMailInterval:300000,justMarkedUnread:0,deleteMessages:function(){this.messagesGrid.deleteSelected({callback:function(A){var C=Ext.decode(A.params.delete_keys);for(var B=0;B<C.length;B++){if(this.messagePanel.uid==C[B]){this.messagePanel.reset()}}},scope:this})},afterRender:function(){GO.email.EmailClient.superclass.afterRender.call(this);this.body.mask(GO.lang.waitMsgLoad);var A=Ext.get("notification-area");if(A){this.notificationEl=A.createChild({id:"ml-notify",tag:"a",href:"#",style:"display:none"});this.notificationEl.on("click",function(){this.show()},this)}},onShow:function(){if(this.notificationEl){this.notificationEl.setDisplayed(false)}GO.email.EmailClient.superclass.onShow.call(this)},updateNotificationEl:function(){if(this.notificationEl){var B=this.treePanel.getRootNode();var D=0;for(var A=0;A<B.childNodes.length;A++){D+=B.childNodes[A].attributes.inbox_new}var C=this.notificationEl.dom.innerHTML;if(C!=""&&D-this.justMarkedUnread>C){GO.playAlarm();this.notificationEl.setDisplayed(!this.isVisible())}this.notificationEl.update(D);this.justMarkedUnread=0}},saveAttachment:function(A){if(!GO.files.saveAsDialog){GO.files.saveAsDialog=new GO.files.SaveAsDialog()}GO.files.saveAsDialog.show({filename:A.name,handler:function(D,B,C){D.el.mask(GO.lang.waitMsgLoad);Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"save_attachment",uid:this.messagePanel.uid,mailbox:this.mailbox,part:A.number,transfer:A.transfer,mime:A.mime,account_id:this.account_id,uuencoded_partnumber:A.uuencoded_partnumber,folder_id:B,filename:C},callback:function(F,H,E){D.el.unmask();if(!H){alert(GO.lang.strRequestError)}else{var G=Ext.decode(E.responseText);if(!G.success){alert(G.feedback)}else{D.hide()}}},scope:this})},scope:this})},openAttachment:function(H,B,G){if(H.mime.indexOf("message")>-1){GO.linkHandlers[9].call(this,0,{uid:this.messagePanel.uid,mailbox:this.mailbox,part:H.number,transfer:H.transfer,mime:H.mime,account_id:this.account_id})}else{switch(H.extension){case"dat":document.location.href=GO.settings.modules.email.url+"tnef.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&part="+H.number+"&transfer="+H.transfer+"&mime="+H.mime+"&uuencoded_partnumber="+H.uuencoded_partnumber+"&filename="+encodeURIComponent(H.name);break;case"asc":if(!G&&GO.gnupg){Ext.Ajax.request({url:GO.settings.modules.gnupg.url+"action.php",params:{task:"check_public_key_attachment",account_id:this.account_id,mailbox:this.mailbox,uid:this.messagePanel.uid,part:H.number,uuencoded_partnumber:H.uuencoded_partnumber,transfer:H.transfer},callback:function(K,L,J){if(L){var I=Ext.decode(J.responseText);if(!I.is_public_key){document.location.href=GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&sender="+this.messagePanel.data.sender+"&part="+H.number+"&transfer="+H.transfer+"&mime="+H.mime+"&uuencoded_partnumber="+H.uuencoded_partnumber+"&filename="+encodeURIComponent(H.name)}else{if(confirm(GO.gnupg.lang.importPublicKeyAttachment)){Ext.Ajax.request({url:GO.settings.modules.gnupg.url+"action.php",params:{task:"import_public_key_attachment"},callback:function(O,P,N){if(P){var M=Ext.decode(N.responseText);alert(M.feedback)}else{alert(GO.lang.strRequestError)}}})}}}},scope:this});break}case"vcs":case"ics":if(!G){Ext.Ajax.request({url:GO.settings.modules.email.url+"json.php",params:{task:"icalendar_attachment",account_id:this.account_id,mailbox:this.mailbox,uid:this.messagePanel.uid,part:H.number,uuencoded_partnumber:H.uuencoded_partnumber,transfer:H.transfer},callback:function(K,L,J){if(L){var I=Ext.decode(J.responseText);if(!I.success){alert(I.feedback)}else{GO.calendar.eventDialog.show({values:I})}}else{alert(GO.lang.strRequestError)}},scope:this});break}case"bmp":case"png":case"gif":case"jpg":case"jpeg":if(GO.files&&!G){if(!this.imageViewer){this.imageViewer=new GO.files.ImageViewer({closeAction:"hide"})}var C=0;var A=Array();if(B){for(var D=0;D<B.data.attachments.length;D++){var F=B.data.attachments[D];var E=GO.util.getFileExtension(F.name);if(E=="jpg"||E=="png"||E=="gif"||E=="bmp"||E=="jpeg"){A.push({name:F.name,src:GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&part="+F.number+"&transfer="+F.transfer+"&mime="+F.mime+"&uuencoded_partnumber="+H.uuencoded_partnumber+"&filename="+encodeURIComponent(F.name)})}if(F.name==H.name){C=A.length-1}}this.imageViewer.show(A,C);break}}default:document.location.href=GO.settings.modules.email.url+"attachment.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid+"&sender="+this.messagePanel.data.sender+"&part="+H.number+"&transfer="+H.transfer+"&mime="+H.mime+"&uuencoded_partnumber="+H.uuencoded_partnumber+"&filename="+encodeURIComponent(H.name);break}}},openZipOfAttachments:function(){document.location.href=GO.settings.modules.email.url+"zip_attachments.php?account_id="+this.account_id+"&mailbox="+encodeURIComponent(this.mailbox)+"&uid="+this.messagePanel.uid},showComposer:function(A){GO.email.showComposer({account_id:this.account_id,values:A})},setAccount:function(B,A,D,C){if(A!=this.folder_id){this.messagePanel.reset();this.messagesGrid.getSelectionModel().clearSelections()}this.messagesGrid.expand();this.account_id=B;this.folder_id=A;this.mailbox=D;this.messagesGrid.store.baseParams.task="messages";this.messagesGrid.store.baseParams.account_id=B;this.messagesGrid.store.baseParams.folder_id=A;this.messagesGrid.store.baseParams.mailbox=D;this.messagesGrid.store.load({params:{start:0}});this.treePanel.setUsage(C)},updateFolderStatus:function(A,F){var B=Ext.get("status_"+A);var G=false;var C=this.treePanel.getNodeById("folder_"+A);if(C&&C.attributes.mailbox=="INBOX"){C.parentNode.attributes.inbox_new=F}if(B&&B.dom){var E=B.dom.innerHTML;var D=E==""?0:parseInt(E.substring(1,E.length-1));if(D!=F){if(F>0){B.dom.innerHTML="("+F+")"}else{B.dom.innerHTML=""}return true}}return false},incrementFolderStatus:function(C,A){var D=Ext.get("status_"+C);var E=D.dom.innerHTML;var B=0;if(E!=""){var B=parseInt(E.substring(1,E.length-1))}B+=A;this.updateFolderStatus(C,B);this.updateNotificationEl()},checkMail:function(){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"check_mail"},callback:function(C,F,B){if(F){var E=Ext.decode(B.responseText);for(var A in E.status){var D=this.updateFolderStatus(A,E.status[A].unseen);if(D&&this.messagesGrid.store.baseParams.folder_id==A){this.messagesGrid.store.reload()}}this.updateNotificationEl();this.checkMail.defer(this.checkMailInterval,this)}},scope:this})},refresh:function(A){if(A){this.treePanel.loader.baseParams.refresh=true}this.treePanel.root.reload();this.messagesStore.removeAll();if(A){delete this.treePanel.loader.baseParams.refresh}},showAccountsDialog:function(){if(!this.accountsDialog){this.accountsDialog=new GO.email.AccountsDialog();this.accountsDialog.accountsGrid.accountDialog.on("save",function(B,A){if(A.refreshNeeded){this.refresh()}},this);this.accountsDialog.accountsGrid.on("delete",function(){this.refresh()},this);this.accountsDialog.accountsGrid.store.load()}this.accountsDialog.show()},doTaskOnMessages:function(A){var B=this.messagesGrid.selModel.selections.keys;if(B.length){Ext.Ajax.request({url:GO.settings.modules.email.url+"action.php",params:{task:"flag_messages",account_id:this.account_id,mailbox:this.mailbox,action:A,messages:Ext.encode(B)},callback:function(E,J,D){if(!J){Ext.MessageBox.alert(GO.lang.strError,GO.lang.strRequestError)}else{var I=Ext.decode(D.responseText);if(!I.success){Ext.MessageBox.alert(GO.lang.strError,I.feedback)}else{var H;var G;var C=this.messagesGrid.selModel.getSelections();switch(A){case"mark_as_read":H="new";G=false;this.justMarkedUnread=-C.length;break;case"mark_as_unread":H="new";G=true;this.justMarkedUnread=C.length;break;case"flag":H="flagged";G=true;break;case"unflag":H="flagged";G=false;break}for(var F=0;F<C.length;F++){C[F].set(H,G);C[F].commit()}this.updateFolderStatus(this.folder_id,I.unseen);this.updateNotificationEl()}}},scope:this})}},addSendersTo:function(F){var B=this.messagesGrid.getSelectionModel().getSelections();var H=[];for(var D=0;D<B.length;D++){H.push('"'+B[D].get("from")+'" <'+B[D].get("sender")+">")}var E=false;if(GO.email.composers){for(var D=GO.email.composers.length-1;D>=0;D--){if(GO.email.composers[D].isVisible()){E=GO.email.composers[D];break}}}if(E){var G=E.formPanel.form.findField(F.field);var A=G.getValue();if(A!=""){A+=", "}A+=H.join(", ");G.setValue(A);E.focus()}else{var C={values:{}};C.values[F.field]=H.join(", ");GO.email.showComposer(C)}}});GO.mainLayout.onReady(function(){GO.email.addressContextMenu=new GO.email.AddressContextMenu()});GO.email.aliasesStore=new GO.data.JsonStore({url:GO.settings.modules.email.url+"json.php",baseParams:{task:"all_aliases"},root:"results",id:"id",totalProperty:"total",fields:["id","account_id","name","email","html_signature","plain_signature"],remoteSort:true});GO.email.showComposer=function(A){A=A||{};GO.email.composers=GO.email.composers||[];var C;for(var B=0;B<GO.email.composers.length;B++){if(!GO.email.composers[B].isVisible()){C=GO.email.composers[B];break}}if(!C){A.move=30*GO.email.composers.length;C=new GO.email.EmailComposer();C.on("send",function(E){if(E.sendParams.reply_uid&&E.sendParams.reply_uid>0){var D=GO.email.messagesGrid.store.getById(E.sendParams.reply_uid);if(D){D.set("answered",true)}}if(GO.email.messagesGrid&&GO.email.messagesGrid.store.loaded&&(GO.email.messagesGrid.store.reader.jsonData.sent||(GO.email.messagesGrid.store.reader.jsonData.drafts&&E.sendParams.draft_uid&&E.sendParams.draft_uid>0))){GO.email.messagesGrid.store.reload()}});C.on("save",function(D){if(GO.email.messagesGrid&&GO.email.messagesGrid.store.loaded&&GO.email.messagesGrid.store.reader.jsonData.drafts){GO.email.messagesGrid.store.reload()}});GO.email.composers.push(C)}C.show(A);return C};GO.moduleManager.addModule("email",GO.email.EmailClient,{title:GO.lang.strEmail,iconCls:"go-tab-icon-email"});GO.email.showAddressMenu=function(C,B,A){var C=Ext.EventObject.setEvent(C);C.preventDefault();GO.email.addressContextMenu.showAt(C.getXY(),B,A)};GO.linkHandlers[9]=function(E,B){var C=new GO.email.MessagePanel({border:false,autoScroll:true});C.on("linkClicked",function(F){var G=window.open(F);G.focus()},this);C.on("attachmentClicked",function(G,F){if(G.mime.indexOf("message")>-1){B.part_number=G.number+".0";GO.linkHandlers[9].call(this,E,B)}else{if(F.data.path){document.location.href=GO.settings.modules.email.url+"mimepart.php?path="+encodeURIComponent(F.data.path)+"&part_number="+G.number}else{document.location.href=GO.settings.modules.email.url+"mimepart.php?uid="+B.uid+"&account_id="+B.account_id+"&transfer="+B.transfer+"&mailbox="+encodeURIComponent(B.mailbox)+"&part="+B.part+"&part_number="+G.number}}},this);C.on("zipOfAttachmentsClicked",function(){},this);var D=new Ext.Window({maximizable:true,collapsible:true,title:GO.email.lang.emailMessage,height:400,width:600,layout:"fit",items:C,tbar:[{iconCls:"btn-print",text:GO.lang.cmdPrint,cls:"x-btn-text-icon",handler:function(){C.body.print()}}],buttons:[{text:GO.lang.cmdClose,handler:function(){D.close()}}]});D.show();C.el.mask(GO.lang.strWaitMsgLoad);if(!B){B={}}B.id=E;var A="";if(B.account_id){B.task="message_attachment";A=GO.settings.modules.email.url+"json.php"}else{B.task="linked_message";A=GO.settings.modules.mailings.url+"json.php"}Ext.Ajax.request({url:A,params:B,scope:this,callback:function(G,I,F){var H=Ext.decode(F.responseText);C.setMessage(H);C.el.unmask()}})};GO.email.AddressContextMenu=function(A){if(!A){A={}}A.shadow="frame";A.minWidth=180;this.composeButton=new Ext.menu.Item({iconCls:"btn-compose",text:GO.email.lang.compose,cls:"x-btn-text-icon",handler:function(){GO.email.showComposer({values:{to:this.address}})},scope:this});this.searchButton=new Ext.menu.Item({iconCls:"btn-search",text:GO.email.lang.searchGO,cls:"x-btn-text-icon",handler:function(){var B=new GO.grid.SearchPanel({query:this.address});GO.mainLayout.tabPanel.add(B);B.show()},scope:this});this.searchMessagesButton=new Ext.menu.Item({iconCls:"btn-search",text:GO.email.lang.searchOnSender,cls:"x-btn-text-icon",handler:function(){GO.email.searchSender(this.address)},scope:this});A.items=[this.composeButton,this.searchButton,this.searchMessagesButton];if(GO.addressbook){this.lookUpButton=new Ext.menu.Item({iconCls:"btn-addressbook",text:GO.addressbook.lang.searchOnSender,cls:"x-btn-text-icon",handler:function(){GO.addressbook.searchSender(this.address,this.personal)},scope:this});A.items.push(this.lookUpButton)}GO.email.AddressContextMenu.superclass.constructor.call(this,A)};Ext.extend(GO.email.AddressContextMenu,Ext.menu.Menu,{personal:"",address:"",showAt:function(C,A,B){this.address=A;if(B){this.personal=B}GO.email.AddressContextMenu.superclass.showAt.call(this,C)}});GO.email.AttachmentContextMenu=function(A){if(!A){A={}}A.shadow="frame";A.minWidth=180;this.downloadButton=new Ext.menu.Item({iconCls:"btn-download",text:GO.lang.download,cls:"x-btn-text-icon",handler:function(){this.emailClient.openAttachment(this.attachment,this.emailClient.messagePanel,true)},scope:this});A.items=[this.downloadButton];if(GO.files){this.saveButton=new Ext.menu.Item({iconCls:"btn-save",text:GO.lang.cmdSave,cls:"x-btn-text-icon",handler:function(){this.emailClient.saveAttachment(this.attachment)},scope:this});A.items.push(this.saveButton)}GO.email.AttachmentContextMenu.superclass.constructor.call(this,A)};Ext.extend(GO.email.AttachmentContextMenu,Ext.menu.Menu,{attachment:false,showAt:function(A,B){this.attachment=B;GO.email.AttachmentContextMenu.superclass.showAt.call(this,A)}});GO.email.SettingsPanel=function(A){if(!A){A={}}A.autoScroll=true;A.border=false;A.hideLabel=true;A.title=GO.lang.strEmail;A.hideMode="offsets";A.layout="form";A.bodyStyle="padding:5px";A.items=[{xtype:"fieldset",title:GO.email.defaultProgram,autoHeight:true,html:GO.email.defaultProgramInstructions},this.useHtml=new Ext.form.Checkbox({boxLabel:GO.email.lang.htmlMarkup,hideLabel:true,checked:GO.email.useHtmlMarkup,name:"use_html_markup"})];GO.email.SettingsPanel.superclass.constructor.call(this,A)};Ext.extend(GO.email.SettingsPanel,Ext.Panel,{onLoadSettings:function(A){},onSaveSettings:function(){GO.email.useHtmlMarkup=this.useHtml.getValue()}});GO.mainLayout.onReady(function(){GO.moduleManager.addSettingsPanel("email",GO.email.SettingsPanel)});